<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#667eea" />
  <title>NURS 10L - G-Tube Feeding Evaluation</title>
  <script src="/N10L/socket.io/socket.io.js"></script>
  <style>
    :root {
      --bg: #f5f7fa;
      --card: #ffffff;
      --muted: #4a5568;
      --muted-2: #718096;
      --primary: #667eea;
      --primary-2: #5a67d8;
      --accent: #764ba2;
      --pass: #48bb78;
      --fail: #e53e3e;
      --ok: #38a169;
      --warn: #d69e2e;
      --border: #e2e8f0;
    }

    * { box-sizing: border-box; }
    /* Mobile-first readable base font size; scales slightly with viewport */
    html { font-size: clamp(18px, 5vw, 20px); }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: #2d3748;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: 10px;
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      touch-action: manipulation;
    }

    .container {
      max-width: 920px;
      margin: 0 auto;
      background: var(--card);
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 20px);
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      color: #fff;
      padding: 18px 20px 14px;
      text-align: center;
    }
  .header h1 { margin: 0 0 6px; font-size: clamp(1.4rem, 5.5vw, 1.85rem); font-weight: 700; }
  .header p { margin: 0; opacity: 0.95; font-size: 1rem; }

  .progress-bar { height: 10px; background: rgba(255,255,255,0.25); border-radius: 6px; overflow: hidden; margin-top: 12px; }
    .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #fff 0%, #d6d6ff 100%); transition: width .25s ease; }

    .toolbar {
      display: flex;
      gap: 10px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      background: #fafbff;
    }
    .btn {
      padding: 14px 16px;
      border: 0;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1.05rem;
      cursor: pointer;
      transition: background .2s ease, transform .05s ease;
      min-height: 48px;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-2); }
    .btn-secondary { background: #e2e8f0; color: var(--muted); }
    .btn-secondary:hover { background: #cbd5e0; }

    form { display: block; width: 100%; }

    .section {
      border-bottom: 1px solid var(--border);
    }
    .section:last-of-type { border-bottom: 0; }

    .section-header {
      width: 100%;
      text-align: left;
      padding: 14px 16px;
      background: #f7fafc;
      border: 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      gap: 10px;
      min-height: 48px;
    }
  .section-title { margin: 0; font-size: 1.2rem; font-weight: 700; color: #2d3748; }
  .section-meta { color: var(--muted-2); font-size: 1rem; margin-left: auto; margin-right: 10px; }
    .toggle-icon { font-size: 1.05rem; opacity: .8; }

    .section-content { padding: 16px; display: block; }
    .section.collapsed .section-content { display: none; }

    .student-info {
      padding: 16px;
      background: #f8f9ff;
      border-bottom: 1px solid var(--border);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .field label { display: block; font-weight: 600; color: var(--muted); margin-bottom: 6px; font-size: 1rem; }
    .field input, .field textarea {
      width: 100%; padding: 12px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 1.1rem; background: white; min-height: 48px;
    }
    .field input:focus, .field textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102,126,234,.15); }

    .scenario-summary { padding: 16px; background: #fff7db; border-left: 4px solid #f6c343; }
    .scenario-summary h3 { margin: 0 0 8px; color: #7a5d00; }
    .patient-info { background: #fff; padding: 12px; border: 1px solid #fde3a7; border-radius: 8px; }

    .checklist-item {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      padding: 12px;
      margin-bottom: 10px;
      background: #f8f9ff;
      border: 1px solid var(--border);
      border-radius: 10px;
    }
  .checkbox-container { display: flex; flex-direction: column; gap: 8px; min-width: 120px; }
  .checkbox-group { display: inline-flex; align-items: center; gap: 8px; }
  .checkbox { width: 26px; height: 26px; cursor: pointer; }
    .checkbox.pass { accent-color: var(--pass); }
    .checkbox.fail { accent-color: var(--fail); }
  .checkbox-label { font-size: 1rem; font-weight: 700; user-select: none; }
    .checkbox-label.pass { color: #2f855a; }
    .checkbox-label.fail { color: #c53030; }
  .item-text { flex: 1; font-size: 1.1rem; }
    .checklist-item.checked { background: #f2fff6; border-color: #bdebcf; }
    .checklist-item.failed  { background: #fff5f5; border-color: #f9b3b3; }

    .notes {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      padding: 0 16px 16px;
    }
  .notes textarea { min-height: 130px; resize: vertical; }

    .scorebar {
      margin-top: auto;
      position: sticky; bottom: 0; background: #fff; border-top: 1px solid var(--border);
      padding: 12px 16px calc(12px + env(safe-area-inset-bottom)); display: grid; grid-template-columns: repeat(3, auto) 1fr; gap: 12px; align-items: center;
    }
  .pill { padding: 8px 14px; border-radius: 999px; color: #fff; font-weight: 800; font-size: 1.1rem; }
    .pill.primary { background: var(--primary); }
    .pill.fail { background: var(--fail); }
    .pill.score { background: var(--fail); }

    /* Critical element indicator */
    .critical-badge {
      display: inline-block;
      background: #e53e3e;
      color: #fff;
      font-size: .55rem;
      padding: 3px 6px 2px;
      border-radius: 6px;
      margin-left: 8px;
      letter-spacing: .5px;
      font-weight: 700;
      box-shadow: 0 0 0 1px rgba(229,62,62,0.4), 0 2px 4px rgba(229,62,62,0.35);
      position: relative;
      top: -1px;
      white-space: nowrap;
    }
    .checklist-item.failed .critical-badge { background:#9b2c2c; }

  /* Guided correction highlight */
  .incomplete-focus { position: relative; box-shadow: 0 0 0 3px #f59e0b, 0 0 0 6px rgba(245,158,11,0.35); animation: pulseRing 1.2s ease-in-out infinite; }
  @keyframes pulseRing { 0% { box-shadow: 0 0 0 3px #f59e0b, 0 0 0 6px rgba(245,158,11,0.35);} 50% { box-shadow: 0 0 0 3px #f59e0b, 0 0 0 10px rgba(245,158,11,0.08);} 100% { box-shadow: 0 0 0 3px #f59e0b, 0 0 0 6px rgba(245,158,11,0.35);} }
  .guided-toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 18px; width: min(680px, 92%); background: #1a1f29; color:#fff; padding: 18px 20px 16px; border-radius: 16px; box-shadow: 0 14px 42px -8px rgba(0,0,0,0.45), 0 4px 18px rgba(0,0,0,0.4); z-index: 1100; font-size: .95rem; display:flex; flex-direction:column; gap:14px; }
  .guided-toast h4 { margin:0; font-size:1.05rem; font-weight:700; }
  .guided-progress { font-size:.8rem; letter-spacing:.5px; opacity:.85; }
  .guided-item-text { background:#222b38; padding:12px 14px; border-radius:10px; max-height:110px; overflow:auto; line-height:1.3; font-size:.95rem; }
  .guided-actions { display:flex; flex-wrap:wrap; gap:10px; }
  .guided-btn { flex:1 1 auto; padding:12px 14px; border:none; border-radius:10px; font-weight:600; cursor:pointer; font-size:.9rem; display:flex; align-items:center; justify-content:center; gap:6px; }
  .guided-btn.pass { background:#16a34a; color:#fff; }
  .guided-btn.pass:hover { background:#15803d; }
  .guided-btn.fail { background:#dc2626; color:#fff; }
  .guided-btn.fail:hover { background:#b91c1c; }
  .guided-btn.next { background:#334155; color:#e2e8f0; }
  .guided-btn.next:hover { background:#1e293b; }
  .guided-btn.submit { background: linear-gradient(90deg,#6366f1,#8b5cf6); color:#fff; }
  .guided-btn.submit[disabled] { background:#475569; cursor:not-allowed; opacity:.6; }
  .guided-close { position:absolute; top:8px; right:10px; background:none; border:none; color:#94a3b8; font-size:18px; cursor:pointer; }
  .guided-close:hover { color:#fff; }

    /* Small-screen optimizations (iPhone 12 ~390px width) */
    @media (max-width: 480px) {
      body { padding: 8px; }
      .container { border-radius: 12px; }
      .toolbar { gap: 8px; padding: 10px 12px; }
      .btn { flex: 1 1 auto; min-width: 44%; font-size: 1.1rem; min-height: 50px; }
      .section-header { min-height: 52px; }
      .section-title { font-size: 1.25rem; }
      .section-meta { font-size: 1.05rem; }
      .section-content { padding: 14px; }
      .checklist-item { flex-direction: column; gap: 10px; }
      .checkbox-container { flex-direction: row; align-items: center; min-width: auto; }
      .checkbox-group { gap: 10px; }
      .checkbox { width: 28px; height: 28px; }
      .checkbox-label { font-size: 1.05rem; }
      .item-text { font-size: 1.15rem; }
      .notes textarea { min-height: 150px; }
      /* Compact responsive score bar */
      .scorebar { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 6px 10px; 
        padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      }
      .scorebar > div { 
        flex: 1 1 48%; 
        display: flex; 
        align-items: center; 
        gap: 4px;
        font-size: .85rem;
      }
      .scorebar > div:last-child { flex: 1 1 100%; order: 4; text-align: left !important; font-size: .7rem; }
      .pill { 
        font-size: .85rem; 
        padding: 6px 10px; 
        font-weight: 700;
        line-height: 1.1;
        min-width: 0;
      }
      .header h1 { font-size: 1.35rem; }
      html { font-size: clamp(16px, 4.8vw, 18px); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>NURS 10L - G-Tube Feeding Evaluation</h1>
      <p>Week 4 Peer Assessment - Shannon Shaw Case Study</p>
      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
    </div>

    <div class="toolbar">
      <button type="button" class="btn btn-secondary" id="expandAll">Expand all</button>
      <button type="button" class="btn btn-secondary" id="collapseAll">Collapse all</button>
      <button type="button" class="btn btn-secondary" id="resetForm">Reset form</button>
      <button type="button" class="btn btn-secondary" id="recallEvaluationBtn" style="display: none;">Recall Last Submission</button>
      <button type="button" class="btn btn-secondary" id="switchStudent">Switch / Logout</button>
      <button type="button" class="btn btn-primary" id="downloadReport">Generate report</button>
      <button type="button" class="btn btn-success" id="submitEvaluation" style="background: var(--ok); margin-left: 10px;">Submit Evaluation</button>
    </div>

    <form id="evaluationForm">
      <div class="student-info">
        <div class="field">
          <label for="studentName">Student Being Evaluated 🔒</label>
          <input id="studentName" name="studentName" type="text" required readonly style="background-color: #f8f9fa; color: #495057; border: 2px solid #28a745; font-weight: bold;" />
          <small style="color: #28a745; font-size: 0.8em; margin-top: 4px; display: block;">✓ Locked to logged-in user</small>
        </div>
        <div class="field">
          <label for="evaluatorName">Evaluator Name</label>
          <input id="evaluatorName" name="evaluatorName" type="text" required />
        </div>
        <div class="field">
          <label for="evaluationDate">Date</label>
          <input id="evaluationDate" name="evaluationDate" type="date" required />
        </div>
        <div class="field">
          <label for="scenarioTime">Scenario Time</label>
          <input id="scenarioTime" name="scenarioTime" type="text" value="0700 - 1500 (7am - 3pm Shift)" />
        </div>
      </div>

      <div class="scenario-summary">
        <h3>Patient Case Summary</h3>
        <div class="patient-info">
          <strong>Patient:</strong> Shannon Shaw, 74 years old<br />
          <strong>Diagnosis:</strong> Malnutrition, Dysphagia, Dementia<br />
          <strong>History:</strong> Right total hip replacement 6 months ago, significant weight loss, G-tube placement<br />
          <strong>Status:</strong> Frail, pale, lethargic, PEG tube infusing Jevity Plus @ 75 mL/hr<br />
          <strong>Vitals:</strong> HT: 5'3", Wt: 97 lbs, BMI < 18<br />
          <strong>Risk Factors:</strong> High aspiration risk, dry eye condition<br />
          <strong>Current Labs:</strong> K=4.0, Na=130, Mg=2.8, Phosphorus=3.0, Cl=105, Albumin=2.5, Residual=20ml
        </div>
      </div>

      <!-- SBAR Handoff & G-Tube Assessment Section -->
      <div class="section" id="sec-sbar">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">SBAR Communication</span>
          <span class="section-meta" data-count="sec-sbar"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <h4 style="margin:0 0 6px; color: var(--muted);">S = SITUATION</h4>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sbar_admission_report" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sbar_admission_report" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Admission Report: Shannon Shaw is a 74-year old female client admitted with significant weight loss, secondary to a right total hip replacement following a hip fracture 6 months ago<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sbar_gtube_dysphagia" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sbar_gtube_dysphagia" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">States: Unable to consume enough calories to maintain weight, G-tube placed, dysphagia with high aspiration risk<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sbar_dry_eye" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sbar_dry_eye" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">States: Suffering from "dry eye" with lubricating eye drops ordered twice a day</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sbar_diagnosis" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sbar_diagnosis" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Dx: Malnutrition, Dysphagia, Dementia</div>
          </div>

          <h4 style="margin:20px 0 6px; color: var(--muted);">B = BACKGROUND</h4>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sbar_pmh" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sbar_pmh" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">PMH: CVA, aspiration pneumonia and confusion</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sbar_nka" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sbar_nka" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">NKA (No Known Allergies)</div>
          </div>

          <h4 style="margin:20px 0 6px; color: var(--muted);">A = ASSESSMENT</h4>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sbar_clinical_signs" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sbar_clinical_signs" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Visible clinical signs: Frail, pale, lethargic, PEG tube infusing Jevity Plus @ 75 mL/hr<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sbar_vitals" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sbar_vitals" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">HT: 5'3", Wt: 97 #, BMI < 18</div>
          </div>

          <h4 style="margin:20px 0 6px; color: var(--muted);">R = RECOMMENDATIONS</h4>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sbar_recommendations" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sbar_recommendations" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">States appropriate recommendations, review, requests for G-tube care and monitoring</div>
          </div>
        </div>
      </div>

      <!-- Standard Protocol - Beginning -->
      <div class="section" id="sec-begin">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Standard Protocol - Beginning</span>
          <span class="section-meta" data-count="sec-begin"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="verify_orders" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="verify_orders" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Verifies physician's orders (must review orders on chart at bedside)<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="gather_equipment" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="gather_equipment" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Gathers own equipment/supplies</div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="hand_hygiene_main" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="hand_hygiene_main" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Performs hand hygiene – Gel in gel out<span class="critical-badge">CRITICAL</span></div>
          </div>
        </div>
      </div>

      <!-- 6 Rights and 3 Checks of Medication Administration -->
      <div class="section" id="sec-med-rights">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">6 Rights and 3 Checks of Medication Administration</span>
          <span class="section-meta" data-count="sec-med-rights"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="right_patient" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="right_patient" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Right Patient (verifies patient identification)<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="right_drug" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="right_drug" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Right Drug (verifies medication name and formula)<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="right_dose" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="right_dose" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Right Dose (confirms correct dosage amount)<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="right_route" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="right_route" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Right Route (G-tube administration)<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="right_time" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="right_time" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Right Time (verifies scheduled administration time)<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="right_documentation" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="right_documentation" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Right Documentation (accurate recording of administration)<span class="critical-badge">CRITICAL</span></div>
          </div>

          <!-- Three Checks -->
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="check_1_retrieval" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="check_1_retrieval" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">1st Check: When retrieving medication from storage<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="check_2_preparation" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="check_2_preparation" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">2nd Check: When preparing/calculating dosage<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="check_3_administration" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="check_3_administration" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">3rd Check: Before administering to patient<span class="critical-badge">CRITICAL</span></div>
          </div>
        </div>
      </div>

      <div class="section" id="sec-during">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Standard Protocol - During</span>
          <span class="section-meta" data-count="sec-during"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="identify_client" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="identify_client" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Identifies client (check ID bracelet and ask name/DOB)<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="introduce_self" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="introduce_self" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Introduces self and explains plan</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="identify_teaching" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="identify_teaching" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Identifies teaching needed; describes what client can expect</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="assess_appropriateness" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="assess_appropriateness" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Assesses if intervention is still appropriate</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="adjust_bed" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="adjust_bed" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Adjusts bed height; lowers nearest side rail</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="lighting" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="lighting" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Provides adequate lighting</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="privacy" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="privacy" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Provides privacy (pull curtain)</div>
          </div>
        </div>
      </div>

      <div class="section" id="sec-reglan">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">GT Reglan Administration</span>
          <span class="section-meta" data-count="sec-reglan"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="verify_reglan_order" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="verify_reglan_order" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Verifies Reglan order: 10mg via G-tube every 6 hours before meals<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="check_gtube_placement" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="check_gtube_placement" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Checks G-tube placement and patency<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="prepare_reglan" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="prepare_reglan" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Prepares Reglan using aseptic technique<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="flush_before_reglan" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="flush_before_reglan" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Flushes G-tube with 30ml water before medication<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="administer_reglan_slowly" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="administer_reglan_slowly" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Administers Reglan slowly (over 1-2 minutes)<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="flush_after_reglan" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="flush_after_reglan" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Flushes G-tube with 30ml water after medication<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="document_reglan_admin" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="document_reglan_admin" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Documents Reglan administration in MAR<span class="critical-badge">CRITICAL</span></div>
          </div>
        </div>
      </div>

      <!-- Artificial Tears Eye Drops Administration -->
      <div class="section" id="sec-eye-drops">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Artificial Tears Eye Drops Administration</span>
          <span class="section-meta" data-count="sec-eye-drops"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="verify_eye_drops_order" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="verify_eye_drops_order" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Verifies artificial tears order: 2 drops each eye every 4 hours<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="hand_hygiene_eye_drops" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="hand_hygiene_eye_drops" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Performs hand hygiene before procedure<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="position_eye_drops" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="position_eye_drops" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Positions patient with head tilted back or lying supine</div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="pull_lower_eyelid" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="pull_lower_eyelid" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Gently pulls down lower eyelid to create pocket</div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="instill_drops" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="instill_drops" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Instills 2 drops into lower conjunctival sac (avoids touching eye)<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="document_eye_drops" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="document_eye_drops" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Documents eye drop administration in MAR<span class="critical-badge">CRITICAL</span></div>
          </div>
        </div>
      </div>

      <!-- Jevity Plus Feeding Administration -->
      <div class="section" id="sec-jevity-feeding">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Jevity Plus Feeding Administration</span>
          <span class="section-meta" data-count="sec-jevity-feeding"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="verify_feeding_order" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="verify_feeding_order" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Verifies Jevity Plus feeding order and rate<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="check_feeding_placement" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="check_feeding_placement" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Checks G-tube placement before feeding<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="check_residual" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="check_residual" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Checks gastric residual volume<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="position_feeding" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="position_feeding" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Positions patient with HOB elevated 30-45 degrees<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="prime_feeding_tube" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="prime_feeding_tube" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Primes feeding tube to remove air</div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="connect_feeding" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="connect_feeding" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Connects feeding formula to G-tube using aseptic technique<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="monitor_feeding_rate" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="monitor_feeding_rate" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Monitors and maintains prescribed feeding rate<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="monitor_tolerance" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="monitor_tolerance" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Monitors patient tolerance (nausea, vomiting, distension)</div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="document_feeding" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="document_feeding" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Documents feeding administration and patient response<span class="critical-badge">CRITICAL</span></div>
          </div>
        </div>
      </div>

      <div class="section" id="sec-ending">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Standard Protocol - Ending</span>
          <span class="section-meta" data-count="sec-ending"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="comfort_position" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="comfort_position" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Assists client to position of comfort; organizes personal items within reach</div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="call_light" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="call_light" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Ensures call light is within reach and client knows how to use it</div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="bed_position" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="bed_position" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Raises side rails and lowers bed to lowest position</div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="dispose_supplies" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="dispose_supplies" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Disposes of used supplies and equipment properly</div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="final_hand_hygiene" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="final_hand_hygiene" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Performs hand hygiene - Gel in gel out<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="stand_pivot" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="stand_pivot" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Assists to stand and pivot into chair safely; proper body mechanics</div></div>

          <h4 style="margin:10px 0 6px; color: var(--muted);">Transfers back to bed</h4>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="return_sling" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="return_sling" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Uses sling</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="return_gait_belt" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="return_gait_belt" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Uses gait belt</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="return_safe" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="return_safe" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Assists client to stand and return to bed safely</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="return_body_mech" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="return_body_mech" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Uses good body mechanics</div></div>

          <h4 style="margin:10px 0 6px; color: var(--muted);">Pulls client up in bed (student leads)</h4>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="explain_procedure" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="explain_procedure" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Discusses procedure with client</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="raise_bed" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="raise_bed" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Raises bed to correct height for lifting pair</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="lower_hob_flat2" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="lower_hob_flat2" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Lowers HOB flat</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="lower_side_rails" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="lower_side_rails" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Lowers side rails</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="position_bent_knee" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="position_bent_knee" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Instructs client how to position self (bent left (good) knee to help push)</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="move_pillow" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="move_pillow" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Move pillow toward headboard</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="cross_arms" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="cross_arms" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Instructs client to cross arms</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="lift_head" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="lift_head" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Instructs client to lift head</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="tuck_chin" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="tuck_chin" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Instructs client to tuck chin</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="ask_assist" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="ask_assist" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Asks tester to assist in pulling client up in bed</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="lift_sheet_three_count" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="lift_sheet_three_count" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Pull client up in bed (two people) with lift sheet (three count)</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="good_mechanics_pull" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="good_mechanics_pull" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Uses correct body mechanics (bend knees, no twisting)</div></div>
        </div>
      </div>

      <div class="section" id="sec-ending">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Standard Protocol - Ending</span>
          <span class="section-meta" data-count="sec-ending"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="comfort_position" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="comfort_position" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Assists client to position of comfort; organizes personal items within reach</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="call_light" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="call_light" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Client has call light and knows how to use it</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="rails_bed_low" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="rails_bed_low" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Raise side rails and lower bed to lowest position<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="dispose_supplies" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="dispose_supplies" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Dispose of used supplies and equipment properly</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="remove_gloves_end" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="remove_gloves_end" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Remove and dispose of gloves (if appropriate)</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="final_hh_end" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="final_hh_end" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Performs final hand hygiene<span class="critical-badge">CRITICAL</span></div>
          </div>
        </div>
      </div>

      <div class="section" id="sec-assessments">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Head-to-Toe Physical Assessment</span>
          <span class="section-meta" data-count="sec-assessments"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <h4 style="margin:0 0 6px; color: var(--muted);">General Appearance</h4>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="nutrition_state" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="nutrition_state" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">State of Nutrition: Well-nourished; weight proportionate for height and age; no visible signs of malnutrition</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="comfort_level" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="comfort_level" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Comfort Level: Appears comfortable; no signs of pain or distress</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="facial_body_structure" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="facial_body_structure" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Facial Features / Body Structure: Symmetrical features; posture erect or appropriate to position (bed, chair, or standing)</div></div>

          <h4 style="margin:20px 0 6px; color: var(--muted);">Neurological System</h4>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="orientation_level" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="orientation_level" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Level of Orientation: Alert and oriented ×3 (person, place, time)</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="memory_function" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="memory_function" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Memory: Short- and long-term memory intact</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="motor_function" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="motor_function" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Motor Function: Purposeful, coordinated movements; strength equal bilaterally</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="pupils_perrla" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="pupils_perrla" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Pupils: PERRLA (pupils equal, round, reactive to light and accommodation); brisk reaction</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="ocular_movements" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="ocular_movements" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Ocular Movements: Extraocular movements intact; no nystagmus</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="glasgow_coma" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="glasgow_coma" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Glasgow Coma Scale: 15/15</div></div>

          <h4 style="margin:20px 0 6px; color: var(--muted);">Psychological</h4>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="facial_expression" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="facial_expression" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Facial Expression: Relaxed; maintains eye contact; affect congruent with mood</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="mood_affect" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="mood_affect" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Mood / Affect: Calm, cooperative; appropriate to situation</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="speech_clarity" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="speech_clarity" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Speech: Clear, articulate; normal pace, rhythm, and tone</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="interaction_level" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="interaction_level" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Interaction: Engaged, developmentally appropriate responses</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="personal_hygiene" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="personal_hygiene" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Personal Hygiene: Clean, well-groomed; clothing appropriate for setting</div></div>

          <h4 style="margin:20px 0 6px; color: var(--muted);">Head, Face, Mouth / Mucous Membranes</h4>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="head_assessment" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="head_assessment" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Head: Normocephalic, atraumatic, symmetrical; no masses or tenderness</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="hair_scalp" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="hair_scalp" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Hair: Even distribution; soft texture; appropriate thickness; scalp clean without lesions</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="face_symmetry" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="face_symmetry" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Face: Symmetrical at rest and with movement; no drooping or abnormal movements</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="teeth_oral" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="teeth_oral" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Teeth: Intact, no caries, plaque, or discoloration; dentures/bridges well-fitting if present. Breath odor neutral</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="mucous_membranes" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="mucous_membranes" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Mucous membranes/gums: Moist, pink, intact; no swelling, ulcerations, or bleeding</div></div>

          <h4 style="margin:20px 0 6px; color: var(--muted);">Skin, Hair, Nails</h4>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="skin_tone" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="skin_tone" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Skin tone/variations: Even pigmentation appropriate for ethnicity; no jaundice, cyanosis, or abnormal discolorations</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="temp_character" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="temp_character" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Temperature/character: Warm, dry, equal bilaterally</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="skin_texture" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="skin_texture" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Texture: Smooth, soft, resilient</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="skin_thickness" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="skin_thickness" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Thickness: Uniform; thicker only on palms and soles</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="skin_turgor" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="skin_turgor" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Turgor: Good elasticity; returns promptly; no tenting</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="vascularity" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="vascularity" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Vascularity: No bruising, petechiae, or abnormal markings. Tattoos noted if present</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="edema_assessment" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="edema_assessment" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Edema: None</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="lesions_moles" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="lesions_moles" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Lesions/Moles/Scars: No suspicious lesions; benign nevi only; scars well-healed</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="pressure_signs" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="pressure_signs" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Pressure Signs: Skin intact; no erythema or breakdown</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="nails_assessment" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="nails_assessment" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Nails: Smooth, firm, pink nail beds; cap refill <2 seconds; contour ≤160°; no clubbing</div></div>

          <h4 style="margin:20px 0 6px; color: var(--muted);">Cardiovascular System</h4>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="heart_rate_rhythm" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="heart_rate_rhythm" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Rate & Rhythm: Heart rate within normal limits (60–100 bpm for adults); regular rhythm; no skipped beats</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="heart_sounds" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="heart_sounds" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Heart Sounds: Distinct S1 and S2; no murmurs, rubs, or extra sounds (S3, S4)</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="peripheral_pulses" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="peripheral_pulses" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Peripheral Pulses: Palpable and equal bilaterally (radial, brachial, dorsalis pedis, posterior tibial, etc.); strength 2+</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="capillary_refill" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="capillary_refill" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Capillary Refill: Brisk, <2 seconds in fingers and toes</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="cardiac_edema" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="cardiac_edema" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Edema: None present</div></div>

          <h4 style="margin:20px 0 6px; color: var(--muted);">Abdomen</h4>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="abdomen_contour" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="abdomen_contour" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Contour: Flat or rounded; no distention</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="abdomen_symmetry" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="abdomen_symmetry" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Shape/Symmetry: Symmetrical; no bulges, hernias, or visible masses</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="bowel_sounds" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="bowel_sounds" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Auscultation: Normoactive bowel sounds in all four quadrants; no bruits</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="abdomen_percussion" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="abdomen_percussion" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Percussion: Tympany predominant; no abnormal dullness except over liver or bladder</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="abdomen_palpation" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="abdomen_palpation" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Palpation: Soft, non-tender; no organomegaly or palpable masses</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="bowel_movement" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="bowel_movement" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Last Bowel Movement: Within normal limits; formed, brown, appropriate size/consistency</div></div>

          <h4 style="margin:20px 0 6px; color: var(--muted);">Urinary / Genitalia</h4>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="genitalia_inspection" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="genitalia_inspection" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Inspection: External genitalia pink, moist, intact; no inflammation, lesions, or scars</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="genitalia_irritation" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="genitalia_irritation" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Irritation: No itching, discharge, pain, or tenderness</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="urination_function" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="urination_function" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Urination: Continent; voiding without difficulty; urine clear and yellow; no urgency, frequency, or dysuria. If catheter present, insertion site clean and intact; urine output appropriate</div></div>

          <h4 style="margin:20px 0 6px; color: var(--muted);">Musculoskeletal System</h4>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="musculo_inspection" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="musculo_inspection" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Inspection: Joints and muscles symmetrical; no redness, warmth, swelling, or deformities</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="range_of_motion" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="range_of_motion" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Range of Motion (ROM): Full, smooth movement in all extremities; no limitations or contractures</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="muscle_strength" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="muscle_strength" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Muscle Strength: 5/5 throughout; equal bilaterally</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="gait_assessment" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="gait_assessment" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Gait: Steady, balanced; base shoulder-width apart; symmetric arm swing; no staggering or shuffling</div></div>
        </div>
      </div>

      <div class="section" id="sec-notes">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Evaluation Notes</span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="notes">
            <div class="field"><label for="sbar_notes">SBAR Communication</label><textarea id="sbar_notes" placeholder="Document SBAR communication effectiveness..."></textarea></div>
            <div class="field"><label for="collaboration_notes">Collaboration</label><textarea id="collaboration_notes" placeholder="Note teamwork and collaboration skills..."></textarea></div>
            <div class="field"><label for="critical_thinking_notes">Critical Thinking</label><textarea id="critical_thinking_notes" placeholder="Observe critical thinking and clinical reasoning..."></textarea></div>
            <div class="field"><label for="clinical_judgment_notes">Clinical Judgment</label><textarea id="clinical_judgment_notes" placeholder="Evaluate clinical judgment and decision making..."></textarea></div>
            <div class="field"><label for="additional_notes">Additional Notes</label><textarea id="additional_notes" placeholder="Any other observations or feedback..."></textarea></div>
          </div>
        </div>
      </div>
    </form>

    <div class="scorebar">
      <div><strong>Completed:</strong> <span id="completedScore" class="pill primary">0 / 0</span></div>
      <div><strong>Failed:</strong> <span id="failedScore" class="pill fail">0</span></div>
      <div><strong>Critical Fails:</strong> <span id="criticalFailedScore" class="pill fail">0</span></div>
      <div><strong>Score:</strong> <span id="overallScore" class="pill score">0%</span></div>
      <div style="text-align:right; color: var(--muted-2); font-size: .9rem;">Progress auto-saves locally</div>
    </div>
  </div>

    <!-- Guided correction toast mount point -->
    <div id="guidedToastRoot" aria-live="assertive" style="z-index:1100;"></div>

  <!-- Login Modal -->
  <div id="loginModal" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  ">
    <div style="
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
    ">
      <h2 style="text-align: center; color: var(--primary); margin-bottom: 20px;">
        🏥 Student Sign-In
      </h2>
      <p style="text-align: center; color: var(--muted); margin-bottom: 25px;">
        Enter your full name and use the default password to access the evaluation
      </p>
      <form id="loginForm">
        <div style="margin-bottom: 20px;">
          <label for="loginStudentName" style="display: block; margin-bottom: 8px; font-weight: 600;">Student Name:</label>
          <input type="text" id="loginStudentName" required style="
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
          " placeholder="Enter your full name">
        </div>
        <div style="margin-bottom: 20px;">
          <label for="loginPassword" style="display: block; margin-bottom: 8px; font-weight: 600;">Password:</label>
          <input type="password" id="loginPassword" required placeholder="Enter institutional password" style="
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
          ">
          <small style="color: var(--muted); font-size: 12px; margin-top: 5px; display: block;">
            🔒 Use your institutional password
          </small>
        </div>
        <button type="submit" style="
          width: 100%;
          padding: 12px;
          background: var(--primary);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: background-color 0.3s;
        ">Start Evaluation</button>
      </form>
      <div id="loginError" style="
        color: var(--fail);
        text-align: center;
        margin-top: 15px;
        display: none;
        font-size: 14px;
      "></div>
    </div>
  </div>

  <!-- Connection Status -->
  <div id="connectionStatus" style="
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    z-index: 999;
    display: none;
  "></div>

  <script>
    // Subpath support when served behind Traefik at /N10L
    const BASE_PATH = location.pathname.toLowerCase().startsWith('/n10lvoice/') ? '/N10LVoice' : '';
    const API_BASE = `${BASE_PATH}/api`;
    const SOCKET_PATH = `${BASE_PATH}/socket.io`;

    const defaultScenarioField = document.getElementById('scenarioTime');
    const defaultEvaluationDateField = document.getElementById('evaluationDate');
    const DEFAULT_SCENARIO_TIME = defaultScenarioField ? defaultScenarioField.value : '0700 - 1500 (7am - 3pm Shift)';
    const DEFAULT_EVALUATION_DATE = defaultEvaluationDateField ? defaultEvaluationDateField.value : new Date().toISOString().split('T')[0];

    const LAST_EVALUATION_PREFIX = 'gtubeWeek4LastEvaluation_';

    function getLastEvaluationStorageKey() {
      if (!studentName) return null;
      return `${LAST_EVALUATION_PREFIX}${studentName}`;
    }

    function saveLastEvaluationSnapshot(snapshot) {
      try {
        const key = getLastEvaluationStorageKey();
        if (!key) return;
        localStorage.setItem(key, JSON.stringify(snapshot));
      } catch (error) {
        console.error('Failed to save last evaluation snapshot:', error);
      }
    }

    function loadLastEvaluationSnapshot() {
      try {
        const key = getLastEvaluationStorageKey();
        if (!key) return null;
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (error) {
        console.warn('Failed to load last evaluation snapshot:', error);
        return null;
      }
    }

    function updateRecallButtonVisibility() {
      const btn = document.getElementById('recallEvaluationBtn');
      if (!btn) return;
      const key = getLastEvaluationStorageKey();
      const hasSnapshot = key && localStorage.getItem(key);
      btn.style.display = hasSnapshot ? 'inline-flex' : 'none';
      btn.disabled = !hasSnapshot;
      if (hasSnapshot) {
        btn.setAttribute('aria-label', 'Recall your most recent submission for review');
      }
    }

    // Utilities
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const $  = (sel, root=document) => root.querySelector(sel);

    // Real-time Socket.IO functionality
    let socket = null;
    let sessionId = localStorage.getItem('studentSession');
    let studentName = localStorage.getItem('studentName');
    let evaluationStartTime = null;
    let reconnectAttempts = 0;
    let maxReconnectAttempts = 5;
    let reconnectInterval = null;
    let isManualDisconnect = false;

    // Check if student is already logged in with valid session
    // Auto-save form state during disconnections
    function saveFormState() {
      const formData = {
        evaluatorName: document.getElementById('evaluatorName')?.value || '',
        scenarioTime: document.getElementById('scenarioTime')?.value || '',
        additionalNotes: document.getElementById('additional_notes')?.value || '',
        checkboxStates: {},
        timestamp: Date.now()
      };
      
      // Save all checkbox states
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        if (checkbox.id) {
          formData.checkboxStates[checkbox.id] = checkbox.checked;
        }
      });
      
      localStorage.setItem('evaluationFormState', JSON.stringify(formData));
    }

    function restoreFormState() {
      const savedState = localStorage.getItem('evaluationFormState');
      if (!savedState) return;
      
      try {
        const formData = JSON.parse(savedState);
        
        // Only restore if saved within last hour
        if (Date.now() - formData.timestamp > 60 * 60 * 1000) {
          localStorage.removeItem('evaluationFormState');
          return;
        }
        
        // Restore form fields
        if (formData.evaluatorName) {
          const field = document.getElementById('evaluatorName');
          if (field) field.value = formData.evaluatorName;
        }
        
        if (formData.scenarioTime) {
          const field = document.getElementById('scenarioTime');
          if (field) field.value = formData.scenarioTime;
        }
        
        if (formData.additionalNotes) {
          const field = document.getElementById('additionalNotes');
          if (field) field.value = formData.additionalNotes;
        }
        
        // Restore checkbox states
        Object.entries(formData.checkboxStates).forEach(([id, checked]) => {
          const checkbox = document.getElementById(id);
          if (checkbox) {
            checkbox.checked = checked;
          }
        });
        
        updateCounts();
        showSuccess('📋 Previous form data restored from auto-save');
        
      } catch (error) {
        console.error('Error restoring form state:', error);
        localStorage.removeItem('evaluationFormState');
      }
    }

    async function checkExistingSession() {
      if (sessionId && studentName) {
        try {
          const response = await fetch(`${API_BASE}/auth/validate-session`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId })
          });
          
          if (response.ok) {
            connectSocket();
            // Restore any saved form state after connecting
            setTimeout(restoreFormState, 1000);
            updateRecallButtonVisibility();
            return;
          }
        } catch (error) {
          console.log('Session validation failed:', error);
        }
        
        // Clear invalid session
        localStorage.removeItem('studentSession');
        localStorage.removeItem('studentName');
        sessionId = null;
        studentName = null;
        updateRecallButtonVisibility();
      }
      
      showLoginModal();
    }

    checkExistingSession();

    function showLoginModal() {
      document.getElementById('loginModal').style.display = 'flex';
    }

    function hideLoginModal() {
      document.getElementById('loginModal').style.display = 'none';
    }

    function updateConnectionStatus(status, attempts = 0) {
      const statusEl = document.getElementById('connectionStatus');
      statusEl.style.display = 'block';
      statusEl.style.color = 'white';
      
      switch (status) {
        case 'connected':
          statusEl.style.background = 'var(--pass)';
          statusEl.textContent = '🟢 Connected';
          break;
        case 'disconnected':
          statusEl.style.background = 'var(--fail)';
          statusEl.textContent = '� Disconnected';
          break;
        case 'reconnecting':
          statusEl.style.background = 'var(--warn)';
          statusEl.textContent = `🟡 Reconnecting... (${attempts}/${maxReconnectAttempts})`;
          break;
        case 'failed':
          statusEl.style.background = 'var(--fail)';
          statusEl.textContent = '🔴 Connection Failed - Click to Retry';
          statusEl.style.cursor = 'pointer';
          statusEl.onclick = () => attemptReconnection();
          break;
        default:
          statusEl.style.background = 'var(--muted)';
          statusEl.textContent = '⚪ Unknown Status';
      }
    }

    async function registerStudent(name) {
      const response = await fetch(`${API_BASE}/auth/register`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: name, password: 'student123', role: 'student' })
      });
      const data = await response.json();
      if (response.ok) return data.token;
      if (response.status === 409) return await loginStudent(name);
      throw new Error(data.error || 'Registration failed');
    }

    async function loginStudent(name) {
      const response = await fetch(`${API_BASE}/auth/login`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: name, password: 'student123' })
      });
      const data = await response.json();
      if (response.ok) return data.token;
      throw new Error(data.error || 'Login failed');
    }

    function connectSocket() {
      if (!studentName || !sessionId) return;
      
      // Configure Socket.IO with reconnection settings
      socket = io({ 
        path: SOCKET_PATH, 
        auth: { sessionId: sessionId },
        reconnection: true,
        reconnectionAttempts: maxReconnectAttempts,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000,
        timeout: 10000
      });

      socket.on('connect', () => {
        console.log('Connected to evaluation server');
        updateConnectionStatus('connected');
        reconnectAttempts = 0;
        clearInterval(reconnectInterval);
        
        // Save evaluation start time only on first connect
        if (!evaluationStartTime) {
          evaluationStartTime = new Date().toISOString();
        }
        
        // Pre-fill and lock student name in form
        const studentNameField = document.getElementById('studentName');
        if (studentNameField) {
          studentNameField.value = studentName;
          studentNameField.readonly = true;
          studentNameField.style.backgroundColor = '#f8f9fa';
          studentNameField.style.color = '#495057';
          studentNameField.style.border = '2px solid #28a745';
          studentNameField.style.fontWeight = 'bold';
          studentNameField.title = '🔒 Locked to logged-in user: ' + studentName;
        }
        
        // Show success message if this was a reconnection
        if (reconnectAttempts > 0) {
          showSuccess('✅ Reconnected successfully! Your progress is preserved.');
        }
      });

      socket.on('disconnect', (reason) => {
        console.log('Disconnected from server:', reason);
        updateConnectionStatus('disconnected');
        
        // Only attempt reconnection if it wasn't a manual disconnect
        if (!isManualDisconnect && reason !== 'io client disconnect') {
          startReconnectionProcess();
        }
      });

      socket.on('reconnect_attempt', (attemptNumber) => {
        console.log(`Reconnection attempt ${attemptNumber}`);
        updateConnectionStatus('reconnecting', attemptNumber);
      });

      socket.on('reconnect_failed', () => {
        console.log('All reconnection attempts failed');
        updateConnectionStatus('failed');
        showError('❌ Connection lost. Click the status indicator to retry.');
      });

      socket.on('connect_error', (error) => {
        console.error('Connection error:', error);
        
        if (error.message === 'Authentication error' || error.message.includes('session')) {
          showError('🔐 Session expired. Please sign in again.');
          logout();
        } else {
          updateConnectionStatus('disconnected');
          if (!isManualDisconnect) {
            startReconnectionProcess();
          }
        }
      });
    }

    function startReconnectionProcess() {
      if (reconnectInterval) return; // Already reconnecting
      
      reconnectInterval = setInterval(() => {
        reconnectAttempts++;
        console.log(`Manual reconnection attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
        updateConnectionStatus('reconnecting', reconnectAttempts);
        
        if (reconnectAttempts >= maxReconnectAttempts) {
          clearInterval(reconnectInterval);
          reconnectInterval = null;
          updateConnectionStatus('failed');
          return;
        }
        
        // Attempt to validate session and reconnect
        attemptReconnection();
      }, 3000);
    }

    async function attemptReconnection() {
      try {
        // First validate the session
        const response = await fetch(`${API_BASE}/auth/validate-session`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId })
        });
        
        if (response.ok) {
          // Session is valid, try to reconnect socket
          if (socket) {
            socket.disconnect();
          }
          connectSocket();
        } else {
          // Session expired
          showError('🔐 Your session has expired. Please sign in again.');
          logout();
        }
      } catch (error) {
        console.error('Reconnection failed:', error);
      }
    }

    function logout() {
      isManualDisconnect = true;
      clearInterval(reconnectInterval);
      reconnectInterval = null;
      
      localStorage.removeItem('studentSession');
      localStorage.removeItem('studentName');
      localStorage.removeItem('sessionExpires');
      sessionId = null;
      studentName = null;
      evaluationStartTime = null;
      reconnectAttempts = 0;
      resetAssessmentState({ preserveStudentInfo: false, preserveSpeechTranscript: false, silent: true });
      updateRecallButtonVisibility();

      if (socket) {
        socket.disconnect();
        socket = null;
      }
      
      isManualDisconnect = false;
      showLoginModal();
      updateConnectionStatus('disconnected');
    }

    function showError(message) {
      const errorEl = document.getElementById('loginError');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 5000);
    }

    function showSuccess(message) {
      // Create temporary success message
      const successEl = document.createElement('div');
      successEl.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        background: var(--pass); color: white; padding: 12px 20px;
        border-radius: 6px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      `;
      successEl.textContent = message;
      document.body.appendChild(successEl);
      
      setTimeout(() => {
        successEl.remove();
      }, 4000);
    }

  function sendProgressUpdate() {
      if (!socket || !socket.connected) return;

      const score = getCurrentScore();
      const items = getCurrentItems();
      
      socket.emit('evaluation-update', {
        score: score,
        items: items,
        timestamp: new Date().toISOString(),
        courseWeekId: 4,
        scenarioTitle: 'Week 4 - G-Tube Feeding'
      });
    }

    function getCurrentScore() {
      let passed = 0, failed = 0, total = 0;
      
      $$('.checklist-item').forEach(item => {
        if (item.closest('.section')) {
          total++;
          const passCheckbox = item.querySelector('input.checkbox.pass[type="checkbox"]');
          const failCheckbox = item.querySelector('input.checkbox.fail[type="checkbox"]');
          
          if (passCheckbox && passCheckbox.checked) {
            passed++;
          } else if (failCheckbox && failCheckbox.checked) {
            failed++;
          }
          // Items with neither checked are just incomplete
        }
      });

      // Calculate percentage based on completed items (passed + failed) vs total items
      const completed = passed + failed;
      const percent = total > 0 ? Math.round((passed / total) * 100) : 0;
      
      return { passed, failed, total, percent };
    }

    function getCurrentItems() {
      const items = [];
      // Maintain per-section sequence counters for deterministic ordering
      const sectionSequenceCounters = {};

      $$('.section').forEach(section => {
        const sectionName = section.querySelector('.section-title')?.textContent?.trim() || 'Unknown Section';
        const checklistItems = $$('.checklist-item', section);
        if (!(sectionName in sectionSequenceCounters)) sectionSequenceCounters[sectionName] = 0;

        checklistItems.forEach((checklistItem) => {
          const seq = sectionSequenceCounters[sectionName]++;
          // Get the item text
            const itemTextDiv = checklistItem.querySelector('.item-text');
            const itemText = itemTextDiv ? itemTextDiv.textContent?.trim() : 'Unknown Item';

            // Check for PASS and FAIL checkboxes
            const passCheckbox = checklistItem.querySelector('input.checkbox.pass[type="checkbox"]');
            const failCheckbox = checklistItem.querySelector('input.checkbox.fail[type="checkbox"]');
            const isCritical = passCheckbox?.dataset.critical === 'true';

            let status = 'not_completed';
            let notes = 'Not completed';

            if (passCheckbox && passCheckbox.checked) {
              status = 'pass';
              notes = 'Passed - criteria met';
            } else if (failCheckbox && failCheckbox.checked) {
              status = 'fail';
              notes = 'Failed - criteria not met';
            }

            // Unique key stable with sequence
            const itemKey = `${sectionName.toLowerCase().replace(/\s+/g, '_')}_${seq}`;

            items.push({
              section: sectionName,
              item: itemText,
              key: itemKey,
              checked: status === 'pass',
              failed: status === 'fail',
              status: status,
              timestamp: new Date().toISOString(),
              notes: notes,
              sequence: seq,
              critical: isCritical
            });
        });
      });

      return items;
    }

    // =============== Guided Error Correction ===============
    let guidedQueue = [];
    let guidedIndex = 0;
    let guidedActive = false;

    function collectIncompleteItems() {
      const list = [];
      $$('.checklist-item').forEach(ci => {
        const pass = ci.querySelector('input.checkbox.pass');
        const fail = ci.querySelector('input.checkbox.fail');
        if (!pass || !fail) return;
        if (!pass.checked && !fail.checked) {
          list.push(ci);
        }
      });
      return list;
    }

    function ensureSectionVisible(item) {
      const section = item.closest('.section');
      if (!section) return;
      if (section.classList.contains('collapsed')) {
        const header = section.querySelector('.section-header');
        header?.setAttribute('aria-expanded','true');
        section.classList.remove('collapsed');
      }
      // Scroll with smooth center alignment
      setTimeout(()=>{
        item.scrollIntoView({ behavior:'smooth', block:'center'});
      }, 50);
    }

    function clearGuidedFocus() {
      $$('.checklist-item.incomplete-focus').forEach(el=> el.classList.remove('incomplete-focus'));
    }

    function showGuidedToast() {
      const root = $('#guidedToastRoot');
      if (!root) return;
      const remaining = guidedQueue.length - guidedIndex;
      const currentItem = guidedQueue[guidedIndex];
      if (!currentItem) { root.innerHTML=''; guidedActive=false; return; }
      const itemText = currentItem.querySelector('.item-text')?.textContent?.trim() || 'Checklist item';
      const pct = guidedQueue.length ? Math.round((guidedIndex)/guidedQueue.length*100) : 100;
      root.innerHTML = `
        <div class="guided-toast" role="dialog" aria-label="Incomplete checklist guidance">
          <button class="guided-close" onclick="cancelGuidedMode()" aria-label="Close">×</button>
          <h4>Complete All Items Before Submitting</h4>
          <div class="guided-progress">Item ${guidedIndex+1} of ${guidedQueue.length} • ${pct}% reviewed</div>
          <div class="guided-item-text">${itemText}</div>
          <div class="guided-actions">
            <button class="guided-btn pass" onclick="markGuided('pass')">✓ Pass</button>
            <button class="guided-btn fail" onclick="markGuided('fail')">✗ Fail</button>
            <button class="guided-btn next" onclick="skipGuided()" ${remaining<=1? 'disabled style=\"opacity:.4;cursor:not-allowed;\"':''}>Skip</button>
            <button class="guided-btn submit" onclick="resumeSubmission()" ${remaining>1? 'disabled':''}><span>Submit Now</span></button>
          </div>
        </div>`;
    }
    window.showGuidedToast = showGuidedToast;

    function startGuidedMode(onSubmitAfter=true) {
      guidedQueue = collectIncompleteItems();
      guidedIndex = 0;
      guidedActive = true;
      if (!guidedQueue.length) return false;
      focusCurrentGuided();
      showGuidedToast();
      return true;
    }
    window.startGuidedMode = startGuidedMode;

    function focusCurrentGuided() {
      clearGuidedFocus();
      const current = guidedQueue[guidedIndex];
      if (!current) return;
      current.classList.add('incomplete-focus');
      ensureSectionVisible(current);
    }

    function markGuided(mode) {
      const current = guidedQueue[guidedIndex];
      if (!current) return;
      const key = current.querySelector('input.checkbox.pass')?.getAttribute('data-key');
      if (mode==='pass') {
        const pass = current.querySelector('input.checkbox.pass');
        const fail = current.querySelector('input.checkbox.fail');
        if (pass) { pass.checked = true; fail && (fail.checked = false); }
        current.classList.add('checked'); current.classList.remove('failed');
      } else if (mode==='fail') {
        const pass = current.querySelector('input.checkbox.pass');
        const fail = current.querySelector('input.checkbox.fail');
        if (fail) { fail.checked = true; pass && (pass.checked = false); }
        current.classList.add('failed'); current.classList.remove('checked');
      }
      updateCounts();
      advanceGuided();
    }
    window.markGuided = markGuided;

    function skipGuided() {
      advanceGuided();
    }
    window.skipGuided = skipGuided;

    function advanceGuided() {
      guidedQueue = collectIncompleteItems();
      if (guidedQueue.length === 0) { completeGuided(); return; }
      if (guidedIndex >= guidedQueue.length) guidedIndex = 0; // wrap
      focusCurrentGuided();
      showGuidedToast();
    }

    function completeGuided() {
      clearGuidedFocus();
      guidedActive = false;
      const root = $('#guidedToastRoot');
      if (root) root.innerHTML = `<div class="guided-toast" style="background:#0f172a;">
        <h4>All items answered ✅</h4>
        <div style="font-size:.85rem; opacity:.85;">You can submit now.</div>
        <div class="guided-actions" style="margin-top:10px;">
          <button class="guided-btn submit" onclick="resumeSubmission()">Submit Evaluation</button>
          <button class="guided-btn next" onclick="cancelGuidedMode()">Close</button>
        </div>
      </div>`;
    }

    function cancelGuidedMode() {
      guidedActive = false;
      clearGuidedFocus();
      const root = $('#guidedToastRoot');
      if (root) root.innerHTML = '';
    }
    window.cancelGuidedMode = cancelGuidedMode;

    let pendingSubmitForce = false;
    function guardedSubmit(forceOverwrite=false) {
      const incompletes = collectIncompleteItems();
      if (incompletes.length) {
        // Start guided mode
        startGuidedMode();
        showGuidedToast();
        pendingSubmitForce = forceOverwrite;
        return; // Halt normal submission
      }
      // All good – proceed
      submitEvaluation(forceOverwrite);
    }

    function resumeSubmission() {
      // Re-check in case items still incomplete
      const incompletes = collectIncompleteItems();
      if (incompletes.length) {
        guidedQueue = incompletes; guidedIndex = 0; focusCurrentGuided(); showGuidedToast();
        return;
      }
      cancelGuidedMode();
      submitEvaluation(pendingSubmitForce);
    }
    window.resumeSubmission = resumeSubmission;

    async function submitEvaluation(forceOverwrite = false) {
      console.log('🚀 submitEvaluation called with forceOverwrite:', forceOverwrite);
      
      if (!socket || !socket.connected) {
        const retry = confirm(
          '🔌 Not connected to server.\n\n' +
          'Would you like to try reconnecting first?\n\n' +
          'Click OK to attempt reconnection, or Cancel to abort submission.'
        );
        
        if (retry) {
          showSuccess('🔄 Attempting to reconnect...');
          await attemptReconnection();
          
          // Wait a moment for reconnection
          await new Promise(resolve => setTimeout(resolve, 2000));
          
          if (!socket || !socket.connected) {
            alert('❌ Reconnection failed. Please refresh the page and try again.');
            return;
          } else {
            showSuccess('✅ Reconnected! Proceeding with submission...');
          }
        } else {
          return;
        }
      }

      const score = getCurrentScore();
      const items = getCurrentItems();
      const notes = {
        additionalNotes: document.getElementById('additionalNotes')?.value || '',
        evaluatorName: document.getElementById('evaluatorName')?.value || '',
        scenarioTime: document.getElementById('scenarioTime')?.value || '',
        evaluationDate: document.getElementById('evaluationDate')?.value || '',
        sbar_notes: document.getElementById('sbar_notes')?.value || '',
        collaboration_notes: document.getElementById('collaboration_notes')?.value || '',
        critical_thinking_notes: document.getElementById('critical_thinking_notes')?.value || '',
        clinical_judgment_notes: document.getElementById('clinical_judgment_notes')?.value || ''
      };

      // Check for duplicate evaluations first (unless forcing overwrite)
      if (!forceOverwrite) {
        try {
          console.log('🔍 Checking for duplicate evaluation for:', studentName);
          console.log('🌐 API Base URL:', API_BASE);
          console.log('📝 Request payload:', { studentName: studentName, courseWeekId: 4 });
          
          const duplicateResponse = await fetch(`${API_BASE}/evaluations/check-duplicate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              studentName: studentName, 
              courseWeekId: 4 
            })
          });
          
          console.log('📡 Duplicate check response status:', duplicateResponse.status);
          
          if (!duplicateResponse.ok) {
            console.error('❌ Duplicate check failed with status:', duplicateResponse.status);
            throw new Error(`HTTP ${duplicateResponse.status}`);
          }
          
          const duplicateData = await duplicateResponse.json();
          console.log('📊 Duplicate check result:', duplicateData);
          
          if (duplicateData.duplicate) {
            const existing = duplicateData.existingEvaluation;
            const existingDate = new Date(existing.completedAt).toLocaleDateString();
            const existingTime = new Date(existing.completedAt).toLocaleTimeString();
            
            const overwrite = confirm(
              `⚠️ DUPLICATE EVALUATION DETECTED\n\n` +
              `Student "${studentName}" already has an evaluation for G-Tube Feeding:\n\n` +
              `• Previous Score: ${existing.score}%\n` +
              `• Completed: ${existingDate} at ${existingTime}\n\n` +
              `Do you want to OVERWRITE the previous evaluation?\n\n` +
              `Click OK to overwrite, or Cancel to keep the existing evaluation.`
            );
            
            if (!overwrite) {
              alert('Evaluation submission cancelled. Previous evaluation preserved.');
              return;
            }
            
            // User confirmed overwrite, proceed with forced submission
            return submitEvaluation(true);
          }
        } catch (error) {
          console.error('❌ Error checking for duplicates:', error);
          alert(`⚠️ Duplicate check failed: ${error.message}\n\nPlease check the console for details.`);
          const proceed = confirm(
            'Unable to check for duplicate evaluations.\n\n' +
            'Do you want to proceed with submission anyway?'
          );
          if (!proceed) return;
        }
      }

      // Send completion event to server
      console.log('📡 Emitting evaluation-complete with overwrite:', forceOverwrite);
      
      socket.emit('evaluation-complete', {
        courseWeekId: 4, // Week 4 - G-Tube Feeding Evaluation
        courseName: 'G-Tube Feeding Evaluation',
        score: score,
        items: items,
        notes: notes,
        evaluatorName: notes.evaluatorName,
        scenarioTime: notes.scenarioTime,
        startTime: evaluationStartTime,
        endTime: new Date().toISOString(),
        overwrite: forceOverwrite
      });

      // Clear auto-saved form state after successful submission
      localStorage.removeItem('evaluationFormState');
      const snapshot = {
        timestamp: Date.now(),
        studentName,
        courseWeekId: 4,
        score,
        notes,
        items
      };
      saveLastEvaluationSnapshot(snapshot);
      updateRecallButtonVisibility();

      alert(`Evaluation completed!\nScore: ${score.percent}% (${score.passed}/${score.total})`);

      resetAssessmentState({ preserveStudentInfo: true, preserveSpeechTranscript: false, silent: true });
      showSuccess('Submission recorded. Workspace reset for the next assessment.');
    }

    // Login form handler
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('loginStudentName').value.trim();
      const password = document.getElementById('loginPassword').value;
      if (!name) { showError('Please enter your name'); return; }
      if (!password) { showError('Password is required'); return; }
      const prevName = localStorage.getItem('studentName');
      try {
        const response = await fetch(`${API_BASE}/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: name, password: password }) });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Login failed');
        if (data.sessionId && data.studentName) {
          // Clear previous student's data BEFORE overwriting localStorage
          clearWeek1ProgressForNewStudent(data.studentName);
          studentName = data.studentName;
          sessionId = data.sessionId;
          localStorage.setItem('studentName', data.studentName);
          localStorage.setItem('studentSession', data.sessionId);
        localStorage.setItem('sessionExpires', data.expiresAt);
        hideLoginModal();
        connectSocket();
        updateRecallButtonVisibility();
      } else {
        throw new Error('Login failed - no session created');
      }
      } catch (error) {
        showError(error.message || 'Failed to sign in');
      }
    });

    // --- New Student Login Clearing Logic ---
    function clearWeek1ProgressForNewStudent(newName){
      const prev = localStorage.getItem('studentName');
      if(prev && prev.trim().toLowerCase() !== newName.trim().toLowerCase()){
        // Remove stored states relevant to Week 1 / Personal Care
        localStorage.removeItem('n10l_peer_eval_state');
        localStorage.removeItem('evaluationFormState');
        resetAssessmentState({ preserveStudentInfo: true, preserveSpeechTranscript: true, silent: true });
        showSuccess('Previous student data cleared');
        updateRecallButtonVisibility();
      }
    }

  // Removed delayed clearing listener – clearing now handled synchronously in login handler.

    // --- Switch Student / Logout Feature (Week 1) ---
    function switchStudent(){
      if(!confirm('Switch student? This will clear current progress.')) return;
      try { if(socket) socket.disconnect(); } catch(e){}
      // Clear global session identifiers
      localStorage.removeItem('studentSession');
      localStorage.removeItem('studentName');
      // Clear week-specific stored state
      localStorage.removeItem('n10l_peer_eval_state');
      localStorage.removeItem('evaluationFormState');
      // Reset in‑memory vars
      sessionId=null; studentName=null; evaluationStartTime=null;
      resetAssessmentState({ preserveStudentInfo: false, preserveSpeechTranscript: false, silent: true });
      // Show login modal again
      if(typeof showLoginModal==='function') showLoginModal(); else document.getElementById('loginModal').style.display='flex';
      showSuccess('Student session cleared. Ready for new login.');
      updateRecallButtonVisibility();
    }
    // Attach listener after DOM ready if button exists
    document.addEventListener('DOMContentLoaded',()=>{ const btn=document.getElementById('switchStudent'); if(btn) btn.addEventListener('click',switchStudent); });

    function toggleSection(btn) {
      const section = btn.closest('.section');
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', String(!expanded));
      section.classList.toggle('collapsed', expanded);
    }

    function updateCounts() {
      // Per-section counts
      $$('.section').forEach(sec => {
        const content = $('.section-content', sec);
        if (!content) return;
        const items = $$('.checklist-item', content);
        const passed = items.filter(x => x.classList.contains('checked')).length;
        const failed = items.filter(x => x.classList.contains('failed')).length;
        const metaSpan = $('[data-count]', sec);
        if (metaSpan) metaSpan.textContent = `${passed}✓ / ${failed}✗ of ${items.length}`;
      });

      // Overall
      const allItems = $$('.checklist-item');
      const passed = allItems.filter(x => x.classList.contains('checked')).length;
  const failed = allItems.filter(x => x.classList.contains('failed')).length;
  const total  = allItems.length;
  const criticalFailed = allItems.filter(x => x.classList.contains('failed') && x.querySelector('input.checkbox.pass[data-critical="true"]')).length;
      const pct = total ? Math.round((passed / total) * 100) : 0;
      $('#completedScore').textContent = `${passed} / ${total}`;
      $('#failedScore').textContent = `${failed}`;
  const critEl = $('#criticalFailedScore');
  if (critEl) critEl.textContent = criticalFailed;
      const scoreEl = $('#overallScore');
      scoreEl.textContent = `${pct}%`;
      scoreEl.style.background = pct >= 90 ? 'var(--ok)' : (pct >= 75 ? 'var(--warn)' : 'var(--fail)');

      // Progress bar
      const completed = passed + failed;
      const progressPct = total ? (completed / total) * 100 : 0;
      $('#progressFill').style.width = progressPct + '%';

      // Send real-time update to admin dashboard
      sendProgressUpdate();
    }

    function clearSpeechInterface() {
      const hasSpeech = typeof speechToText !== 'undefined' && speechToText;
      if (hasSpeech && speechToText.isRecognizing) {
        try { stopSpeechRecognition(); } catch (error) {
          console.debug('Speech stop (ignore if not recording):', error?.message || error);
        }
      }
      if (hasSpeech && typeof speechToText.clear === 'function') {
        speechToText.clear();
      }
      const finalTranscriptEl = document.getElementById('transcriptFinal');
      const interimTranscriptEl = document.getElementById('transcriptInterim');
      if (finalTranscriptEl) finalTranscriptEl.textContent = '';
      if (interimTranscriptEl) interimTranscriptEl.textContent = '';
      const statusTextEl = document.getElementById('speechStatusText');
      if (statusTextEl) statusTextEl.textContent = 'Ready to begin assessment';
      const recordingDot = document.getElementById('recordingDot');
      if (recordingDot) recordingDot.classList.remove('active');
      if (typeof updateSpeechUI === 'function') {
        updateSpeechUI(false);
      } else {
        const startBtn = document.getElementById('speechStartBtn');
        const stopBtn = document.getElementById('speechStopBtn');
        const saveBtn = document.getElementById('speechSaveBtn');
        const submitBtn = document.getElementById('speechSubmitBtn');
        if (startBtn) startBtn.style.display = 'flex';
        if (stopBtn) stopBtn.style.display = 'none';
        if (saveBtn) saveBtn.style.display = 'none';
        if (submitBtn) submitBtn.style.display = 'none';
      }
    }

    function resetAssessmentState(options = {}) {
      const {
        preserveStudentInfo = true,
        preserveSpeechTranscript = false,
        silent = false
      } = options;

      $$('.checklist-item').forEach(item => {
        item.classList.remove('checked', 'failed');
        const pass = item.querySelector('input.checkbox.pass');
        const fail = item.querySelector('input.checkbox.fail');
        if (pass) pass.checked = false;
        if (fail) fail.checked = false;
      });

      const noteFields = [
        'sbar_notes',
        'collaboration_notes',
        'critical_thinking_notes',
        'clinical_judgment_notes',
        'additional_notes'
      ];
      noteFields.forEach(id => {
        const field = document.getElementById(id);
        if (field) field.value = '';
      });

      const evaluatorField = document.getElementById('evaluatorName');
      if (evaluatorField) evaluatorField.value = '';

      const scenarioField = document.getElementById('scenarioTime');
      if (scenarioField) scenarioField.value = DEFAULT_SCENARIO_TIME;

      const dateField = document.getElementById('evaluationDate');
      if (dateField) {
        dateField.value = DEFAULT_EVALUATION_DATE;
      }

      localStorage.removeItem('evaluationFormState');
      localStorage.removeItem('n10l_peer_eval_state');

      guidedQueue = [];
      guidedIndex = 0;
      guidedActive = false;
      clearGuidedFocus();

      updateCounts();

      if (!preserveSpeechTranscript) {
        clearSpeechInterface();
      }

      assessmentSessionId = null;
      speechSegmentCount = 0;

      if (!silent) {
        showSuccess('Assessment reset. Ready for a new attempt.');
      }

      if (!preserveStudentInfo) {
        const studentField = document.getElementById('studentName');
        if (studentField) studentField.value = '';
      }
    }

    function applyEvaluationSnapshot(snapshot) {
      if (!snapshot || !Array.isArray(snapshot.items)) {
        showError('No saved submission found to recall.');
        updateRecallButtonVisibility();
        return;
      }

      resetAssessmentState({ preserveStudentInfo: true, preserveSpeechTranscript: true, silent: true });

      const itemsByKey = new Map(snapshot.items.map(item => [item.key, item]));

      $$('.section').forEach(section => {
        const sectionName = section.querySelector('.section-title')?.textContent?.trim() || 'Unknown Section';
        let sequence = 0;
        $$('.checklist-item', section).forEach(checklistItem => {
          const key = `${sectionName.toLowerCase().replace(/\s+/g, '_')}_${sequence++}`;
          const saved = itemsByKey.get(key);

          const passCheckbox = checklistItem.querySelector('input.checkbox.pass[type="checkbox"]');
          const failCheckbox = checklistItem.querySelector('input.checkbox.fail[type="checkbox"]');

          if (passCheckbox) passCheckbox.checked = false;
          if (failCheckbox) failCheckbox.checked = false;
          checklistItem.classList.remove('checked', 'failed');

          if (!saved) return;
          const status = saved.status || (saved.checked ? 'pass' : saved.failed ? 'fail' : 'not_completed');
          if (status === 'pass' && passCheckbox) {
            passCheckbox.checked = true;
            checklistItem.classList.add('checked');
          } else if (status === 'fail' && failCheckbox) {
            failCheckbox.checked = true;
            checklistItem.classList.add('failed');
          }
        });
      });

      const notes = snapshot.notes || {};
      const noteFieldMap = {
        evaluatorName: notes.evaluatorName || '',
        scenarioTime: notes.scenarioTime || DEFAULT_SCENARIO_TIME,
        evaluationDate: notes.evaluationDate || DEFAULT_EVALUATION_DATE,
        sbar_notes: notes.sbar_notes || '',
        collaboration_notes: notes.collaboration_notes || '',
        critical_thinking_notes: notes.critical_thinking_notes || '',
        clinical_judgment_notes: notes.clinical_judgment_notes || '',
        additional_notes: notes.additional_notes || ''
      };

      Object.entries(noteFieldMap).forEach(([id, value]) => {
        const field = document.getElementById(id);
        if (field) field.value = value;
      });

      updateCounts();

      showSuccess('Last submission recalled. You may review or make adjustments before resubmitting.');
    }

    function recallLastEvaluation() {
      const snapshot = loadLastEvaluationSnapshot();
      if (!snapshot) {
        showError('No saved submission found to recall.');
        updateRecallButtonVisibility();
        return;
      }
      applyEvaluationSnapshot(snapshot);
    }

    window.resetAssessmentState = resetAssessmentState;
    window.recallLastEvaluation = recallLastEvaluation;

    function handleToggle(e) {
      const input = e.target;
      if (!(input instanceof HTMLInputElement)) return;
      if (!input.classList.contains('checkbox')) return;
      const item = input.closest('.checklist-item');
      const isFail = input.hasAttribute('data-fail');
      const key = input.getAttribute('data-key') || '';

      // Mutually exclusive pass/fail
      const siblings = $$(`input[data-key="${key}"]`, item);
      siblings.forEach(s => { if (s !== input) s.checked = false; });

      if (input.checked) {
        if (isFail) {
          item.classList.add('failed');
          item.classList.remove('checked');
        } else {
          item.classList.add('checked');
          item.classList.remove('failed');
        }
      } else {
        item.classList.remove('checked', 'failed');
      }

      saveState();
      updateCounts();
    }

    function resetFormHard() {
      if (!confirm('Reset the entire form? This cannot be undone.')) return;
      resetAssessmentState({ preserveStudentInfo: true, preserveSpeechTranscript: false, silent: true });
      localStorage.removeItem('n10l_peer_eval_state');
      showSuccess('Form reset. You can begin the assessment again.');
    }

    function saveState() {
      const state = {
        studentName: $('#studentName').value,
        evaluatorName: $('#evaluatorName').value,
        evaluationDate: $('#evaluationDate').value,
        scenarioTime: $('#scenarioTime').value,
        notes: {
          sbar: $('#sbar_notes').value,
          collab: $('#collaboration_notes').value,
          crit: $('#critical_thinking_notes').value,
          clinical: $('#clinical_judgment_notes').value,
          add: $('#additional_notes').value
        },
        items: $$('.checklist-item').map(item => {
          // derive first input data-key for an id
          const passInput = $('input.checkbox.pass', item);
          const key = passInput ? passInput.getAttribute('data-key') : undefined;
          return { key, checked: item.classList.contains('checked'), failed: item.classList.contains('failed') };
        })
      };
      localStorage.setItem('n10l_peer_eval_state', JSON.stringify(state));
    }

    function loadState() {
      const raw = localStorage.getItem('n10l_peer_eval_state');
      if (!raw) return;
      try {
        const state = JSON.parse(raw);
        if (state.studentName) $('#studentName').value = state.studentName;
        if (state.evaluatorName) $('#evaluatorName').value = state.evaluatorName;
        if (state.evaluationDate) $('#evaluationDate').value = state.evaluationDate;
        if (state.scenarioTime) $('#scenarioTime').value = state.scenarioTime;
        if (state.notes) {
          $('#sbar_notes').value = state.notes.sbar || '';
          $('#collaboration_notes').value = state.notes.collab || '';
          $('#critical_thinking_notes').value = state.notes.crit || '';
          $('#clinical_judgment_notes').value = state.notes.clinical || '';
          $('#additional_notes').value = state.notes.add || '';
        }
        if (Array.isArray(state.items)) {
          state.items.forEach(entry => {
            if (!entry || !entry.key) return;
            const item = $(`.checklist-item input[data-key="${entry.key}"]`)?.closest('.checklist-item');
            if (!item) return;
            const pass = $('input.checkbox.pass', item);
            const fail = $('input.checkbox.fail', item);
            if (entry.failed) {
              if (fail) fail.checked = true;
              if (pass) pass.checked = false;
              item.classList.add('failed');
              item.classList.remove('checked');
            } else if (entry.checked) {
              if (pass) pass.checked = true;
              if (fail) fail.checked = false;
              item.classList.add('checked');
              item.classList.remove('failed');
            } else {
              if (pass) pass.checked = false;
              if (fail) fail.checked = false;
              item.classList.remove('checked','failed');
            }
          });
        }
      } catch {}
    }

    function generateReport() {
      const studentName = $('#studentName').value.trim();
      const evaluatorName = $('#evaluatorName').value.trim();
      const evaluationDate = $('#evaluationDate').value;
      if (!studentName || !evaluatorName || !evaluationDate) {
        alert('Please fill Student, Evaluator, and Date before generating a report.');
        return;
      }
      const items = $$('.checklist-item');
      const passed = items.filter(i => i.classList.contains('checked'));
      const failed = items.filter(i => i.classList.contains('failed'));
      const total = items.length;
      const pct = total ? Math.round((passed.length/total)*100) : 0;

      let report = '';
      report += 'NURS 10L - G-Tube Feeding Peer Evaluation Report\n';
      report += '================================================\n\n';
      report += `Student Evaluated: ${studentName}\n`;
      report += `Evaluator: ${evaluatorName}\n`;
      report += `Date: ${evaluationDate}\n`;
      report += `Scenario: Shannon Shaw Case Study\n\n`;
      report += 'SUMMARY\n';
      report += '-------\n';
      report += `Tasks Completed: ${passed.length} / ${total}\n`;
      report += `Tasks Failed: ${failed.length}\n`;
      report += `Overall Score: ${pct}%\n\n`;

      if (passed.length) {
        report += 'PASSED TASKS\n';
        report += '-----------\n';
        passed.forEach(i => report += '✓ ' + $('.item-text', i).textContent.trim() + '\n');
        report += '\n';
      }
      if (failed.length) {
        report += 'TASKS NEEDING IMPROVEMENT\n';
        report += '-------------------------\n';
        failed.forEach(i => report += '✗ ' + $('.item-text', i).textContent.trim() + '\n');
        report += '\n';
      }

      const criticalFails = failed.filter(i => i.querySelector('input.checkbox.pass[data-critical="true"]'));
      if (criticalFails.length) {
        report += 'CRITICAL ELEMENTS FAILED\n';
        report += '-----------------------\n';
        criticalFails.forEach(i => {
          const txt = $('.item-text', i).textContent.replace(/CRITICAL$/,'').trim();
          report += '⚠ ' + txt + '\n';
        });
        report += '\n';
      }

      const sbar = $('#sbar_notes').value.trim();
      const collab = $('#collaboration_notes').value.trim();
      const crit = $('#critical_thinking_notes').value.trim();
      const clinical = $('#clinical_judgment_notes').value.trim();
      const add = $('#additional_notes').value.trim();
      if (sbar) { report += 'SBAR NOTES\n---------\n' + sbar + '\n\n'; }
      if (collab) { report += 'COLLABORATION NOTES\n-------------------\n' + collab + '\n\n'; }
      if (crit) { report += 'CRITICAL THINKING NOTES\n-----------------------\n' + crit + '\n\n'; }
      if (clinical) { report += 'CLINICAL JUDGMENT NOTES\n-----------------------\n' + clinical + '\n\n'; }
      if (add) { report += 'ADDITIONAL NOTES\n----------------\n' + add + '\n\n'; }
      report += 'Report generated on: ' + new Date().toLocaleString() + '\n';

      const blob = new Blob([report], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `NURS10L_Evaluation_${studentName.replace(/\s+/g,'_')}_${evaluationDate}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      // Pre-fill date to today if empty
      const today = new Date().toISOString().slice(0,10);
      const dateEl = $('#evaluationDate');
      if (!dateEl.value) dateEl.value = today;

      // Load saved state (if any)
      loadState();
      const recallBtn = document.getElementById('recallEvaluationBtn');
      if (recallBtn) {
        recallBtn.addEventListener('click', recallLastEvaluation);
      }
      updateRecallButtonVisibility();

      // Listeners
      document.body.addEventListener('change', handleToggle);
      $('#resetForm').addEventListener('click', resetFormHard);
      $('#downloadReport').addEventListener('click', generateReport);
      $('#submitEvaluation').addEventListener('click', (e) => {
        console.log('🔘 Submit button clicked');
        e.preventDefault();
        guardedSubmit();
      });
      $('#expandAll').addEventListener('click', () => $$('.section').forEach(s => { s.classList.remove('collapsed'); $('.section-header', s)?.setAttribute('aria-expanded','true'); }));
      $('#collapseAll').addEventListener('click', () => $$('.section').forEach(s => { s.classList.add('collapsed'); $('.section-header', s)?.setAttribute('aria-expanded','false'); }));

      // Update counts initially and on typing for notes/fields
      updateCounts();
      $$('input, textarea').forEach(el => el.addEventListener('input', () => { 
        saveState(); 
        saveFormState(); // Auto-save for disconnection recovery
      }));
      
      // Auto-save on checkbox changes
      $$('input[type="checkbox"]').forEach(el => el.addEventListener('change', () => {
        saveFormState();
      }));
      
      // Auto-save every 30 seconds
      setInterval(saveFormState, 30000);
    });
  </script>
</body>
</html>
