<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#667eea" />
  <title>NURS 10L - Week 3 Medication Administration Evaluation</title>
  <script src="/N10L/socket.io/socket.io.js"></script>
  <style>
    :root {
      --bg: #f5f7fa;
      --card: #ffffff;
      --muted: #4a5568;
      --muted-2: #718096;
      --primary: #667eea;
      --primary-2: #5a67d8;
      --accent: #764ba2;
      --pass: #48bb78;
      --fail: #e53e3e;
      --ok: #38a169;
      --warn: #d69e2e;
      --border: #e2e8f0;
    }

    * { box-sizing: border-box; }
    /* Mobile-first readable base font size; scales slightly with viewport */
    html { font-size: clamp(18px, 5vw, 20px); }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: #2d3748;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: 10px;
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      touch-action: manipulation;
    }

    .container {
      max-width: 920px;
      margin: 0 auto;
      background: var(--card);
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 20px);
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      color: #fff;
      padding: 18px 20px 14px;
      text-align: center;
    }
  .header h1 { margin: 0 0 6px; font-size: clamp(1.4rem, 5.5vw, 1.85rem); font-weight: 700; }
  .header p { margin: 0; opacity: 0.95; font-size: 1rem; }

  .progress-bar { height: 10px; background: rgba(255,255,255,0.25); border-radius: 6px; overflow: hidden; margin-top: 12px; }
    .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #fff 0%, #d6d6ff 100%); transition: width .25s ease; }

    .toolbar {
      display: flex;
      gap: 10px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      background: #fafbff;
    }
    .btn {
      padding: 14px 16px;
      border: 0;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1.05rem;
      cursor: pointer;
      transition: background .2s ease, transform .05s ease;
      min-height: 48px;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-2); }
    .btn-secondary { background: #e2e8f0; color: var(--muted); }
    .btn-secondary:hover { background: #cbd5e0; }

    /* Speech-to-Text Controls */
    .speech-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f0f9ff;
      border-radius: 8px;
      border: 1px solid #bae6fd;
      flex: 1;
      min-width: 350px;
      flex-wrap: wrap;
    }
    
    .speech-btn {
      padding: 8px 12px;
      border: 0;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all .2s ease;
      min-height: 36px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .speech-btn-start { background: #10b981; color: white; }
    .speech-btn-start:hover { background: #059669; }
    .speech-btn-stop { background: #ef4444; color: white; }
    .speech-btn-stop:hover { background: #dc2626; }
    .speech-btn:disabled { background: #9ca3af; cursor: not-allowed; }
    
    .speech-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: #374151;
      flex: 1;
    }
    
    .recording-dot {
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse 1.5s infinite;
      display: none;
    }
    
    .recording-dot.active { display: block; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    .speech-transcript {
      margin-top: 12px;
      padding: 12px;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      max-height: 120px;
      overflow-y: auto;
      font-size: 0.9rem;
      line-height: 1.4;
      display: none;
    }
    
    .speech-transcript.visible { display: block; }
    
    .transcript-final { color: #1f2937; }
    .transcript-interim { color: #6b7280; font-style: italic; }
    
    .speech-error {
      color: #ef4444;
      font-size: 0.8rem;
      margin-top: 4px;
      display: none;
    }
    
    .speech-error.visible { display: block; }

    form { display: block; width: 100%; }

    .section {
      border-bottom: 1px solid var(--border);
    }
    .section:last-of-type { border-bottom: 0; }

    .section-header {
      width: 100%;
      text-align: left;
      padding: 14px 16px;
      background: #f7fafc;
      border: 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      gap: 10px;
      min-height: 48px;
    }
  .section-title { margin: 0; font-size: 1.2rem; font-weight: 700; color: #2d3748; }
  .section-meta { color: var(--muted-2); font-size: 1rem; margin-left: auto; margin-right: 10px; }
    .toggle-icon { font-size: 1.05rem; opacity: .8; }

    .section-content { padding: 16px; display: block; }
    .section.collapsed .section-content { display: none; }

    .student-info {
      padding: 16px;
      background: #f8f9ff;
      border-bottom: 1px solid var(--border);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .field label { display: block; font-weight: 600; color: var(--muted); margin-bottom: 6px; font-size: 1rem; }
    .field input, .field textarea {
      width: 100%; padding: 12px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 1.1rem; background: white; min-height: 48px;
    }
    .field input:focus, .field textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102,126,234,.15); }

    .scenario-summary { padding: 16px; background: #fff7db; border-left: 4px solid #f6c343; }
    .scenario-summary h3 { margin: 0 0 8px; color: #7a5d00; }
    .patient-info { background: #fff; padding: 12px; border: 1px solid #fde3a7; border-radius: 8px; }

    .checklist-item {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      padding: 12px;
      margin-bottom: 10px;
      background: #f8f9ff;
      border: 1px solid var(--border);
      border-radius: 10px;
    }
  .checkbox-container { display: flex; flex-direction: column; gap: 8px; min-width: 120px; }
  .checkbox-group { display: inline-flex; align-items: center; gap: 8px; }
  .checkbox { width: 26px; height: 26px; cursor: pointer; }
    .checkbox.pass { accent-color: var(--pass); }
    .checkbox.fail { accent-color: var(--fail); }
  .checkbox-label { font-size: 1rem; font-weight: 700; user-select: none; }
    .checkbox-label.pass { color: #2f855a; }
    .checkbox-label.fail { color: #c53030; }
  .item-text { flex: 1; font-size: 1.1rem; }
    .checklist-item.checked { background: #f2fff6; border-color: #bdebcf; }
    .checklist-item.failed  { background: #fff5f5; border-color: #f9b3b3; }

    .notes {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      padding: 0 16px 16px;
    }
  .notes textarea { min-height: 130px; resize: vertical; }

    .scorebar {
      margin-top: auto;
      position: sticky; bottom: 0; background: #fff; border-top: 1px solid var(--border);
      padding: 12px 16px calc(12px + env(safe-area-inset-bottom)); display: grid; grid-template-columns: repeat(3, auto) 1fr; gap: 12px; align-items: center;
    }
  .pill { padding: 8px 14px; border-radius: 999px; color: #fff; font-weight: 800; font-size: 1.1rem; }
    .pill.primary { background: var(--primary); }
    .pill.fail { background: var(--fail); }
    .pill.score { background: var(--fail); }

    /* Critical element indicator */
    .critical-badge {
      display: inline-block;
      background: #e53e3e;
      color: #fff;
      font-size: .55rem;
      padding: 3px 6px 2px;
      border-radius: 6px;
      margin-left: 8px;
      letter-spacing: .5px;
      font-weight: 700;
      box-shadow: 0 0 0 1px rgba(229,62,62,0.4), 0 2px 4px rgba(229,62,62,0.35);
      position: relative;
      top: -1px;
      white-space: nowrap;
    }
    .checklist-item.failed .critical-badge { background:#9b2c2c; }

  /* Guided correction highlight */
  .incomplete-focus { position: relative; box-shadow: 0 0 0 3px #f59e0b, 0 0 0 6px rgba(245,158,11,0.35); animation: pulseRing 1.2s ease-in-out infinite; }
  @keyframes pulseRing { 0% { box-shadow: 0 0 0 3px #f59e0b, 0 0 0 6px rgba(245,158,11,0.35);} 50% { box-shadow: 0 0 0 3px #f59e0b, 0 0 0 10px rgba(245,158,11,0.08);} 100% { box-shadow: 0 0 0 3px #f59e0b, 0 0 0 6px rgba(245,158,11,0.35);} }
  .guided-toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 18px; width: min(680px, 92%); background: #1a1f29; color:#fff; padding: 18px 20px 16px; border-radius: 16px; box-shadow: 0 14px 42px -8px rgba(0,0,0,0.45), 0 4px 18px rgba(0,0,0,0.4); z-index: 1100; font-size: .95rem; display:flex; flex-direction:column; gap:14px; }
  .guided-toast h4 { margin:0; font-size:1.05rem; font-weight:700; }
  .guided-progress { font-size:.8rem; letter-spacing:.5px; opacity:.85; }
  .guided-item-text { background:#222b38; padding:12px 14px; border-radius:10px; max-height:110px; overflow:auto; line-height:1.3; font-size:.95rem; }
  .guided-actions { display:flex; flex-wrap:wrap; gap:10px; }
  .guided-btn { flex:1 1 auto; padding:12px 14px; border:none; border-radius:10px; font-weight:600; cursor:pointer; font-size:.9rem; display:flex; align-items:center; justify-content:center; gap:6px; }
  .guided-btn.pass { background:#16a34a; color:#fff; }
  .guided-btn.pass:hover { background:#15803d; }
  .guided-btn.fail { background:#dc2626; color:#fff; }
  .guided-btn.fail:hover { background:#b91c1c; }
  .guided-btn.next { background:#334155; color:#e2e8f0; }
  .guided-btn.next:hover { background:#1e293b; }
  .guided-btn.submit { background: linear-gradient(90deg,#6366f1,#8b5cf6); color:#fff; }
  .guided-btn.submit[disabled] { background:#475569; cursor:not-allowed; opacity:.6; }
  .guided-close { position:absolute; top:8px; right:10px; background:none; border:none; color:#94a3b8; font-size:18px; cursor:pointer; }
  .guided-close:hover { color:#fff; }

    /* Small-screen optimizations (iPhone 12 ~390px width) */
    @media (max-width: 480px) {
      body { padding: 8px; }
      .container { border-radius: 12px; }
      .toolbar { gap: 8px; padding: 10px 12px; }
      .btn { flex: 1 1 auto; min-width: 44%; font-size: 1.1rem; min-height: 50px; }
      .section-header { min-height: 52px; }
      .section-title { font-size: 1.25rem; }
      .section-meta { font-size: 1.05rem; }
      .section-content { padding: 14px; }
      .checklist-item { flex-direction: column; gap: 10px; }
      .checkbox-container { flex-direction: row; align-items: center; min-width: auto; }
      .checkbox-group { gap: 10px; }
      .checkbox { width: 28px; height: 28px; }
      .checkbox-label { font-size: 1.05rem; }
      .item-text { font-size: 1.15rem; }
      .notes textarea { min-height: 150px; }
      /* Compact responsive score bar */
      .scorebar { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 6px 10px; 
        padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      }
      .scorebar > div { 
        flex: 1 1 48%; 
        display: flex; 
        align-items: center; 
        gap: 4px;
        font-size: .85rem;
      }
      .scorebar > div:last-child { flex: 1 1 100%; order: 4; text-align: left !important; font-size: .7rem; }
      .pill { 
        font-size: .85rem; 
        padding: 6px 10px; 
        font-weight: 700;
        line-height: 1.1;
        min-width: 0;
      }
      .header h1 { font-size: 1.35rem; }
      html { font-size: clamp(16px, 4.8vw, 18px); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>NURS 10L - Medication Administration</h1>
      <p>Week 3 Peer Assessment - Shannon Shaw Case Study</p>
      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
    </div>

    <div class="toolbar">
      <button type="button" class="btn btn-secondary" id="expandAll">Expand all</button>
      <button type="button" class="btn btn-secondary" id="collapseAll">Collapse all</button>
      <button type="button" class="btn btn-secondary" id="resetForm">Reset form</button>
  <button type="button" class="btn btn-secondary" id="switchStudent">Switch / Logout</button>
      
      <!-- Speech-to-Text Controls -->
      <div class="speech-controls">
        <button type="button" class="speech-btn speech-btn-start" id="speechStartBtn">
          🎤 Start Assessment Recording
        </button>
        <button type="button" class="speech-btn speech-btn-stop" id="speechStopBtn" style="display: none;">
          ⏹️ Stop Recording
        </button>
        <button type="button" class="speech-btn" id="speechSaveBtn" style="background: #059669; color: white; display: none;">
          💾 Save Transcript
        </button>
        <button type="button" class="speech-btn" id="speechSubmitBtn" style="background: #0284c7; color: white; display: none;">
          📤 Submit Final Assessment
        </button>
        <div class="speech-status">
          <div class="recording-dot" id="recordingDot"></div>
          <span id="speechStatusText">Ready to begin assessment</span>
        </div>
      </div>
      
      <button type="button" class="btn btn-success" id="submitEvaluation" style="background: var(--ok);">Submit Evaluation</button>
    </div>

    <!-- Speech Transcript Display -->
    <div class="speech-transcript" id="speechTranscript">
      <div class="transcript-final" id="transcriptFinal"></div>
      <div class="transcript-interim" id="transcriptInterim"></div>
    </div>
    <div class="speech-error" id="speechError"></div>

    <form id="evaluationForm">
      <div class="student-info">
        <div class="field">
          <label for="studentName">Student Being Evaluated 🔒</label>
          <input id="studentName" name="studentName" type="text" required readonly style="background-color: #f8f9fa; color: #495057; border: 2px solid #28a745; font-weight: bold;" />
          <small style="color: #28a745; font-size: 0.8em; margin-top: 4px; display: block;">✓ Locked to logged-in user</small>
        </div>
        <div class="field">
          <label for="evaluatorName">Evaluator Name</label>
          <input id="evaluatorName" name="evaluatorName" type="text" required />
        </div>
        <div class="field">
          <label for="evaluationDate">Date</label>
          <input id="evaluationDate" name="evaluationDate" type="date" required />
        </div>
        <div class="field">
          <label for="scenarioTime">Scenario Time</label>
          <input id="scenarioTime" name="scenarioTime" type="text" value="0700 (Breakfast at 0730)" />
        </div>
      </div>

      <div class="scenario-summary">
        <h3>Patient Case Summary</h3>
        <div class="patient-info">
          <strong>Patient:</strong> Shannon Shaw, 83 years old<br />
          <strong>Diagnosis:</strong> CHF (Congestive Heart Failure), Diabetes Type II<br />
          <strong>PMH:</strong> HTN, CHF, CAD, HLD, COPD, OSA, Asthma<br />
          <strong>Symptoms:</strong> Shortness of breath (SOB), increasing dyspnea at rest<br />
          <strong>Status:</strong> Alert, irritable, no difficulty swallowing<br />
          <strong>Allergies:</strong> NKA (No Known Allergies)<br />
          <strong>Time:</strong> 0700 (7am shift start), Breakfast at 0800
        </div>
      </div>

      <!-- Week 3 Medication Administration Evaluation Sections -->
      <div class="section" id="sec-sbar">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">SBAR Handoff & Admission</span>
          <span class="section-meta" data-count="sec-sbar"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sbar_situation" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sbar_situation" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">States Situation accurately: Shannon Shaw, 83-year-old male admitted with CHF and shortness of breath<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sbar_diagnosis" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sbar_diagnosis" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">States Primary Diagnoses: CHF (Congestive Heart Failure), Diabetes Type II</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sbar_background" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sbar_background" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">States Background/PMH: HTN, CHF, CAD, HLD, COPD, OSA, Asthma; NKA</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sbar_assessment_findings" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sbar_assessment_findings" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">States Assessment findings: Alert, irritable, no difficulty swallowing, increasing SOB even at rest<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sbar_vitals" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sbar_vitals" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Reports Vital Signs: T=97.0°F, P=80, R=28, Pain=0/10, O2 sat=98% on room air</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sbar_current_orders" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sbar_current_orders" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Reviews current medication orders and blood glucose monitoring requirements</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sbar_recommendation" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sbar_recommendation" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">States Recommendations: Monitor respiratory status, blood glucose levels, medication compliance, and CHF symptoms</div></div>
        </div>
      </div>

      <!-- Section helper template -->
      <div class="section" id="sec-begin">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Standard Protocol - Beginning</span>
          <span class="section-meta" data-count="sec-begin"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="verify_orders" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="verify_orders" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Verifies physician's orders (review orders on chart at bedside)<span class="critical-badge">CRITICAL</span></div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="gather_equipment" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="gather_equipment" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Gathers own equipment/supplies</div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="hand_hygiene_main" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="hand_hygiene_main" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Performs hand hygiene - Gel in gel out<span class="critical-badge">CRITICAL</span></div>
          </div>
        </div>
      </div>

      <div class="section" id="sec-during">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Standard Protocol - During</span>
          <span class="section-meta" data-count="sec-during"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="identify_client" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="identify_client" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Identifies client (check ID bracelet and ask name/DOB)<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="introduce_self" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="introduce_self" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Introduces self and explains plan</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="identify_teaching" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="identify_teaching" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Identifies teaching needed; describes what client can expect</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="assess_appropriateness" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="assess_appropriateness" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Assesses if intervention is still appropriate</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="adjust_bed" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="adjust_bed" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Adjusts bed height; lowers nearest side rail</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="lighting" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="lighting" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Provides adequate lighting</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="privacy" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="privacy" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Provides privacy (pull curtain)</div>
          </div>
        </div>
      </div>

      <div class="section" id="sec-medpass">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Medication Pass</span>
          <span class="section-meta" data-count="sec-medpass"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="check_mar_orders" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="check_mar_orders" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Checks MAR with the MD orders</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="check_pmh" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="check_pmh" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Checks PMH (past/present medical history) for appropriateness of ordered meds (states why taking med)</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="check_allergies" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="check_allergies" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Checks allergies (may ask client, find on MAR, find on Chart etc)</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="check_expiration" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="check_expiration" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Check expiration dates on meds (looks at med and states)</div>
          </div>

          <h4 style="margin:16px 0 8px; color: var(--muted);">First Check - At Testing Table</h4>
          <p style="margin: 4px 0 8px; color: var(--muted-2); font-size: 0.9rem;">6 Rights (during 1st check - must state/do each in any order)</p>
          
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_client_lasix" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_client_lasix" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Client - Lasix</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_drug_lasix" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_drug_lasix" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Drug - Lasix</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_dose_lasix" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_dose_lasix" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Dose - Lasix</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_route_lasix" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_route_lasix" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Route - Lasix</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_time_lasix" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_time_lasix" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Time - Lasix</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_doc_lasix" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_doc_lasix" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Documentation (must state will document after meds given/taken) - Lasix</div>
          </div>

          <!-- Repeat for KCL, Beclovent, NPH, Regular -->
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_client_kcl" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_client_kcl" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Client - KCL Elixir</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_drug_kcl" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_drug_kcl" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Drug - KCL Elixir</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_dose_kcl" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_dose_kcl" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Dose - KCL Elixir</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_route_kcl" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_route_kcl" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Route - KCL Elixir</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_time_kcl" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_time_kcl" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Time - KCL Elixir</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_doc_kcl" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_doc_kcl" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Documentation (must state will document after meds given/taken) - KCL Elixir</div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_client_beclovent" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_client_beclovent" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Client - Beclovent MDI</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_drug_beclovent" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_drug_beclovent" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Drug - Beclovent MDI</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_dose_beclovent" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_dose_beclovent" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Dose - Beclovent MDI</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_route_beclovent" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_route_beclovent" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Route - Beclovent MDI</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_time_beclovent" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_time_beclovent" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Time - Beclovent MDI</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_doc_beclovent" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_doc_beclovent" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Documentation (must state will document after meds given/taken) - Beclovent MDI</div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_client_nph" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_client_nph" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Client - NPH Insulin</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_drug_nph" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_drug_nph" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Drug - NPH Insulin</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_dose_nph" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_dose_nph" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Dose - NPH Insulin</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_route_nph" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_route_nph" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Route - NPH Insulin</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_time_nph" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_time_nph" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Time - NPH Insulin</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_doc_nph" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_doc_nph" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Documentation (must state will document after meds given/taken) - NPH Insulin</div>
          </div>

          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_client_regular" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_client_regular" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Client - Regular Insulin</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_drug_regular" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_drug_regular" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Drug - Regular Insulin</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_dose_regular" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_dose_regular" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Dose - Regular Insulin</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_route_regular" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_route_regular" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Route - Regular Insulin</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_time_regular" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_time_regular" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Time - Regular Insulin</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="first_check_doc_regular" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="first_check_doc_regular" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Documentation (must state will document after meds given/taken) - Regular Insulin</div>
          </div>

          <h4 style="margin:20px 0 8px; color: var(--muted);">Second Check - At Bedside Table</h4>
          <p style="margin: 4px 0 8px; color: var(--muted-2); font-size: 0.9rem;">6 Rights (during 2nd check - must state/do each in any order)</p>
          
          <!-- Second check for all 5 medications - Lasix -->
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="second_check_client_lasix" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="second_check_client_lasix" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Client - Lasix</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="second_check_drug_lasix" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="second_check_drug_lasix" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Drug - Lasix</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="second_check_dose_lasix" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="second_check_dose_lasix" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Dose - Lasix</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="second_check_route_lasix" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="second_check_route_lasix" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Route - Lasix</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="second_check_time_lasix" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="second_check_time_lasix" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Time - Lasix</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="second_check_doc_lasix" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="second_check_doc_lasix" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Documentation (must state will document after meds given/taken) - Lasix</div>
          </div>

          <!-- Continue pattern for KCL, Beclovent, NPH, Regular for second check -->
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="second_check_all_remaining" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="second_check_all_remaining" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Completes 6 Rights check for KCL Elixir, Beclovent MDI, NPH Insulin, Regular Insulin (Client, Drug, Dose, Route, Time, Documentation)</div>
          </div>

          <h4 style="margin:20px 0 8px; color: var(--muted);">Third Check - At Nightstand (Before Administration)</h4>
          <p style="margin: 4px 0 8px; color: var(--muted-2); font-size: 0.9rem;">6 Rights (during 3rd check - must state/do each in any order)</p>
          
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="third_check_client_armband" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="third_check_client_armband" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Client - Must look at arm band during this check (all 5 medications)<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="third_check_drug_all" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="third_check_drug_all" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Drug - All 5 medications (Lasix, KCL, Beclovent, NPH, Regular)</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="third_check_dose_all" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="third_check_dose_all" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Dose - All 5 medications</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="third_check_route_all" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="third_check_route_all" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Route - All 5 medications</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="third_check_time_all" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="third_check_time_all" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Time - All 5 medications</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="third_check_doc_all" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="third_check_doc_all" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Documentation (must state will document after meds given/taken) - All 5 medications</div>
          </div>
        </div>
      </div>

      <!-- Medication Knowledge and Administration Section -->
      <div class="section" id="sec-lasix">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Lasix 20mg - Knowledge & Administration</span>
          <span class="section-meta" data-count="sec-lasix"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="lasix_uses" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="lasix_uses" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Uses: Control of edema associated with history CHF and/or HTN</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="lasix_side_effects" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="lasix_side_effects" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Side effects: Hypotension, fluid and electrolyte imbalances (hypokalemia), polyuria, dizziness</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="lasix_assessments" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="lasix_assessments" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Assessments needed: Serum electrolyte (K+), BP, urinary output</div>
          </div>
        </div>
      </div>

      <!-- KCL Elixir Section -->
      <div class="section" id="sec-kcl">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">KCL 10% Elixir - Knowledge & Administration</span>
          <span class="section-meta" data-count="sec-kcl"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="kcl_uses" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="kcl_uses" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Uses: Treatment and prevention of hypokalemia</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="kcl_side_effects" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="kcl_side_effects" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Side effects: Hyperkalemia, ECG changes, muscle weakness, palpitation</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="kcl_assessments" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="kcl_assessments" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Assessments needed: Serum electrolyte (K+), ECG</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="kcl_correct_dosage" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="kcl_correct_dosage" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Correct med math for dosage</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="kcl_bottle_palm" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="kcl_bottle_palm" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Holds bottle with label to palm</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="kcl_cap_up" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="kcl_cap_up" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Opens and places cap facing up on surface</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="kcl_cup_flat" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="kcl_cup_flat" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Places med cup on a flat surface</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="kcl_eye_level" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="kcl_eye_level" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Pours correct dose at eye level</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="kcl_juice" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="kcl_juice" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">States would give in juice because of bitter taste</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="kcl_stay_with_client" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="kcl_stay_with_client" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Verbalizes would stay with client to ensure medication taken</div>
          </div>
        </div>
      </div>

      <!-- Beclovent MDI Section -->
      <div class="section" id="sec-beclovent">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Beclovent MDI - Knowledge & Administration</span>
          <span class="section-meta" data-count="sec-beclovent"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="beclovent_uses" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="beclovent_uses" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Uses: Control of bronchial asthma that requires corticosteroids along with other therapy</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="beclovent_onset" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="beclovent_onset" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Onset: 1-4 weeks</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="beclovent_side_effects" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="beclovent_side_effects" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Side effects: Oral/laryngeal/pharyngeal irritation, fungal infections</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="beclovent_assessments" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="beclovent_assessments" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Assessments needed: Respiratory auscultation, vital signs, signs/symptoms of systemic fungal infections (oral thrush)</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="beclovent_assemble" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="beclovent_assemble" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Correctly assembles MDI with spacer</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="beclovent_teach_technique" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="beclovent_teach_technique" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Teaches actor proper technique (Assemble spacer, remove dust cap, shake inhaler well, breath out to let air out of lung, squeeze inhaler into spacer, take deep breath from spacer, hold 5-10secs)</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="beclovent_puff_timing" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="beclovent_puff_timing" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">States at some point in teaching or demo: 1 puff - deep breaths - 2-5 minute between - 1 puff - deep breaths</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="beclovent_rinse_mouth" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="beclovent_rinse_mouth" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Verbalizes rinse mouth after each use to prevent infection/thrush (must state)<span class="critical-badge">CRITICAL</span></div>
          </div>
        </div>
      </div>

      <!-- Blood Glucose Monitoring and Sliding Scale Section -->
      <div class="section" id="sec-sliding-scale">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Blood Glucose Monitoring & Sliding Scale</span>
          <span class="section-meta" data-count="sec-sliding-scale"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="bg_checks_ac_hs" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="bg_checks_ac_hs" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Blood glucose checks AC & HS (ante cibum - before meals, hora somni - at bedtime)</div>
          </div>
          
          <h4 style="margin:12px 0 8px; color: var(--muted);">Sliding Scale Protocol</h4>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sliding_scale_under_150" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sliding_scale_under_150" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Blood Glucose < 150: No insulin</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sliding_scale_151_200" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sliding_scale_151_200" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Blood Glucose 151-200: + 2 Units Regular Insulin</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sliding_scale_201_250" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sliding_scale_201_250" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Blood Glucose 201-250: + 4 Units Regular Insulin</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sliding_scale_251_300" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sliding_scale_251_300" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Blood Glucose 251-300: + 6 Units Regular Insulin</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="sliding_scale_over_300" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="sliding_scale_over_300" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Blood Glucose Above 300: Call MD<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="current_fbs_check" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="current_fbs_check" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Checks current FBS (Fasting Blood Sugar) level and applies appropriate sliding scale</div>
          </div>
        </div>
      </div>

      <!-- Insulin Knowledge and Administration Section -->
      <div class="section" id="sec-insulin">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Insulin Administration - NPH & Regular</span>
          <span class="section-meta" data-count="sec-insulin"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <h4 style="margin:0 0 8px; color: var(--muted);">NPH Insulin Knowledge</h4>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="nph_uses" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="nph_uses" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">NPH Uses: Adult onset DM, juvenile DM, NIDDM, Type I DM</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="nph_onset" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="nph_onset" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">NPH Onset: 1-2 hours</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="nph_peak" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="nph_peak" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">NPH Peak: 4-6 hours</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="nph_duration" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="nph_duration" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">NPH Duration: More than 12-16 hours (may vary by individual)</div>
          </div>

          <h4 style="margin:12px 0 8px; color: var(--muted);">Regular Insulin Knowledge</h4>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="regular_uses" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="regular_uses" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Regular Uses: Adult onset DM, juvenile DM, NIDDM, Type I DM</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="regular_onset" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="regular_onset" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Regular Onset: ½ hour to 1 hour</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="regular_peak" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="regular_peak" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Regular Peak: 2 hours (2-4)</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="regular_duration" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="regular_duration" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Regular Duration: 6 hours (6-8)</div>
          </div>

          <h4 style="margin:12px 0 8px; color: var(--muted);">Insulin General Knowledge</h4>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_side_effects" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_side_effects" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Side effects: Blurred vision, dry mouth, rash, hypoglycemia, anaphylaxis</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_assessments" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_assessments" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Assessments needed: Monitor FBS, assess for hypoglycemia (sweating, weakness, confusion, chills, rapid and weak pulse); assess for hyperglycemia (acetone breath, polyuria, flushed and dry skin)</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_meal_ready" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_meal_ready" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Verbalizes that meal must be present and client ready to eat before administering<span class="critical-badge">CRITICAL</span></div>
          </div>

          <h4 style="margin:12px 0 8px; color: var(--muted);">Insulin Mixing Procedure</h4>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_syringe" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_syringe" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Selects correct syringe (Insulin) (Orange cap with units)</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_roll_nph" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_roll_nph" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Rolls NPH in hands (must do - cannot just state)<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_cleanse_vials" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_cleanse_vials" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Cleanses vial with alcohol (even brand new vials)</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_step1_nph_air" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_step1_nph_air" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Step 1: Injects 26 Units of air into NPH vial (cloudy) - (Must do and vial must be on surface)<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_step2_regular_air" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_step2_regular_air" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Step 2: Injects 16 Units air in Regular vial (clear) - (must do and vial must be on surface) [10u Regular + 6u sliding scale = 16u total]<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_step3_withdraw_regular" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_step3_withdraw_regular" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Step 3: Inverts insulin vial and withdraws Regular - (must do) 10u + 6u = 16u<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_step4_nph_surface" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_step4_nph_surface" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Step 4: Inserts needle into NPH with vial on surface - NOT INVERTED!!! (must do)<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_step5_withdraw_nph" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_step5_withdraw_nph" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Step 5: Withdraws NPH 26 Units to a total of 42 Units- (must do)<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_bubble_free" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_bubble_free" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Insulin drawn up is "bubble free" - few tiny champagne ok (must do)<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_verify_nurse" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_verify_nurse" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">MUST verify each of the 5 steps above with another nurse (license) - if does not = no bullet point<span class="critical-badge">CRITICAL</span></div>
          </div>

          <h4 style="margin:12px 0 8px; color: var(--muted);">Subcutaneous Insulin Administration</h4>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_draw_check2" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_draw_check2" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Draws up insulin during check #2 (must do)<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_safe_recap" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_safe_recap" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Safe recap of needle after draws up</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_don_gloves" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_don_gloves" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Dons Gloves - must really put on gloves and wear during injection!<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_ask_last_site" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_ask_last_site" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Asks Patient - where last insulin injection was placed</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_assess_site" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_assess_site" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">States would assess site - would assess skin for scars, lesions, redness etc.</div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_cleanse_site" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_cleanse_site" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Cleanses site 2 inch circular outward - must cleanse injections pad on actor abdomen<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_pinch_subcut" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_pinch_subcut" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Pinches subcutaneous - (must pinch injection pad)<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_insert_angle" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_insert_angle" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Inserts 90 degrees (pinch 2") or 45 degree (pinch 1") - must do one of these but state both!<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_inject_slowly" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_inject_slowly" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Injects slowly into injection pad on actors abdomen - (must do)<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_withdraw_release" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_withdraw_release" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Withdraws needle and releases pinch simultaneously (must do)<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_no_recap" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_no_recap" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Does NOT RECAP<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_safety_sharps" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_safety_sharps" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">States would activate safety and places into sharps container immediately - if the needle has a safety Must activate safety and sharps the needle (must do all or no bullet point)<span class="critical-badge">CRITICAL</span></div>
          </div>
          <div class="checklist-item">
            <div class="checkbox-container">
              <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="insulin_teach_hypoglycemia" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
              <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="insulin_teach_hypoglycemia" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
            </div>
            <div class="item-text">Teaches client about what to do for (BS <70-15gms carbs with examples) during procedure (must do) - Fruit juice ½ cup (4 ounces) - Regular soda ½ cup (6 ounces) - Milk 1 cup (8 ounces) - Honey or corn syrup, 3 teaspoons - crackers (6 saline crackers)<span class="critical-badge">CRITICAL</span></div>
          </div>
        </div>
      </div>

      <!-- Clinical Assessments Section -->
      <div class="section" id="sec-assessments">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Clinical Assessments</span>
          <span class="section-meta" data-count="sec-assessments"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <h4 style="margin:0 0 6px;color:var(--muted);">Assessment: Head / Face / Mouth / Mucous Membranes</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_head" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_head" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Head: Normocephalic, atraumatic, symmetrical, no masses or tenderness.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_hair" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_hair" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Hair: Evenly distributed, soft, appropriate thickness, color consistent with ethnicity; scalp clean without lesions or infestations.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_face" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_face" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Face: Symmetrical at rest and with movement; no drooping or involuntary movements.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_teeth" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_teeth" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Teeth: Intact and well maintained; no caries, plaque, or discoloration. Dentures/bridges fit well if present. Breath odor neutral.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_mucosa" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_mucosa" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Mucous membranes/gums: Moist, pink, intact; no ulcerations, swelling, or bleeding.</div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Assessment: Skin / Hair / Nails</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_skin_tone" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_skin_tone" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Skin tone/variations: Even pigmentation consistent with ethnicity; no jaundice, cyanosis, or abnormal discolorations.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_skin_temp" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_skin_temp" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Temperature/character: Warm, dry, equal bilaterally.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_texture" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_texture" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Texture: Smooth, soft, resilient; no rough patches.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_thickness" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_thickness" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Thickness: Uniform throughout, thicker only at palms and soles.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_turgor" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_turgor" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Turgor: Good elasticity; returns promptly; no tenting.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_vascularity" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_vascularity" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Vascularity: No ecchymosis, petechiae, or abnormal markings; tattoos noted if present.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_edema" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_edema" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Edema: None.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_lesions" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_lesions" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Lesions/moles/scars: No suspicious lesions; benign nevi only; scars well-healed.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_pressure" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_pressure" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Pressure signs: Skin intact; no erythema, breakdown, or ulceration.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_nails" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_nails" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Nails: Smooth, firm, pink nail beds; capillary refill <2 seconds; contour ≤160°, no clubbing.</div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Assessment: General Appearance</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_nutrition" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_nutrition" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">State of Nutrition: Well-nourished, weight proportionate for height and age; no signs of malnutrition.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_comfort" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_comfort" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Comfort Level: Resting comfortably; no signs of pain or distress.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_body_structure" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_body_structure" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Facial Features / Body Structure: Symmetrical features; body build proportional; posture erect or appropriate to position (bed, chair, or standing).</div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Assessment: Neurological System</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_orientation" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_orientation" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Level of Orientation: Alert and oriented ×3 (person, place, time). If limited, document A&Ox1 or x2.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_memory" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_memory" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Memory: Short- and long-term memory intact.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_motor" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_motor" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Motor Function: Purposeful, coordinated movements; follows commands; strength equal bilaterally.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_pupils" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_pupils" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Pupils: PERRLA (pupils equal, round, reactive to light and accommodation), brisk reaction.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_eom" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_eom" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Ocular Movements: Extraocular movements intact; no nystagmus.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_gcs" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_gcs" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Glasgow Coma Scale: 15/15.</div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Assessment: Psychological</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_facial_expression" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_facial_expression" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Facial Expression: Relaxed, appropriate; maintains eye contact; affect congruent with mood.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_mood_affect" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_mood_affect" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Mood / Affect: Calm, cooperative; appropriate to situation.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_speech" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_speech" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Speech: Clear, articulate, normal pace and rhythm.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_interaction" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_interaction" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Interaction: Engaged, responds appropriately; age-appropriate behavior.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_hygiene" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_hygiene" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Personal Hygiene: Clean, well-groomed; clothing appropriate for setting.</div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Assessment: Respiratory System (Thorax / Lungs)</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_resp_color" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_resp_color" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Color: Lips and mucous membranes pink; no cyanosis or pallor; no nasal flaring.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_chest_shape" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_chest_shape" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Chest Shape/Configuration: Symmetrical chest wall; AP diameter less than transverse diameter (1:2 ratio). No deformities.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_resp_effort" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_resp_effort" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Effort: Respirations even, unlabored; no use of accessory muscles.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_resp_quality_rate" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_resp_quality_rate" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Quality & Rate: Regular rhythm; rate within normal limits.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_resp_ausc" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_resp_ausc" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Auscultation: Breath sounds clear to auscultation bilaterally; no wheezes, rales (crackles), or rhonchi.</div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Assessment: Cardiovascular System</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_heart_rhythm" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_heart_rhythm" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Heart Rhythm: Regular rate and rhythm; no skipped beats.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_heart_rate" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_heart_rate" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Rate: Within normal limits (60–100 bpm for adults).</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_heart_sounds" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_heart_sounds" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Heart Sounds: Distinct S1 and S2; no extra sounds (S3, S4) or murmurs.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_peripheral_pulses" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_peripheral_pulses" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Peripheral Pulses: Palpable, equal, and symmetrical bilaterally; strength 2+.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_cardiac_edema" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_cardiac_edema" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Edema: None present.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_cap_refill" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_cap_refill" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Capillary Refill: Brisk, <2 seconds in fingers and toes.</div></div>
        </div>
      </div>

      <div class="section" id="sec-ending">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Standard Protocol - Ending</span>
          <span class="section-meta" data-count="sec-ending"></span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="comfort_position" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="comfort_position" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Assists client to position of comfort; organizes personal items within reach</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="call_light" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="call_light" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Client has call light and knows how to use it</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="rails_bed_low" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="rails_bed_low" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Raise side rails and lower bed to lowest position<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="dispose_supplies" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="dispose_supplies" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Dispose of used supplies and equipment properly</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="remove_gloves_end" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="remove_gloves_end" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Remove and dispose of gloves (if appropriate)</div></div>
          <div class="checklist-item"><div class="checkbox-container">
            <label class="checkbox-group"><input type="checkbox" class="checkbox pass" data-key="final_hh_end" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label>
            <label class="checkbox-group"><input type="checkbox" class="checkbox fail" data-key="final_hh_end" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label>
          </div><div class="item-text">Performs final hand hygiene<span class="critical-badge">CRITICAL</span></div></div>
        </div>
      </div>

      <div class="section" id="sec-notes">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)">
          <span class="section-title">Evaluation Notes</span>
          <span class="toggle-icon">▾</span>
        </button>
        <div class="section-content">
          <div class="notes">
            <div class="field"><label for="sbar_notes">SBAR Communication</label><textarea id="sbar_notes" placeholder="Document SBAR communication effectiveness..."></textarea></div>
            <div class="field"><label for="collaboration_notes">Collaboration</label><textarea id="collaboration_notes" placeholder="Note teamwork and collaboration skills..."></textarea></div>
            <div class="field"><label for="critical_thinking_notes">Critical Thinking</label><textarea id="critical_thinking_notes" placeholder="Observe critical thinking and clinical reasoning..."></textarea></div>
            <div class="field"><label for="clinical_judgment_notes">Clinical Judgment</label><textarea id="clinical_judgment_notes" placeholder="Evaluate clinical judgment and decision making..."></textarea></div>
            <div class="field"><label for="additional_notes">Additional Notes</label><textarea id="additional_notes" placeholder="Any other observations or feedback..."></textarea></div>
          </div>
        </div>
      </div>
    </form>

    <div class="scorebar">
      <div><strong>Completed:</strong> <span id="completedScore" class="pill primary">0 / 0</span></div>
      <div><strong>Failed:</strong> <span id="failedScore" class="pill fail">0</span></div>
      <div><strong>Critical Fails:</strong> <span id="criticalFailedScore" class="pill fail">0</span></div>
      <div><strong>Score:</strong> <span id="overallScore" class="pill score">0%</span></div>
      <div style="text-align:right; color: var(--muted-2); font-size: .9rem;">Progress auto-saves locally</div>
    </div>
  </div>

    <!-- Guided correction toast mount point -->
    <div id="guidedToastRoot" aria-live="assertive" style="z-index:1100;"></div>

  <!-- Login Modal -->
  <div id="loginModal" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  ">
    <div style="
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
    ">
      <h2 style="text-align: center; color: var(--primary); margin-bottom: 20px;">
        🏥 Student Sign-In
      </h2>
      <p style="text-align: center; color: var(--muted); margin-bottom: 25px;">
        Enter your full name and use the default password to access the evaluation
      </p>
      <form id="loginForm">
        <div style="margin-bottom: 20px;">
          <label for="loginStudentName" style="display: block; margin-bottom: 8px; font-weight: 600;">Student Name:</label>
          <input type="text" id="loginStudentName" required style="
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
          " placeholder="Enter your full name">
        </div>
        <div style="margin-bottom: 20px;">
          <label for="loginPassword" style="display: block; margin-bottom: 8px; font-weight: 600;">Password:</label>
          <input type="password" id="loginPassword" required placeholder="Enter institutional password" style="
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
          ">
          <small style="color: var(--muted); font-size: 12px; margin-top: 5px; display: block;">
            🔒 Use your institutional password
          </small>
        </div>
        <button type="submit" style="
          width: 100%;
          padding: 12px;
          background: var(--primary);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: background-color 0.3s;
        ">Start Evaluation</button>
      </form>
      <div id="loginError" style="
        color: var(--fail);
        text-align: center;
        margin-top: 15px;
        display: none;
        font-size: 14px;
      "></div>
    </div>
  </div>

  <!-- Connection Status -->
  <div id="connectionStatus" style="
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    z-index: 999;
    display: none;
  "></div>

  <!-- Speech-to-Text Module -->
  <script src="js/speech-to-text.js"></script>
  
  <script>
    // Subpath support when served behind Traefik at /N10LVoice
    const BASE_PATH = location.pathname.toLowerCase().startsWith('/n10lvoice/') ? '/N10LVoice' : '';
    const API_BASE = `${BASE_PATH}/api`;
    const SOCKET_PATH = `${BASE_PATH}/socket.io`;

    // Utilities
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const $  = (sel, root=document) => root.querySelector(sel);

    // Real-time Socket.IO functionality
    let socket = null;
    let sessionId = localStorage.getItem('studentSession');
    let studentName = localStorage.getItem('studentName');
    let evaluationStartTime = null;
    let reconnectAttempts = 0;
    let maxReconnectAttempts = 5;
    let reconnectInterval = null;
    let isManualDisconnect = false;

    // Check if student is already logged in with valid session
    // Auto-save form state during disconnections
    function saveFormState() {
      const formData = {
        evaluatorName: document.getElementById('evaluatorName')?.value || '',
        scenarioTime: document.getElementById('scenarioTime')?.value || '',
        additionalNotes: document.getElementById('additionalNotes')?.value || '',
        checkboxStates: {},
        timestamp: Date.now()
      };
      
      // Save all checkbox states
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        if (checkbox.id) {
          formData.checkboxStates[checkbox.id] = checkbox.checked;
        }
      });
      
      localStorage.setItem('evaluationFormState', JSON.stringify(formData));
    }

    function restoreFormState() {
      const savedState = localStorage.getItem('evaluationFormState');
      if (!savedState) return;
      
      try {
        const formData = JSON.parse(savedState);
        
        // Only restore if saved within last hour
        if (Date.now() - formData.timestamp > 60 * 60 * 1000) {
          localStorage.removeItem('evaluationFormState');
          return;
        }
        
        // Restore form fields
        if (formData.evaluatorName) {
          const field = document.getElementById('evaluatorName');
          if (field) field.value = formData.evaluatorName;
        }
        
        if (formData.scenarioTime) {
          const field = document.getElementById('scenarioTime');
          if (field) field.value = formData.scenarioTime;
        }
        
        if (formData.additionalNotes) {
          const field = document.getElementById('additionalNotes');
          if (field) field.value = formData.additionalNotes;
        }
        
        // Restore checkbox states
        Object.entries(formData.checkboxStates).forEach(([id, checked]) => {
          const checkbox = document.getElementById(id);
          if (checkbox) {
            checkbox.checked = checked;
          }
        });
        
        updateCounts();
        showSuccess('📋 Previous form data restored from auto-save');
        
      } catch (error) {
        console.error('Error restoring form state:', error);
        localStorage.removeItem('evaluationFormState');
      }
    }

    async function checkExistingSession() {
      if (sessionId && studentName) {
        try {
          const response = await fetch(`${API_BASE}/auth/validate-session`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId })
          });
          
          if (response.ok) {
            connectSocket();
            // Restore any saved form state after connecting
            setTimeout(restoreFormState, 1000);
            return;
          }
        } catch (error) {
          console.log('Session validation failed:', error);
        }
        
        // Clear invalid session
        localStorage.removeItem('studentSession');
        localStorage.removeItem('studentName');
        sessionId = null;
        studentName = null;
      }
      
      showLoginModal();
    }

    checkExistingSession();

    function showLoginModal() {
      document.getElementById('loginModal').style.display = 'flex';
    }

    function hideLoginModal() {
      document.getElementById('loginModal').style.display = 'none';
    }

    function updateConnectionStatus(status, attempts = 0) {
      const statusEl = document.getElementById('connectionStatus');
      statusEl.style.display = 'block';
      statusEl.style.color = 'white';
      
      switch (status) {
        case 'connected':
          statusEl.style.background = 'var(--pass)';
          statusEl.textContent = '🟢 Connected';
          break;
        case 'disconnected':
          statusEl.style.background = 'var(--fail)';
          statusEl.textContent = '� Disconnected';
          break;
        case 'reconnecting':
          statusEl.style.background = 'var(--warn)';
          statusEl.textContent = `🟡 Reconnecting... (${attempts}/${maxReconnectAttempts})`;
          break;
        case 'failed':
          statusEl.style.background = 'var(--fail)';
          statusEl.textContent = '🔴 Connection Failed - Click to Retry';
          statusEl.style.cursor = 'pointer';
          statusEl.onclick = () => attemptReconnection();
          break;
        default:
          statusEl.style.background = 'var(--muted)';
          statusEl.textContent = '⚪ Unknown Status';
      }
    }

    async function registerStudent(name) {
      const response = await fetch(`${API_BASE}/auth/register`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: name, password: 'student123', role: 'student' })
      });
      const data = await response.json();
      if (response.ok) return data.token;
      if (response.status === 409) return await loginStudent(name);
      throw new Error(data.error || 'Registration failed');
    }

    async function loginStudent(name) {
      const response = await fetch(`${API_BASE}/auth/login`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: name, password: 'student123' })
      });
      const data = await response.json();
      if (response.ok) return data.token;
      throw new Error(data.error || 'Login failed');
    }

    function connectSocket() {
      if (!studentName || !sessionId) return;
      
      console.log('🔌 Establishing robust student socket connection...');
      
      // Configure Socket.IO with enhanced reconnection settings
      socket = io({ 
        path: SOCKET_PATH, 
        auth: { sessionId: sessionId },
        timeout: 20000,
        reconnection: true,
        reconnectionAttempts: maxReconnectAttempts,
        reconnectionDelay: 2000,
        reconnectionDelayMax: 10000,
        maxReconnectionAttempts: maxReconnectAttempts,
        randomizationFactor: 0.5,
        forceNew: false
      });

      socket.on('connect', () => {
        console.log('✅ Connected to evaluation server');
        console.log('🔗 Socket ID:', socket.id);
        updateConnectionStatus('connected');
        reconnectAttempts = 0;
        clearInterval(reconnectInterval);
        
        // Save evaluation start time only on first connect
        if (!evaluationStartTime) {
          evaluationStartTime = new Date().toISOString();
        }
        
        // Initialize Speech-to-Text after socket connection
        console.log('🔗 Socket connected, initializing speech...');
        initializeSpeech();
        
        // Pre-fill and lock student name in form
        const studentNameField = document.getElementById('studentName');
        if (studentNameField) {
          studentNameField.value = studentName;
          studentNameField.readonly = true;
          studentNameField.style.backgroundColor = '#f8f9fa';
          studentNameField.style.color = '#495057';
          studentNameField.style.border = '2px solid #28a745';
          studentNameField.style.fontWeight = 'bold';
          studentNameField.title = '🔒 Locked to logged-in user: ' + studentName;
        }
        
        // Show success message if this was a reconnection
        if (reconnectAttempts > 0) {
          showSuccess('✅ Reconnected successfully! Your progress is preserved.');
        }
        
        // Start connection health monitoring
        startStudentConnectionHealthMonitoring();
      });

      socket.on('disconnect', (reason) => {
        console.log('❌ Disconnected from server:', reason);
        updateConnectionStatus('disconnected');
        stopStudentConnectionHealthMonitoring();
        
        // Only attempt reconnection if it wasn't a manual disconnect
        if (!isManualDisconnect && reason !== 'io client disconnect') {
          startReconnectionProcess();
        }
      });

      socket.on('reconnect_attempt', (attemptNumber) => {
        console.log(`Reconnection attempt ${attemptNumber}`);
        updateConnectionStatus('reconnecting', attemptNumber);
      });

      socket.on('reconnect_failed', () => {
        console.log('All reconnection attempts failed');
        updateConnectionStatus('failed');
        showError('❌ Connection lost. Click the status indicator to retry.');
      });

      socket.on('connect_error', (error) => {
        console.error('Connection error:', error);
        
        if (error.message === 'Authentication error' || error.message.includes('session')) {
          showError('🔐 Session expired. Please sign in again.');
          logout();
        } else {
          updateConnectionStatus('disconnected');
          if (!isManualDisconnect) {
            startReconnectionProcess();
          }
        }
      });

      // Add ping/pong for connection health monitoring
      socket.on('pong', (data) => {
        const pingTime = Date.now() - lastStudentPingTime;
        console.log(`🏓 Student pong received, latency: ${pingTime}ms`);
        updateConnectionStatus('connected');
      });

      socket.on('connect_timeout', () => {
        console.error('❌ Student socket connection timeout');
        updateConnectionStatus('timeout');
      });
    }

    function startReconnectionProcess() {
      if (reconnectInterval) return; // Already reconnecting
      
      reconnectInterval = setInterval(() => {
        reconnectAttempts++;
        console.log(`Manual reconnection attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
        updateConnectionStatus('reconnecting', reconnectAttempts);
        
        if (reconnectAttempts >= maxReconnectAttempts) {
          clearInterval(reconnectInterval);
          reconnectInterval = null;
          updateConnectionStatus('failed');
          return;
        }
        
        // Attempt to validate session and reconnect
        attemptReconnection();
      }, 3000);
    }

    async function attemptReconnection() {
      try {
        // First validate the session
        const response = await fetch(`${API_BASE}/auth/validate-session`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId })
        });
        
        if (response.ok) {
          // Session is valid, try to reconnect socket
          if (socket) {
            socket.disconnect();
          }
          connectSocket();
        } else {
          // Session expired
          showError('🔐 Your session has expired. Please sign in again.');
          logout();
        }
      } catch (error) {
        console.error('Reconnection failed:', error);
      }
    }

    function logout() {
      isManualDisconnect = true;
      clearInterval(reconnectInterval);
      reconnectInterval = null;
      
      localStorage.removeItem('studentSession');
      localStorage.removeItem('studentName');
      localStorage.removeItem('sessionExpires');
      sessionId = null;
      studentName = null;
      evaluationStartTime = null;
      reconnectAttempts = 0;
      
      if (socket) {
        socket.disconnect();
        socket = null;
      }
      
      isManualDisconnect = false;
      showLoginModal();
      updateConnectionStatus('disconnected');
    }

    function showError(message) {
      const errorEl = document.getElementById('loginError');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 5000);
    }

    function showSuccess(message) {
      // Create temporary success message
      const successEl = document.createElement('div');
      successEl.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        background: var(--pass); color: white; padding: 12px 20px;
        border-radius: 6px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      `;
      successEl.textContent = message;
      document.body.appendChild(successEl);
      
      setTimeout(() => {
        successEl.remove();
      }, 4000);
    }

  function sendProgressUpdate() {
      if (!socket || !socket.connected) return;

      const score = getCurrentScore();
      const items = getCurrentItems();
      
      socket.emit('evaluation-update', {
        score: score,
        items: items,
        timestamp: new Date().toISOString(),
        courseWeekId: 3,
        scenarioTitle: 'Week 3 - Medication Administration'
      });
    }

    function getCurrentScore() {
      let passed = 0, failed = 0, total = 0;
      
      $$('.checklist-item').forEach(item => {
        if (item.closest('.section')) {
          total++;
          const passCheckbox = item.querySelector('input.checkbox.pass[type="checkbox"]');
          const failCheckbox = item.querySelector('input.checkbox.fail[type="checkbox"]');
          
          if (passCheckbox && passCheckbox.checked) {
            passed++;
          } else if (failCheckbox && failCheckbox.checked) {
            failed++;
          }
          // Items with neither checked are just incomplete
        }
      });

      // Calculate percentage based on completed items (passed + failed) vs total items
      const completed = passed + failed;
      const percent = total > 0 ? Math.round((passed / total) * 100) : 0;
      
      return { passed, failed, total, percent };
    }

    function getCurrentItems() {
      const items = [];
      // Maintain per-section sequence counters for deterministic ordering
      const sectionSequenceCounters = {};

      $$('.section').forEach(section => {
        const sectionName = section.querySelector('.section-title')?.textContent?.trim() || 'Unknown Section';
        const checklistItems = $$('.checklist-item', section);
        if (!(sectionName in sectionSequenceCounters)) sectionSequenceCounters[sectionName] = 0;

        checklistItems.forEach((checklistItem) => {
          const seq = sectionSequenceCounters[sectionName]++;
          // Get the item text
            const itemTextDiv = checklistItem.querySelector('.item-text');
            const itemText = itemTextDiv ? itemTextDiv.textContent?.trim() : 'Unknown Item';

            // Check for PASS and FAIL checkboxes
            const passCheckbox = checklistItem.querySelector('input.checkbox.pass[type="checkbox"]');
            const failCheckbox = checklistItem.querySelector('input.checkbox.fail[type="checkbox"]');
            const isCritical = passCheckbox?.dataset.critical === 'true';

            let status = 'not_completed';
            let notes = 'Not completed';

            if (passCheckbox && passCheckbox.checked) {
              status = 'pass';
              notes = 'Passed - criteria met';
            } else if (failCheckbox && failCheckbox.checked) {
              status = 'fail';
              notes = 'Failed - criteria not met';
            }

            // Unique key stable with sequence
            const itemKey = `${sectionName.toLowerCase().replace(/\s+/g, '_')}_${seq}`;

            items.push({
              section: sectionName,
              item: itemText,
              key: itemKey,
              checked: status === 'pass',
              failed: status === 'fail',
              status: status,
              timestamp: new Date().toISOString(),
              notes: notes,
              sequence: seq,
              critical: isCritical
            });
        });
      });

      return items;
    }

    // =============== Guided Error Correction ===============
    let guidedQueue = [];
    let guidedIndex = 0;
    let guidedActive = false;

    function collectIncompleteItems() {
      const list = [];
      $$('.checklist-item').forEach(ci => {
        const pass = ci.querySelector('input.checkbox.pass');
        const fail = ci.querySelector('input.checkbox.fail');
        if (!pass || !fail) return;
        if (!pass.checked && !fail.checked) {
          list.push(ci);
        }
      });
      return list;
    }

    function ensureSectionVisible(item) {
      const section = item.closest('.section');
      if (!section) return;
      if (section.classList.contains('collapsed')) {
        const header = section.querySelector('.section-header');
        header?.setAttribute('aria-expanded','true');
        section.classList.remove('collapsed');
      }
      // Scroll with smooth center alignment
      setTimeout(()=>{
        item.scrollIntoView({ behavior:'smooth', block:'center'});
      }, 50);
    }

    function clearGuidedFocus() {
      $$('.checklist-item.incomplete-focus').forEach(el=> el.classList.remove('incomplete-focus'));
    }

    function showGuidedToast() {
      const root = $('#guidedToastRoot');
      if (!root) return;
      const remaining = guidedQueue.length - guidedIndex;
      const currentItem = guidedQueue[guidedIndex];
      if (!currentItem) { root.innerHTML=''; guidedActive=false; return; }
      const itemText = currentItem.querySelector('.item-text')?.textContent?.trim() || 'Checklist item';
      const pct = guidedQueue.length ? Math.round((guidedIndex)/guidedQueue.length*100) : 100;
      root.innerHTML = `
        <div class="guided-toast" role="dialog" aria-label="Incomplete checklist guidance">
          <button class="guided-close" onclick="cancelGuidedMode()" aria-label="Close">×</button>
          <h4>Complete All Items Before Submitting</h4>
          <div class="guided-progress">Item ${guidedIndex+1} of ${guidedQueue.length} • ${pct}% reviewed</div>
          <div class="guided-item-text">${itemText}</div>
          <div class="guided-actions">
            <button class="guided-btn pass" onclick="markGuided('pass')">✓ Pass</button>
            <button class="guided-btn fail" onclick="markGuided('fail')">✗ Fail</button>
            <button class="guided-btn next" onclick="skipGuided()" ${remaining<=1? 'disabled style=\"opacity:.4;cursor:not-allowed;\"':''}>Skip</button>
            <button class="guided-btn submit" onclick="resumeSubmission()" ${remaining>1? 'disabled':''}><span>Submit Now</span></button>
          </div>
        </div>`;
    }
    window.showGuidedToast = showGuidedToast;

    function startGuidedMode(onSubmitAfter=true) {
      guidedQueue = collectIncompleteItems();
      guidedIndex = 0;
      guidedActive = true;
      if (!guidedQueue.length) return false;
      focusCurrentGuided();
      showGuidedToast();
      return true;
    }
    window.startGuidedMode = startGuidedMode;

    function focusCurrentGuided() {
      clearGuidedFocus();
      const current = guidedQueue[guidedIndex];
      if (!current) return;
      current.classList.add('incomplete-focus');
      ensureSectionVisible(current);
    }

    function markGuided(mode) {
      const current = guidedQueue[guidedIndex];
      if (!current) return;
      const key = current.querySelector('input.checkbox.pass')?.getAttribute('data-key');
      if (mode==='pass') {
        const pass = current.querySelector('input.checkbox.pass');
        const fail = current.querySelector('input.checkbox.fail');
        if (pass) { pass.checked = true; fail && (fail.checked = false); }
        current.classList.add('checked'); current.classList.remove('failed');
      } else if (mode==='fail') {
        const pass = current.querySelector('input.checkbox.pass');
        const fail = current.querySelector('input.checkbox.fail');
        if (fail) { fail.checked = true; pass && (pass.checked = false); }
        current.classList.add('failed'); current.classList.remove('checked');
      }
      updateCounts();
      advanceGuided();
    }
    window.markGuided = markGuided;

    function skipGuided() {
      advanceGuided();
    }
    window.skipGuided = skipGuided;

    function advanceGuided() {
      guidedQueue = collectIncompleteItems();
      if (guidedQueue.length === 0) { completeGuided(); return; }
      if (guidedIndex >= guidedQueue.length) guidedIndex = 0; // wrap
      focusCurrentGuided();
      showGuidedToast();
    }

    function completeGuided() {
      clearGuidedFocus();
      guidedActive = false;
      const root = $('#guidedToastRoot');
      if (root) root.innerHTML = `<div class="guided-toast" style="background:#0f172a;">
        <h4>All items answered ✅</h4>
        <div style="font-size:.85rem; opacity:.85;">You can submit now.</div>
        <div class="guided-actions" style="margin-top:10px;">
          <button class="guided-btn submit" onclick="resumeSubmission()">Submit Evaluation</button>
          <button class="guided-btn next" onclick="cancelGuidedMode()">Close</button>
        </div>
      </div>`;
    }

    function cancelGuidedMode() {
      guidedActive = false;
      clearGuidedFocus();
      const root = $('#guidedToastRoot');
      if (root) root.innerHTML = '';
    }
    window.cancelGuidedMode = cancelGuidedMode;

    let pendingSubmitForce = false;
    function guardedSubmit(forceOverwrite=false) {
      const incompletes = collectIncompleteItems();
      if (incompletes.length) {
        // Start guided mode
        startGuidedMode();
        showGuidedToast();
        pendingSubmitForce = forceOverwrite;
        return; // Halt normal submission
      }
      // All good – proceed
      submitEvaluation(forceOverwrite);
    }

    function resumeSubmission() {
      // Re-check in case items still incomplete
      const incompletes = collectIncompleteItems();
      if (incompletes.length) {
        guidedQueue = incompletes; guidedIndex = 0; focusCurrentGuided(); showGuidedToast();
        return;
      }
      cancelGuidedMode();
      submitEvaluation(pendingSubmitForce);
    }
    window.resumeSubmission = resumeSubmission;

    async function submitEvaluation(forceOverwrite = false) {
      console.log('🚀 submitEvaluation called with forceOverwrite:', forceOverwrite);
      
      if (!socket || !socket.connected) {
        const retry = confirm(
          '🔌 Not connected to server.\n\n' +
          'Would you like to try reconnecting first?\n\n' +
          'Click OK to attempt reconnection, or Cancel to abort submission.'
        );
        
        if (retry) {
          showSuccess('🔄 Attempting to reconnect...');
          await attemptReconnection();
          
          // Wait a moment for reconnection
          await new Promise(resolve => setTimeout(resolve, 2000));
          
          if (!socket || !socket.connected) {
            alert('❌ Reconnection failed. Please refresh the page and try again.');
            return;
          } else {
            showSuccess('✅ Reconnected! Proceeding with submission...');
          }
        } else {
          return;
        }
      }

      const score = getCurrentScore();
      const items = getCurrentItems();
      const notes = {
        additionalNotes: document.getElementById('additionalNotes')?.value || '',
        evaluatorName: document.getElementById('evaluatorName')?.value || '',
        scenarioTime: document.getElementById('scenarioTime')?.value || ''
      };

      // Check for duplicate evaluations first (unless forcing overwrite)
      if (!forceOverwrite) {
        try {
          console.log('🔍 Checking for duplicate evaluation for:', studentName);
          console.log('🌐 API Base URL:', API_BASE);
          console.log('📝 Request payload:', { studentName: studentName, courseWeekId: 3 });
          
          const duplicateResponse = await fetch(`${API_BASE}/evaluations/check-duplicate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              studentName: studentName, 
              courseWeekId: 3 
            })
          });
          
          console.log('📡 Duplicate check response status:', duplicateResponse.status);
          
          if (!duplicateResponse.ok) {
            console.error('❌ Duplicate check failed with status:', duplicateResponse.status);
            throw new Error(`HTTP ${duplicateResponse.status}`);
          }
          
          const duplicateData = await duplicateResponse.json();
          console.log('📊 Duplicate check result:', duplicateData);
          
          if (duplicateData.duplicate) {
            const existing = duplicateData.existingEvaluation;
            const existingDate = new Date(existing.completedAt).toLocaleDateString();
            const existingTime = new Date(existing.completedAt).toLocaleTimeString();
            
            const overwrite = confirm(
              `⚠️ DUPLICATE EVALUATION DETECTED\n\n` +
              `Student "${studentName}" already has an evaluation for Medication Administration:\n\n` +
              `• Previous Score: ${existing.score}%\n` +
              `• Completed: ${existingDate} at ${existingTime}\n\n` +
              `Do you want to OVERWRITE the previous evaluation?\n\n` +
              `Click OK to overwrite, or Cancel to keep the existing evaluation.`
            );
            
            if (!overwrite) {
              alert('Evaluation submission cancelled. Previous evaluation preserved.');
              return;
            }
            
            // User confirmed overwrite, proceed with forced submission
            return submitEvaluation(true);
          }
        } catch (error) {
          console.error('❌ Error checking for duplicates:', error);
          alert(`⚠️ Duplicate check failed: ${error.message}\n\nPlease check the console for details.`);
          const proceed = confirm(
            'Unable to check for duplicate evaluations.\n\n' +
            'Do you want to proceed with submission anyway?'
          );
          if (!proceed) return;
        }
      }

      // Send completion event to server
      console.log('📡 Emitting evaluation-complete with overwrite:', forceOverwrite);
      
      socket.emit('evaluation-complete', {
        courseWeekId: 3, // Week 3 - Medication Administration Evaluation
        courseName: 'Medication Administration Evaluation',
        score: score,
        items: items,
        notes: notes,
        evaluatorName: notes.evaluatorName,
        scenarioTime: notes.scenarioTime,
        startTime: evaluationStartTime,
        endTime: new Date().toISOString(),
        overwrite: forceOverwrite
      });

      // Clear auto-saved form state after successful submission
      localStorage.removeItem('evaluationFormState');
      
      alert(`Evaluation completed!\nScore: ${score.percent}% (${score.passed}/${score.total})`);
    }

    // Login form handler
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('loginStudentName').value.trim();
      const password = document.getElementById('loginPassword').value;
      if (!name) { showError('Please enter your name'); return; }
      if (!password) { showError('Password is required'); return; }
      const prevName = localStorage.getItem('studentName');
      try {
        const response = await fetch(`${API_BASE}/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: name, password: password }) });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Login failed');
        if (data.sessionId && data.studentName) {
          // Clear previous student's data BEFORE overwriting localStorage
          clearWeek3ProgressForNewStudent(data.studentName);
          studentName = data.studentName;
          sessionId = data.sessionId;
          localStorage.setItem('studentName', data.studentName);
            localStorage.setItem('studentSession', data.sessionId);
          localStorage.setItem('sessionExpires', data.expiresAt);
          hideLoginModal();
          connectSocket();
        } else {
          throw new Error('Login failed - no session created');
        }
      } catch (error) {
        showError(error.message || 'Failed to sign in');
      }
    });

    // --- New Student Login Clearing Logic ---
    function clearWeek3ProgressForNewStudent(newName){
      const prev = localStorage.getItem('studentName');
      if(prev && prev.trim().toLowerCase() !== newName.trim().toLowerCase()){
        // Remove stored states relevant to Week 3 / Medication Administration
        localStorage.removeItem('n10l_med_eval_state');
        localStorage.removeItem('evaluationFormState');
        // Reset checklist UI
        $$('.checklist-item').forEach(ci=>{
          ci.classList.remove('checked','failed');
          ci.querySelectorAll('input[type="checkbox"]').forEach(c=> c.checked = false);
        });
        // Clear evaluator name (studentName stays locked to new login)
        const evaluatorField = document.getElementById('evaluatorName');
        if(evaluatorField) evaluatorField.value='';
        updateCounts();
        showSuccess('Previous student data cleared');
      }
    }

  // Removed delayed clearing listener – clearing now handled synchronously in login handler.

    // --- Switch Student / Logout Feature (Week 3) ---
    function switchStudent(){
      if(!confirm('Switch student? This will clear current progress.')) return;
      try { if(socket) socket.disconnect(); } catch(e){}
      // Clear global session identifiers
      localStorage.removeItem('studentSession');
      localStorage.removeItem('studentName');
      // Clear week-specific stored state
      localStorage.removeItem('n10l_med_eval_state');
      localStorage.removeItem('evaluationFormState');
      // Reset in‑memory vars
      sessionId=null; studentName=null; evaluationStartTime=null;
      // Clear UI selections
      $$('.checklist-item').forEach(ci=>{ ci.classList.remove('checked','failed'); ci.querySelectorAll('input[type="checkbox"]').forEach(c=> c.checked=false); });
      const evalField=$('#evaluatorName'); if(evalField) evalField.value='';
      // Show login modal again
      if(typeof showLoginModal==='function') showLoginModal(); else document.getElementById('loginModal').style.display='flex';
      showSuccess('Student session cleared. Ready for new login.');
    }
    // Attach listener after DOM ready if button exists
    document.addEventListener('DOMContentLoaded',()=>{ const btn=document.getElementById('switchStudent'); if(btn) btn.addEventListener('click',switchStudent); });

    function toggleSection(btn) {
      const section = btn.closest('.section');
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', String(!expanded));
      section.classList.toggle('collapsed', expanded);
    }

    function updateCounts() {
      // Per-section counts
      $$('.section').forEach(sec => {
        const content = $('.section-content', sec);
        if (!content) return;
        const items = $$('.checklist-item', content);
        const passed = items.filter(x => x.classList.contains('checked')).length;
        const failed = items.filter(x => x.classList.contains('failed')).length;
        const metaSpan = $('[data-count]', sec);
        if (metaSpan) metaSpan.textContent = `${passed}✓ / ${failed}✗ of ${items.length}`;
      });

      // Overall
      const allItems = $$('.checklist-item');
      const passed = allItems.filter(x => x.classList.contains('checked')).length;
  const failed = allItems.filter(x => x.classList.contains('failed')).length;
  const total  = allItems.length;
  const criticalFailed = allItems.filter(x => x.classList.contains('failed') && x.querySelector('input.checkbox.pass[data-critical="true"]')).length;
      const pct = total ? Math.round((passed / total) * 100) : 0;
      $('#completedScore').textContent = `${passed} / ${total}`;
      $('#failedScore').textContent = `${failed}`;
  const critEl = $('#criticalFailedScore');
  if (critEl) critEl.textContent = criticalFailed;
      const scoreEl = $('#overallScore');
      scoreEl.textContent = `${pct}%`;
      scoreEl.style.background = pct >= 90 ? 'var(--ok)' : (pct >= 75 ? 'var(--warn)' : 'var(--fail)');

      // Progress bar
      const completed = passed + failed;
      const progressPct = total ? (completed / total) * 100 : 0;
      $('#progressFill').style.width = progressPct + '%';

      // Send real-time update to admin dashboard
      sendProgressUpdate();
    }

    function handleToggle(e) {
      const input = e.target;
      if (!(input instanceof HTMLInputElement)) return;
      if (!input.classList.contains('checkbox')) return;
      const item = input.closest('.checklist-item');
      const isFail = input.hasAttribute('data-fail');
      const key = input.getAttribute('data-key') || '';

      // Mutually exclusive pass/fail
      const siblings = $$(`input[data-key="${key}"]`, item);
      siblings.forEach(s => { if (s !== input) s.checked = false; });

      if (input.checked) {
        if (isFail) {
          item.classList.add('failed');
          item.classList.remove('checked');
        } else {
          item.classList.add('checked');
          item.classList.remove('failed');
        }
      } else {
        item.classList.remove('checked', 'failed');
      }

      saveState();
      updateCounts();
    }

    function resetFormHard() {
      if (!confirm('Reset the entire form? This cannot be undone.')) return;
      $('#evaluationForm').reset();
      $$('.checklist-item').forEach(i => i.classList.remove('checked','failed'));
      // Clear local storage state
      localStorage.removeItem('n10l_med_eval_state');
      updateCounts();
    }

    function saveState() {
      const state = {
        studentName: $('#studentName').value,
        evaluatorName: $('#evaluatorName').value,
        evaluationDate: $('#evaluationDate').value,
        scenarioTime: $('#scenarioTime').value,
        notes: {
          sbar: $('#sbar_notes').value,
          collab: $('#collaboration_notes').value,
          crit: $('#critical_thinking_notes').value,
          clinical: $('#clinical_judgment_notes').value,
          add: $('#additional_notes').value
        },
        items: $$('.checklist-item').map(item => {
          // derive first input data-key for an id
          const passInput = $('input.checkbox.pass', item);
          const key = passInput ? passInput.getAttribute('data-key') : undefined;
          return { key, checked: item.classList.contains('checked'), failed: item.classList.contains('failed') };
        })
      };
      localStorage.setItem('n10l_med_eval_state', JSON.stringify(state));
    }

    function loadState() {
      const raw = localStorage.getItem('n10l_med_eval_state');
      if (!raw) return;
      try {
        const state = JSON.parse(raw);
        if (state.studentName) $('#studentName').value = state.studentName;
        if (state.evaluatorName) $('#evaluatorName').value = state.evaluatorName;
        if (state.evaluationDate) $('#evaluationDate').value = state.evaluationDate;
        if (state.scenarioTime) $('#scenarioTime').value = state.scenarioTime;
        if (state.notes) {
          $('#sbar_notes').value = state.notes.sbar || '';
          $('#collaboration_notes').value = state.notes.collab || '';
          $('#critical_thinking_notes').value = state.notes.crit || '';
          $('#clinical_judgment_notes').value = state.notes.clinical || '';
          $('#additional_notes').value = state.notes.add || '';
        }
        if (Array.isArray(state.items)) {
          state.items.forEach(entry => {
            if (!entry || !entry.key) return;
            const item = $(`.checklist-item input[data-key="${entry.key}"]`)?.closest('.checklist-item');
            if (!item) return;
            const pass = $('input.checkbox.pass', item);
            const fail = $('input.checkbox.fail', item);
            if (entry.failed) {
              if (fail) fail.checked = true;
              if (pass) pass.checked = false;
              item.classList.add('failed');
              item.classList.remove('checked');
            } else if (entry.checked) {
              if (pass) pass.checked = true;
              if (fail) fail.checked = false;
              item.classList.add('checked');
              item.classList.remove('failed');
            } else {
              if (pass) pass.checked = false;
              if (fail) fail.checked = false;
              item.classList.remove('checked','failed');
            }
          });
        }
      } catch {}
    }

    // Speech-to-Text Integration
    let speechToText = null;
    let assessmentSessionId = null; // Persistent session for entire assessment
    let speechSegmentCount = 0; // Track speech segments within session

    // Test speech recognition connectivity
    async function testSpeechConnectivity() {
      console.log('🧪 Testing speech recognition connectivity...');
      
      const results = {
        webSpeechSupported: false,
        secureContext: window.isSecureContext,
        protocol: window.location.protocol,
        online: navigator.onLine,
        userAgent: navigator.userAgent.substring(0, 50),
        canCreateRecognition: false
      };
      
      try {
        // Test if Web Speech API is supported
        results.webSpeechSupported = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
        
        // Test if we can create a recognition instance
        if (results.webSpeechSupported) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          const testRecognition = new SpeechRecognition();
          results.canCreateRecognition = true;
          
          // Test basic configuration
          testRecognition.continuous = false;
          testRecognition.interimResults = false;
          testRecognition.lang = 'en-US';
        }
        
      } catch (error) {
        console.error('Speech recognition test failed:', error);
        results.error = error.message;
      }
      
      console.log('🔍 Speech connectivity test results:', results);
      return results;
    }

    function initializeSpeech() {
      // Run connectivity test first
      testSpeechConnectivity();
      
      // Check if browser supports Web Speech API
      if (!SpeechToText.isSupported()) {
        console.warn('Web Speech API not supported in this browser');
        // Hide speech controls
        const speechControls = document.querySelector('.speech-controls');
        if (speechControls) {
          speechControls.style.display = 'none';
        }
        return;
      }

      // Initialize speech-to-text instance
      console.log('🎤 Initializing SpeechToText with socket:', {
        socketConnected: socket?.connected,
        socketId: socket?.id,
        enableRealtime: true
      });
      
      if (!socket || !socket.connected) {
        console.error('❌ Cannot initialize SpeechToText: Socket not connected');
        return;
      }
      
      speechToText = new SpeechToText({
        continuous: true,
        interimResults: true,
        language: 'en-US',
        autoSave: true,
        saveInterval: 10000, // Save every 10 seconds
        apiBaseUrl: API_BASE, // Use the same API base as other requests
        enableRealtime: true, // Enable real-time Socket.IO streaming
        socket: socket // Pass the socket instance for real-time communication
      });

      console.log('✅ SpeechToText initialized successfully with socket:', socket.id);

      // Set up event handlers
      speechToText.onStart = () => {
        console.log('Speech recognition started');
        updateSpeechUI(true);
      };

      speechToText.onStop = () => {
        console.log('Speech recognition stopped');
        updateSpeechUI(false);
      };

      speechToText.onResult = (results) => {
        updateTranscriptDisplay(results.final, results.interim);
      };

      speechToText.onError = (error) => {
        console.error('🚨 Speech recognition error in PersonalCare:', {
          error: error.error,
          message: error.message,
          details: error.details,
          timestamp: new Date().toISOString()
        });
        
        // Show user-friendly error message
        let displayMessage = error.message;
        
        // Special handling for network errors
        if (error.error === 'network') {
          displayMessage = `Speech recognition network error. This usually happens when:\n\n• Internet connection is unstable\n• Browser can't reach Google's speech servers\n• Firewall is blocking speech recognition\n\nPlease check your connection and try again.`;
        }
        
        showSpeechError(displayMessage);
        updateSpeechUI(false);
        
        // Log additional debugging info
        console.log('🔍 Speech error debugging info:', {
          userAgent: navigator.userAgent,
          isOnline: navigator.onLine,
          isSecureContext: window.isSecureContext,
          protocol: window.location.protocol,
          href: window.location.href
        });
      };

      speechToText.onSave = (result) => {
        if (result.success) {
          console.log('Transcript saved successfully');
        } else {
          console.error('Failed to save transcript:', result.error);
        }
      };

      // Set up button event handlers
      const startBtn = document.getElementById('speechStartBtn');
      const stopBtn = document.getElementById('speechStopBtn');
      const saveBtn = document.getElementById('speechSaveBtn');
      const submitBtn = document.getElementById('speechSubmitBtn');

      if (startBtn) {
        startBtn.addEventListener('click', startSpeechRecognition);
      }

      if (stopBtn) {
        stopBtn.addEventListener('click', stopSpeechRecognition);
      }

      if (saveBtn) {
        saveBtn.addEventListener('click', saveSpeechTranscript);
      }

      if (submitBtn) {
        submitBtn.addEventListener('click', submitSpeechTranscript);
      }

      // Request microphone permission on first load
      SpeechToText.requestPermission().then(granted => {
        if (!granted) {
          showSpeechError('Microphone access denied. Please allow microphone access to use speech recognition.');
        }
      });
    }

    function startSpeechRecognition() {
      if (!speechToText) return;

      // Generate assessment session ID if this is the first recording of the assessment
      if (!assessmentSessionId) {
        assessmentSessionId = `assessment-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        speechSegmentCount = 0;
        console.log('Starting new assessment session:', assessmentSessionId);
      }

      // Increment speech segment for this assessment
      speechSegmentCount++;

      const sessionData = {
        sessionId: assessmentSessionId, // Use persistent assessment session ID
        studentName: document.getElementById('studentName')?.value || 'Unknown',
        courseId: 3, // Medication Administration course
        segmentNumber: speechSegmentCount,
        segmentStartTime: new Date()
      };

      console.log('🎯 Starting speech recognition with session data:', sessionData);
      console.log('🔌 Socket connection status:', {
        connected: socket?.connected,
        socketId: socket?.id
      });

      const success = speechToText.start(sessionData);
      if (!success) {
        showSpeechError('Failed to start speech recognition. Please try again.');
      }
    }

    function stopSpeechRecognition() {
      if (!speechToText) return;

      const success = speechToText.stop();
      if (!success) {
        showSpeechError('Failed to stop speech recognition.');
      }
    }

    function updateSpeechUI(isRecording) {
      const startBtn = document.getElementById('speechStartBtn');
      const stopBtn = document.getElementById('speechStopBtn');
      const saveBtn = document.getElementById('speechSaveBtn');
      const submitBtn = document.getElementById('speechSubmitBtn');
      const statusText = document.getElementById('speechStatusText');
      const recordingDot = document.getElementById('recordingDot');

      if (startBtn && stopBtn && saveBtn && submitBtn && statusText && recordingDot) {
        if (isRecording) {
          startBtn.style.display = 'none';
          stopBtn.style.display = 'flex';
          saveBtn.style.display = 'flex';
          submitBtn.style.display = 'none';
          statusText.textContent = 'Recording...';
          recordingDot.classList.add('active');
        } else {
          startBtn.style.display = 'flex';
          stopBtn.style.display = 'none';
          
          // Show save/submit buttons if there's transcript content
          const hasTranscript = speechToText && speechToText.getTranscripts().final.trim().length > 0;
          saveBtn.style.display = hasTranscript ? 'flex' : 'none';
          submitBtn.style.display = hasTranscript ? 'flex' : 'none';
          
          statusText.textContent = hasTranscript ? 'Ready to save or submit' : 'Ready to record';
          recordingDot.classList.remove('active');
        }
      }
    }

    async function saveSpeechTranscript() {
      if (!speechToText) return;

      try {
        const result = await speechToText.save();
        if (result) {
          showSpeechSuccess('Transcript saved successfully');
          console.log('Manual save completed');
        }
      } catch (error) {
        console.error('Save failed:', error);
        showSpeechError('Failed to save transcript: ' + error.message);
      }
    }

    async function submitSpeechTranscript() {
      if (!speechToText) return;

      // Confirm submission
      const transcript = speechToText.getTranscripts().final.trim();
      if (!transcript) {
        showSpeechError('No transcript to submit');
        return;
      }

      const confirmed = confirm(`Submit this transcript?\n\nPreview: "${transcript.substring(0, 100)}${transcript.length > 100 ? '...' : ''}"`);
      if (!confirmed) return;

      try {
        const result = await speechToText.submit();
        if (result) {
          showSpeechSuccess('Transcript submitted successfully');
          console.log('Final submission completed for assessment session:', assessmentSessionId);
          
          // Clear assessment session - this ends the assessment recording
          assessmentSessionId = null;
          speechSegmentCount = 0;
          
          // Clear transcript after successful submission
          speechToText.clear();
          updateTranscriptDisplay('', '');
          updateSpeechUI(false);
        }
      } catch (error) {
        console.error('Submit failed:', error);
        showSpeechError('Failed to submit transcript: ' + error.message);
      }
    }

    function showSpeechSuccess(message) {
      const errorDiv = document.getElementById('speechError');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.background = '#dcfce7';
        errorDiv.style.color = '#166534';
        errorDiv.style.border = '1px solid #bbf7d0';
        errorDiv.classList.add('visible');
        
        setTimeout(() => {
          errorDiv.classList.remove('visible');
        }, 3000);
      }
    }

    function updateTranscriptDisplay(finalText, interimText) {
      const transcriptDiv = document.getElementById('speechTranscript');
      const finalDiv = document.getElementById('transcriptFinal');
      const interimDiv = document.getElementById('transcriptInterim');

      if (transcriptDiv && finalDiv && interimDiv) {
        // Show transcript area if there's content
        if (finalText || interimText) {
          transcriptDiv.classList.add('visible');
        }

        finalDiv.textContent = finalText;
        interimDiv.textContent = interimText;

        // Auto-scroll to bottom
        transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
      }
    }

    // Student Connection Health Monitoring
    let studentHealthTimer = null;
    let lastStudentPingTime = null;
    const STUDENT_PING_INTERVAL = 30000; // 30 seconds
    const STUDENT_PING_TIMEOUT = 10000; // 10 seconds

    function startStudentConnectionHealthMonitoring() {
      stopStudentConnectionHealthMonitoring(); // Clear any existing timer
      
      studentHealthTimer = setInterval(() => {
        if (socket && socket.connected) {
          sendStudentPing();
        } else {
          console.warn('⚠️ Student socket not connected during health check');
          updateConnectionStatus('disconnected');
          
          // Attempt reconnection
          if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`🔄 Student health check reconnection attempt ${reconnectAttempts}`);
            connectSocket();
          }
        }
      }, STUDENT_PING_INTERVAL);
    }

    function stopStudentConnectionHealthMonitoring() {
      if (studentHealthTimer) {
        clearInterval(studentHealthTimer);
        studentHealthTimer = null;
      }
    }

    function sendStudentPing() {
      if (socket && socket.connected) {
        lastStudentPingTime = Date.now();
        socket.emit('ping', { 
          timestamp: lastStudentPingTime, 
          type: 'student-health-check',
          studentName: studentName,
          sessionId: sessionId
        });
        
        // Set timeout to detect ping failures
        setTimeout(() => {
          if (lastStudentPingTime && (Date.now() - lastStudentPingTime) > STUDENT_PING_TIMEOUT) {
            console.warn('⚠️ Student ping timeout - connection may be unstable');
            updateConnectionStatus('unstable');
          }
        }, STUDENT_PING_TIMEOUT);
      }
    }

    function showSpeechError(message) {
      const errorDiv = document.getElementById('speechError');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.add('visible');
        
        // Hide error after 5 seconds
        setTimeout(() => {
          errorDiv.classList.remove('visible');
        }, 5000);
      }
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      // Pre-fill date to today if empty
      const today = new Date().toISOString().slice(0,10);
      const dateEl = $('#evaluationDate');
      if (!dateEl.value) dateEl.value = today;

      // Load saved state (if any)
      loadState();

      // Listeners
      document.body.addEventListener('change', handleToggle);
      $('#resetForm').addEventListener('click', resetFormHard);
      $('#submitEvaluation').addEventListener('click', (e) => {
        console.log('🔘 Submit button clicked');
        e.preventDefault();
        guardedSubmit();
      });
      $('#expandAll').addEventListener('click', () => $$('.section').forEach(s => { s.classList.remove('collapsed'); $('.section-header', s)?.setAttribute('aria-expanded','true'); }));
      $('#collapseAll').addEventListener('click', () => $$('.section').forEach(s => { s.classList.add('collapsed'); $('.section-header', s)?.setAttribute('aria-expanded','false'); }));

      // Update counts initially and on typing for notes/fields
      updateCounts();
      $$('input, textarea').forEach(el => el.addEventListener('input', () => { 
        saveState(); 
        saveFormState(); // Auto-save for disconnection recovery
      }));
      
      // Auto-save on checkbox changes
      $$('input[type="checkbox"]').forEach(el => el.addEventListener('change', () => {
        saveFormState();
      }));
      
      // Auto-save every 30 seconds
      setInterval(saveFormState, 30000);
      
      // Note: Speech-to-Text will be initialized after socket connection
    });
  </script>
</body>
</html>
