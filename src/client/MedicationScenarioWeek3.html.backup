<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>NURS 10L - Week 3 Medication Administration</title>
  <script src="/N10L/socket.io/socket.io.js"></script>
  <style>
    :root {
      --bg: #f5f7fa; --card:#ffffff; --muted:#4a5568; --muted-2:#718096; --primary:#667eea; --primary-2:#5a67d8; --accent:#764ba2; --pass:#48bb78; --fail:#e53e3e; --ok:#38a169; --warn:#d69e2e; --border:#e2e8f0;
    }
    *{box-sizing:border-box;} html{font-size:clamp(18px,5vw,20px);} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Helvetica Neue',Arial,sans-serif;background:var(--bg);color:#2d3748;line-height:1.55;padding:10px;-webkit-text-size-adjust:100%;}
    .container{max-width:1000px;margin:0 auto;background:var(--card);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,0.08);display:flex;flex-direction:column;min-height:calc(100vh - 20px);overflow:hidden;}
    .header{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;padding:18px 20px 16px;text-align:center;}
    .header h1{margin:0 0 6px;font-size:clamp(1.35rem,5.3vw,1.85rem);} .header p{margin:0;opacity:.95;font-size:1rem;}
    .progress-bar{height:10px;background:rgba(255,255,255,0.25);border-radius:6px;overflow:hidden;margin-top:12px;} .progress-fill{height:100%;width:0;background:linear-gradient(90deg,#fff,#d6d6ff);transition:width .25s ease;}
    .toolbar{display:flex;gap:10px;padding:12px 16px;border-bottom:1px solid var(--border);flex-wrap:wrap;background:#fafbff;}
    .btn{padding:14px 16px;border:0;border-radius:8px;font-weight:600;font-size:1.05rem;cursor:pointer;transition:background .2s ease,transform .05s ease;min-height:48px;}
    .btn:active{transform:translateY(1px);} .btn-primary{background:var(--primary);color:#fff;} .btn-primary:hover{background:var(--primary-2);} .btn-secondary{background:#e2e8f0;color:var(--muted);} .btn-secondary:hover{background:#cbd5e0;}
    form{width:100%;}
    .student-info{padding:16px;background:#f8f9ff;border-bottom:1px solid var(--border);display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;}
    .field label{display:block;font-weight:600;color:var(--muted);margin-bottom:6px;font-size:1rem;} .field input,.field textarea{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:10px;font-size:1.05rem;background:#fff;}
    .field input:focus,.field textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(102,126,234,.15);} .scenario-summary{padding:16px;background:#fff7db;border-left:4px solid #f6c343;}
    .scenario-summary h3{margin:0 0 8px;color:#7a5d00;} .patient-info{background:#fff;padding:12px;border:1px solid #fde3a7;border-radius:8px;font-size:.95rem;}
    .section{border-bottom:1px solid var(--border);} .section:last-of-type{border-bottom:0;}
    .section-header{width:100%;text-align:left;padding:14px 16px;background:#f7fafc;border:0;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;cursor:pointer;gap:10px;min-height:48px;}
    .section-title{margin:0;font-size:1.18rem;font-weight:700;color:#2d3748;} .section-meta{color:var(--muted-2);font-size:.95rem;margin-left:auto;margin-right:10px;} .toggle-icon{font-size:1.05rem;opacity:.8;}
    .section-content{padding:16px;} .section.collapsed .section-content{display:none;}
    .checklist-item{display:flex;gap:12px;align-items:flex-start;padding:12px;margin-bottom:10px;background:#f8f9ff;border:1px solid var(--border);border-radius:10px;}
    .checkbox-container{display:flex;flex-direction:column;gap:8px;min-width:120px;} .checkbox-group{display:inline-flex;align-items:center;gap:8px;} .checkbox{width:26px;height:26px;cursor:pointer;} .checkbox.pass{accent-color:var(--pass);} .checkbox.fail{accent-color:var(--fail);} .checkbox-label{font-size:.9rem;font-weight:700;user-select:none;} .checkbox-label.pass{color:#2f855a;} .checkbox-label.fail{color:#c53030;}
    .item-text{flex:1;font-size:1.02rem;} .checklist-item.checked{background:#f2fff6;border-color:#bdebcf;} .checklist-item.failed{background:#fff5f5;border-color:#f9b3b3;}
  /* Guided focus highlight (added for Week 1 parity) */
  .incomplete-focus{position:relative;box-shadow:0 0 0 3px #f59e0b,0 0 0 6px rgba(245,158,11,.35);animation:pulseRing 1.2s ease-in-out infinite;}
  @keyframes pulseRing{0%{box-shadow:0 0 0 3px #f59e0b,0 0 0 6px rgba(245,158,11,.35);}50%{box-shadow:0 0 0 3px #f59e0b,0 0 0 10px rgba(245,158,11,.08);}100%{box-shadow:0 0 0 3px #f59e0b,0 0 0 6px rgba(245,158,11,.35);}}
    .notes{display:grid;grid-template-columns:1fr;gap:12px;padding:0 16px 16px;} .notes textarea{min-height:130px;resize:vertical;}
    .scorebar{margin-top:auto;position:sticky;bottom:0;background:#fff;border-top:1px solid var(--border);padding:12px 16px calc(12px + env(safe-area-inset-bottom));display:grid;grid-template-columns:repeat(4,auto) 1fr;gap:12px;align-items:center;}
    .pill{padding:8px 14px;border-radius:999px;color:#fff;font-weight:800;font-size:1rem;} .pill.primary{background:var(--primary);} .pill.fail{background:var(--fail);} .pill.score{background:var(--fail);} 
    .critical-badge{display:inline-block;background:#e53e3e;color:#fff;font-size:.55rem;padding:3px 6px 2px;border-radius:6px;margin-left:8px;letter-spacing:.5px;font-weight:700;box-shadow:0 0 0 1px rgba(229,62,62,0.4),0 2px 4px rgba(229,62,62,0.35);position:relative;top:-1px;white-space:nowrap;}
    .checklist-item.failed .critical-badge{background:#9b2c2c;}
  .guided-toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;width:min(680px,92%);background:#1a1f29;color:#fff;padding:18px 20px 16px;border-radius:16px;box-shadow:0 14px 42px -8px rgba(0,0,0,.45),0 4px 18px rgba(0,0,0,.4);z-index:1100;font-size:.95rem;display:flex;flex-direction:column;gap:14px;}
  .guided-toast h4{margin:0;font-size:1.05rem;font-weight:700;}
  .guided-progress{font-size:.75rem;letter-spacing:.5px;opacity:.85;}
  .guided-item-text{background:#222b38;padding:12px 14px;border-radius:10px;max-height:110px;overflow:auto;line-height:1.3;font-size:.9rem;}
  .guided-actions{display:flex;flex-wrap:wrap;gap:10px;}
  .guided-btn{flex:1 1 auto;padding:12px 14px;border:none;border-radius:10px;font-weight:600;cursor:pointer;font-size:.85rem;display:flex;align-items:center;justify-content:center;gap:6px;}
  .guided-btn.pass{background:#16a34a;color:#fff;} .guided-btn.pass:hover{background:#15803d;}
  .guided-btn.fail{background:#dc2626;color:#fff;} .guided-btn.fail:hover{background:#b91c1c;}
  .guided-btn.next{background:#334155;color:#e2e8f0;} .guided-btn.next:hover{background:#1e293b;}
  .guided-btn.submit{background:linear-gradient(90deg,#6366f1,#8b5cf6);color:#fff;}
  .guided-btn.submit[disabled]{background:#475569;cursor:not-allowed;opacity:.6;}
  .guided-close{position:absolute;top:8px;right:10px;background:none;border:none;color:#94a3b8;font-size:18px;cursor:pointer;} .guided-close:hover{color:#fff;}
    @media (max-width:520px){
      html{font-size:clamp(16px,4.8vw,18px);} body{padding:8px;} .container{border-radius:12px;} .toolbar{gap:8px;padding:10px 12px;} .btn{flex:1 1 auto;min-width:45%;min-height:50px;font-size:1rem;} .checklist-item{flex-direction:column;gap:10px;} .checkbox-container{flex-direction:row;align-items:center;min-width:auto;} .checkbox{width:28px;height:28px;} .item-text{font-size:1.05rem;} .scorebar{display:flex;flex-wrap:wrap;gap:6px 10px;padding:10px 12px calc(10px + env(safe-area-inset-bottom));} .scorebar>div{flex:1 1 45%;display:flex;align-items:center;gap:4px;font-size:.8rem;} .scorebar>div:last-child{flex:1 1 100%;order:5;text-align:left !important;font-size:.65rem;} .pill{font-size:.75rem;padding:6px 10px;font-weight:700;} .header h1{font-size:1.35rem;} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>NURS 10L - Week 3 Medication Administration</h1>
      <p>Medication Safety, Knowledge, Mixing & Administration</p>
      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
    </div>
    <div class="toolbar">
      <button type="button" class="btn btn-secondary" id="expandAll">Expand all</button>
      <button type="button" class="btn btn-secondary" id="collapseAll">Collapse all</button>
      <button type="button" class="btn btn-secondary" id="resetForm">Reset form</button>
  <button type="button" class="btn btn-secondary" id="switchStudent">Switch / Logout</button>
      <button type="button" class="btn btn-primary" id="downloadReport">Generate report</button>
      <button type="button" class="btn btn-primary" id="submitEvaluation" style="background:var(--ok);">Submit Evaluation</button>
    </div>
    <form id="evaluationForm">
      <div class="student-info">
        <div class="field"><label for="studentName">Student Being Evaluated 🔒</label><input id="studentName" name="studentName" type="text" required readonly style="background:#f8f9fa;border:2px solid #28a745;font-weight:bold;" /></div>
        <div class="field"><label for="evaluatorName">Evaluator Name</label><input id="evaluatorName" name="evaluatorName" type="text" required /></div>
        <div class="field"><label for="evaluationDate">Date</label><input id="evaluationDate" name="evaluationDate" type="date" required /></div>
        <div class="field"><label for="scenarioTime">Scenario Time</label><input id="scenarioTime" name="scenarioTime" type="text" value="0700 (Breakfast 0800)" /></div>
      </div>
      <div class="scenario-summary">
        <h3>Patient Case Summary (Shift 0700-1900)</h3>
        <div class="patient-info">
          <strong>Patient:</strong> Shannon Shaw, 83-year-old male<br />
          <strong>Diagnoses:</strong> Congestive Heart Failure (CHF), Type II Diabetes<br />
          <strong>PMH:</strong> HTN, CHF, CAD, HLD, COPD, OSA, Asthma<br />
          <strong>Allergies:</strong> NKA<br />
          <strong>Assessment:</strong> Alert, irritable, ↑ SOB even at rest, no dysphagia<br />
          <strong>Orders:</strong> Lasix 20mg PO daily; KCL 10% Elixir 30 mEq PO daily; Beclovent MDI 2 puffs q12h; NPH 26u SQ AM; Regular 10u SQ AM; AC & HS glucose checks with sliding scale; Call MD >300 mg/dL<br />
          <strong>VS (Baseline):</strong> 97.0 – 80 – 28; Pain 0/10; SpO₂ 98% RA<br />
        </div>
      </div>

      <!-- SBAR Section -->
      <div class="section" id="sec-sbar">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)"><span class="section-title">SBAR Handoff & Admission</span><span class="section-meta" data-count="sec-sbar"></span><span class="toggle-icon">▾</span></button>
        <div class="section-content">
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="sbar_situation" data-critical="true"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="sbar_situation" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">States Situation: 83 y/o male with CHF & SOB<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="sbar_dx" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="sbar_dx" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">States Dx: CHF, Type II Diabetes</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="sbar_background" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="sbar_background" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Background: HTN, CAD, HLD, COPD, OSA, Asthma; NKA</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="sbar_assessment_findings" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="sbar_assessment_findings" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Assessment: Alert, irritable, ↑ SOB at rest<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="sbar_orders" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="sbar_orders" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Lists key medication & monitoring orders accurately</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="sbar_risks" data-critical="true" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="sbar_risks" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Identifies priority risks: fluid overload, electrolyte imbalance, hypoglycemia/hyperglycemia, respiratory compromise<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="sbar_recommendations" /><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="sbar_recommendations" data-fail /><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">States recommendations: monitor I&O, daily weight, glucose AC/HS, breath sounds, edema, response to diuretics</div></div>
        </div>
      </div>

      <!-- Standard Protocol Beginning -->
      <div class="section" id="sec-begin">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)"><span class="section-title">Standard Protocol - Beginning</span><span class="section-meta" data-count="sec-begin"></span><span class="toggle-icon">▾</span></button>
        <div class="section-content">
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="verify_orders"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="verify_orders" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Verifies physician's orders (MAR vs chart at bedside)<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="gather_equipment"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="gather_equipment" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Gathers equipment/supplies</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="hand_hygiene_initial"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="hand_hygiene_initial" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Performs hand hygiene (gel in)<span class="critical-badge">CRITICAL</span></div></div>
        </div>
      </div>

      <!-- Standard Protocol During -->
      <div class="section" id="sec-during">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)"><span class="section-title">Standard Protocol - During</span><span class="section-meta" data-count="sec-during"></span><span class="toggle-icon">▾</span></button>
        <div class="section-content">
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="identify_client"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="identify_client" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Identifies client (ID band + name/DOB)<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="introduce_self"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="introduce_self" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Introduces self & role; explains plan</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="teaching_identified"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="teaching_identified" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Identifies teaching needs; sets expectations</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="intervention_still_appropriate"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="intervention_still_appropriate" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Assesses if interventions remain appropriate</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="bed_height_siderail"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="bed_height_siderail" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Adjusts bed height; lowers nearest side rail</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="lighting"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="lighting" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Provides adequate lighting</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="privacy"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="privacy" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Provides privacy (curtain)</div></div>
        </div>
      </div>

      <!-- Medication Pass: Checks -->
      <div class="section" id="sec-medpass-checks">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)"><span class="section-title">Medication Pass - 6 Rights (Three Checks)</span><span class="section-meta" data-count="sec-medpass-checks"></span><span class="toggle-icon">▾</span></button>
        <div class="section-content">
          <h4 style="margin:0 0 6px;color:var(--muted);">Pre-Check & Safety</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="mar_vs_orders"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="mar_vs_orders" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Compares MAR with physician orders<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pmh_med_app"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pmh_med_app" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Assesses PMH for appropriateness (states indication each med)</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="allergy_check"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="allergy_check" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Confirms allergies (asks & checks MAR/chart)<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="expiry_check"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="expiry_check" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Checks medication expiration dates (verbalizes)</div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">First Check (Dispensing Area)</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="first_6_rights"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="first_6_rights" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Performs & verbalizes all 6 Rights (client, drug, dose, route, time, documentation plan) - First Check<span class="critical-badge">CRITICAL</span></div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Second Check (Bedside Table)</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="second_6_rights"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="second_6_rights" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Performs & verbalizes all 6 Rights - Second Check<span class="critical-badge">CRITICAL</span></div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Third Check (Immediately Before Administration)</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="third_6_rights"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="third_6_rights" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Final 6 Rights with armband verification (client, drug, dose, route, time, documentation)<span class="critical-badge">CRITICAL</span></div></div>
        </div>
      </div>

      <!-- Medication Knowledge & Specific Meds -->
      <div class="section" id="sec-med-knowledge">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)"><span class="section-title">Medication Knowledge & Administration</span><span class="section-meta" data-count="sec-med-knowledge"></span><span class="toggle-icon">▾</span></button>
        <div class="section-content">
          <h4 style="margin:0 0 6px;color:var(--muted);">Lasix (Furosemide) 20mg</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="lasix_use"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="lasix_use" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">States use: control edema in CHF / HTN</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="lasix_sidefx"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="lasix_sidefx" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">States side effects: hypotension, fluid/electrolyte imbalance (hypokalemia), polyuria, dizziness</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="lasix_assessments"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="lasix_assessments" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Required assessments: K+, BP, urinary output</div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Potassium Chloride 10% Elixir</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="kcl_use"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="kcl_use" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">States use: treatment/prevention hypokalemia (electrolyte)</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="kcl_sidefx"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="kcl_sidefx" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Side effects: hyperkalemia, ECG changes, muscle weakness, palpitations</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="kcl_assessments"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="kcl_assessments" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Assessments: K+, ECG monitoring</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="kcl_prep_steps"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="kcl_prep_steps" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Demonstrates pouring technique (label to palm, cap up, med cup flat @ eye level, correct dose)</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="kcl_juice"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="kcl_juice" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">States would give with juice (bitter) & remain with client until taken</div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">MDI Beclovent (Beclomethasone)</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="mdi_use"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="mdi_use" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Use: control of bronchial asthma (corticosteroid adjunct)</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="mdi_sidefx"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="mdi_sidefx" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Side effects: oral/laryngeal irritation, fungal infections</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="mdi_assessments"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="mdi_assessments" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Assessments: respiratory auscultation, VS, oral thrush signs</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="mdi_assembly"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="mdi_assembly" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Assembles MDI with spacer; demonstrates proper technique</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="mdi_timing"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="mdi_timing" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">States puff timing: 1 puff → deep breaths → 2–5 min → next puff</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="mdi_rinse_mouth"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="mdi_rinse_mouth" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">States rinse mouth after use to prevent thrush<span class="critical-badge">CRITICAL</span></div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Insulin (NPH & Regular)</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="insulin_knowledge"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="insulin_knowledge" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">States uses for NPH & Regular insulin (Type I/II DM)</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="insulin_pharm"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="insulin_pharm" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">States onset/peak/duration for both insulins</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="insulin_sidefx"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="insulin_sidefx" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Side effects & assessments: hypoglycemia, hyperglycemia signs</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="meal_ready"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="meal_ready" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Verifies meal present & client ready before administration<span class="critical-badge">CRITICAL</span></div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Insulin Mixing Steps (Clear → Cloudy)</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="roll_nph"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="roll_nph" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Rolls NPH vial to mix (does not shake)<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="cleanse_vials"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="cleanse_vials" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Cleanses both vial tops with alcohol<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="inject_air_nph"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="inject_air_nph" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Injects 26u air into NPH (vial on surface)<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="inject_air_regular"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="inject_air_regular" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Injects 16u air into Regular (vial on surface)<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="withdraw_regular"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="withdraw_regular" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Withdraws Regular insulin first (10u + 6u = 16u)<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="insert_nph_surface"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="insert_nph_surface" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Inserts needle into NPH (vial on surface NOT inverted)<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="withdraw_nph_total"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="withdraw_nph_total" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Withdraws to total 42u (adds 26u NPH) bubble-free<span class="critical-badge">CRITICAL</span></div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Insulin Administration (Subcutaneous)</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="draws_during_check2"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="draws_during_check2" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Draws up insulin during 2nd check (timely)</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="recap_safe_pre_injection"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="recap_safe_pre_injection" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Safe recap prior to injection (if needed)</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="dons_gloves"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="dons_gloves" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Dons gloves appropriately</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="ask_last_site"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="ask_last_site" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Asks last injection site; rotates appropriately</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="assess_skin_site"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="assess_skin_site" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Assesses skin (scars, lesions, redness)</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="cleanse_site"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="cleanse_site" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Cleanses site (2" circular outward)</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pinch_technique"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pinch_technique" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Pinches SQ tissue (chooses 90° or 45° appropriately)</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="inject_slowly"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="inject_slowly" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Injects slowly; releases pinch concurrent with withdrawal<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="no_recap_post"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="no_recap_post" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Does NOT recap after injection; activates safety; disposes sharps immediately<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="hypoglycemia_teaching"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="hypoglycemia_teaching" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Teaches hypoglycemia treatment (15g carbs examples)</div></div>
        </div>
      </div>

      <!-- Assessments -->
      <div class="section" id="sec-assessments">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)"><span class="section-title">Clinical Assessments</span><span class="section-meta" data-count="sec-assessments"></span><span class="toggle-icon">▾</span></button>
        <div class="section-content">
          <h4 style="margin:0 0 6px;color:var(--muted);">Assessment: Head / Face / Mouth / Mucous Membranes</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_head"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_head" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Head: Normocephalic, atraumatic, symmetrical, no masses or tenderness.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_hair"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_hair" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Hair: Evenly distributed, soft, appropriate thickness, color consistent with ethnicity; scalp clean without lesions or infestations.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_face"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_face" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Face: Symmetrical at rest and with movement; no drooping or involuntary movements.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_teeth"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_teeth" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Teeth: Intact and well maintained; no caries, plaque, or discoloration. Dentures/bridges fit well if present. Breath odor neutral.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_mucosa"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_mucosa" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Mucous membranes/gums: Moist, pink, intact; no ulcerations, swelling, or bleeding.</div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Assessment: Skin / Hair / Nails</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_skin_tone"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_skin_tone" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Skin tone/variations: Even pigmentation consistent with ethnicity; no jaundice, cyanosis, or abnormal discolorations.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_skin_temp"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_skin_temp" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Temperature/character: Warm, dry, equal bilaterally.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_texture"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_texture" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Texture: Smooth, soft, resilient; no rough patches.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_thickness"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_thickness" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Thickness: Uniform throughout, thicker only at palms and soles.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_turgor"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_turgor" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Turgor: Good elasticity; returns promptly; no tenting.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_vascularity"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_vascularity" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Vascularity: No ecchymosis, petechiae, or abnormal markings; tattoos noted if present.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_edema"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_edema" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Edema: None.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_lesions"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_lesions" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Lesions/moles/scars: No suspicious lesions; benign nevi only; scars well-healed.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_pressure"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_pressure" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Pressure signs: Skin intact; no erythema, breakdown, or ulceration.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_nails"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_nails" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Nails: Smooth, firm, pink nail beds; capillary refill <2 seconds; contour ≤160°, no clubbing.</div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Assessment: General Appearance</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_nutrition"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_nutrition" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">State of Nutrition: Well-nourished, weight proportionate for height and age; no signs of malnutrition.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_comfort"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_comfort" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Comfort Level: Resting comfortably; no signs of pain or distress.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_body_structure"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_body_structure" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Facial Features / Body Structure: Symmetrical features; body build proportional; posture erect or appropriate to position (bed, chair, or standing).</div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Assessment: Neurological System</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_orientation"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_orientation" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Level of Orientation: Alert and oriented ×3 (person, place, time). If limited, document A&Ox1 or x2.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_memory"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_memory" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Memory: Short- and long-term memory intact.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_motor"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_motor" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Motor Function: Purposeful, coordinated movements; follows commands; strength equal bilaterally.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_pupils"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_pupils" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Pupils: PERRLA (pupils equal, round, reactive to light and accommodation), brisk reaction.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_eom"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_eom" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Ocular Movements: Extraocular movements intact; no nystagmus.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_gcs"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_gcs" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Glasgow Coma Scale: 15/15.</div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Assessment: Psychological</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_facial_expression"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_facial_expression" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Facial Expression: Relaxed, appropriate; maintains eye contact; affect congruent with mood.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_mood_affect"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_mood_affect" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Mood / Affect: Calm, cooperative; appropriate to situation.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_speech"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_speech" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Speech: Clear, articulate, normal pace and rhythm.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_interaction"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_interaction" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Interaction: Engaged, responds appropriately; age-appropriate behavior.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_hygiene"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_hygiene" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Personal Hygiene: Clean, well-groomed; clothing appropriate for setting.</div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Assessment: Respiratory System (Thorax / Lungs)</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_resp_color"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_resp_color" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Color: Lips and mucous membranes pink; no cyanosis or pallor; no nasal flaring.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_chest_shape"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_chest_shape" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Chest Shape/Configuration: Symmetrical chest wall; AP diameter less than transverse diameter (1:2 ratio). No deformities.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_resp_effort"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_resp_effort" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Effort: Respirations even, unlabored; no use of accessory muscles.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_resp_quality_rate"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_resp_quality_rate" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Quality & Rate: Regular rhythm; rate within normal limits.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_resp_ausc"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_resp_ausc" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Auscultation: Breath sounds clear to auscultation bilaterally; no wheezes, rales (crackles), or rhonchi.</div></div>
          <h4 style="margin:18px 0 6px;color:var(--muted);">Assessment: Cardiovascular System</h4>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_heart_rhythm"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_heart_rhythm" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Heart Rhythm: Regular rate and rhythm; no skipped beats.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_heart_rate"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_heart_rate" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Rate: Within normal limits (60–100 bpm for adults).</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_heart_sounds"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_heart_sounds" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Heart Sounds: Distinct S1 and S2; no extra sounds (S3, S4) or murmurs.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_peripheral_pulses"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_peripheral_pulses" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Peripheral Pulses: Palpable, equal, and symmetrical bilaterally; strength 2+.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_cardiac_edema"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_cardiac_edema" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Edema: None present.</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="pa_cap_refill"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="pa_cap_refill" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Capillary Refill: Brisk, <2 seconds in fingers and toes.</div></div>
        </div>
      </div>

      <!-- Ending Protocol -->
      <div class="section" id="sec-ending">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)"><span class="section-title">Standard Protocol - Ending</span><span class="section-meta" data-count="sec-ending"></span><span class="toggle-icon">▾</span></button>
        <div class="section-content">
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="comfort_position"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="comfort_position" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Positions client comfortably; personal items within reach</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="call_light"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="call_light" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Ensures call light present & patient instructed</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="safety_rails_bed"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="safety_rails_bed" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Raises side rails; lowers bed to lowest position<span class="critical-badge">CRITICAL</span></div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="dispose_supplies"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="dispose_supplies" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Disposes of supplies & equipment properly</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" type="checkbox" data-key="remove_gloves_end"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="remove_gloves_end" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Removes gloves if worn appropriately</div></div>
          <div class="checklist-item"><div class="checkbox-container"><label class="checkbox-group"><input class="checkbox pass" data-critical="true" type="checkbox" data-key="final_hand_hygiene"/><span class="checkbox-label pass">✓ PASS</span></label><label class="checkbox-group"><input class="checkbox fail" type="checkbox" data-key="final_hand_hygiene" data-fail/><span class="checkbox-label fail">✗ FAIL</span></label></div><div class="item-text">Performs final hand hygiene (gel out)<span class="critical-badge">CRITICAL</span></div></div>
        </div>
      </div>

      <!-- Notes -->
      <div class="section" id="sec-notes">
        <button type="button" class="section-header" aria-expanded="true" onclick="toggleSection(this)"><span class="section-title">Evaluation Notes</span><span class="toggle-icon">▾</span></button>
        <div class="section-content">
          <div class="notes">
            <div class="field"><label for="med_notes">Medication Notes</label><textarea id="med_notes" placeholder="Rationale, patient education effectiveness, adverse effect monitoring..."></textarea></div>
            <div class="field"><label for="safety_notes">Safety / Critical Thinking</label><textarea id="safety_notes" placeholder="Clinical judgment, priority setting, risk mitigation..."></textarea></div>
            <div class="field"><label for="additional_notes">Additional Notes</label><textarea id="additional_notes" placeholder="Any other observations or feedback..."></textarea></div>
          </div>
        </div>
      </div>
    </form>

    <div class="scorebar">
      <div><strong>Completed:</strong> <span id="completedScore" class="pill primary">0 / 0</span></div>
      <div><strong>Failed:</strong> <span id="failedScore" class="pill fail">0</span></div>
      <div><strong>Critical Fails:</strong> <span id="criticalFailedScore" class="pill fail">0</span></div>
      <div><strong>Score:</strong> <span id="overallScore" class="pill score">0%</span></div>
      <div style="text-align:right;color:var(--muted-2);font-size:.75rem;">Progress auto-saves locally</div>
    </div>
  </div>

  <div id="guidedToastRoot" aria-live="assertive" style="z-index:1100;"></div>

  <!-- Login Modal (reused pattern) -->
  <div id="loginModal" style="position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;justify-content:center;align-items:center;z-index:1000;">
    <div style="background:#fff;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.3);max-width:420px;width:92%;">
      <h2 style="text-align:center;color:var(--primary);margin:0 0 20px;">🏥 Student Sign-In</h2>
      <p style="text-align:center;color:var(--muted);margin:0 0 25px;">Enter your name & password to access Week 3 evaluation</p>
      <form id="loginForm">
        <div style="margin-bottom:18px;"><label style="display:block;margin-bottom:6px;font-weight:600;" for="loginStudentName">Student Name</label><input id="loginStudentName" required style="width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;font-size:16px;" placeholder="Full name" /></div>
        <div style="margin-bottom:18px;"><label style="display:block;margin-bottom:6px;font-weight:600;" for="loginPassword">Password</label><input id="loginPassword" type="password" required placeholder="Institutional password" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;font-size:16px;" /></div>
        <button type="submit" style="width:100%;padding:12px;background:var(--primary);color:#fff;border:none;border-radius:8px;font-weight:600;font-size:16px;cursor:pointer;">Start Evaluation</button>
      </form>
      <div id="loginError" style="display:none;color:var(--fail);text-align:center;margin-top:15px;font-size:14px;"></div>
    </div>
  </div>

  <div id="connectionStatus" style="position:fixed;top:20px;right:20px;padding:8px 15px;border-radius:20px;font-size:12px;font-weight:600;z-index:999;display:none;"></div>

  <script>
    const BASE_PATH = location.pathname.toLowerCase().startsWith('/n10lvoice/') ? '/N10LVoice' : '';
    const API_BASE = `${BASE_PATH}/api`;
    const SOCKET_PATH = `${BASE_PATH}/socket.io`;
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s)); const $=(s,r=document)=>r.querySelector(s);
    let socket=null, sessionId=localStorage.getItem('studentSession'), studentName=localStorage.getItem('studentName');
    let evaluationStartTime=null; let reconnectAttempts=0; const maxReconnectAttempts=5; let reconnectInterval=null; let isManualDisconnect=false;

    function showLoginModal(){$('#loginModal').style.display='flex';} function hideLoginModal(){$('#loginModal').style.display='none';}

    async function checkExistingSession(){ if(sessionId && studentName){ try{ const res=await fetch(`${API_BASE}/auth/validate-session`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId})}); if(res.ok){ connectSocket(); setTimeout(restoreFormState,800); return;} }catch(e){} localStorage.removeItem('studentSession'); localStorage.removeItem('studentName'); sessionId=null; studentName=null;} showLoginModal(); }
    checkExistingSession();

    function connectSocket(){ if(!studentName||!sessionId) return; socket = io({ path: SOCKET_PATH, auth:{sessionId}, reconnection:true, reconnectionAttempts:maxReconnectAttempts }); socket.on('connect',()=>{ updateConnectionStatus('connected'); if(!evaluationStartTime) evaluationStartTime=new Date().toISOString(); const sn=$('#studentName'); if(sn){ sn.value=studentName; sn.readonly=true;} if(reconnectAttempts>0) showSuccess('Reconnected ✅'); }); socket.on('disconnect',(r)=>{ updateConnectionStatus('disconnected'); if(!isManualDisconnect && r!=='io client disconnect') startReconnectionProcess();}); socket.on('reconnect_attempt',a=>updateConnectionStatus('reconnecting',a)); socket.on('reconnect_failed',()=>updateConnectionStatus('failed')); socket.on('connect_error',e=>{ if(e.message.includes('session')) {showError('Session expired.'); logout();}}); }

    function updateConnectionStatus(status,attempts=0){ const el=$('#connectionStatus'); el.style.display='block'; el.style.color='#fff'; if(status==='connected'){el.style.background='var(--pass)'; el.textContent='🟢 Connected';} else if(status==='disconnected'){el.style.background='var(--fail)'; el.textContent='🔴 Disconnected';} else if(status==='reconnecting'){el.style.background='var(--warn)'; el.textContent=`🟡 Reconnecting (${attempts}/${maxReconnectAttempts})`; } else if(status==='failed'){el.style.background='var(--fail)'; el.textContent='🔴 Retry'; el.style.cursor='pointer'; el.onclick=attemptReconnection;} }
    function startReconnectionProcess(){ if(reconnectInterval) return; reconnectInterval=setInterval(()=>{ reconnectAttempts++; updateConnectionStatus('reconnecting',reconnectAttempts); if(reconnectAttempts>=maxReconnectAttempts){ clearInterval(reconnectInterval); reconnectInterval=null; updateConnectionStatus('failed'); } else attemptReconnection(); },3000); }
    async function attemptReconnection(){ try{ const res=await fetch(`${API_BASE}/auth/validate-session`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId})}); if(res.ok){ if(socket) socket.disconnect(); connectSocket(); } else { showError('Session expired'); logout(); } }catch(e){} }
    function logout(){ isManualDisconnect=true; clearInterval(reconnectInterval); localStorage.removeItem('studentSession'); localStorage.removeItem('studentName'); sessionId=null; studentName=null; if(socket) socket.disconnect(); isManualDisconnect=false; showLoginModal(); }

    function showError(msg){ const el=$('#loginError'); el.textContent=msg; el.style.display='block'; setTimeout(()=>{el.style.display='none';},5000);} function showSuccess(message){ const d=document.createElement('div'); d.style.cssText='position:fixed;top:20px;right:20px;background:var(--pass);color:#fff;padding:10px 18px;border-radius:8px;font-weight:600;z-index:2000;'; d.textContent=message; document.body.appendChild(d); setTimeout(()=>d.remove(),3500); }

    function saveFormState(){ const formData={ evaluatorName:$('#evaluatorName')?.value||'', scenarioTime:$('#scenarioTime')?.value||'', notes:$('#additional_notes')?.value||'', checkboxStates:{}, timestamp:Date.now() }; $$('input[type="checkbox"]').forEach(cb=>{ if(cb.id) formData.checkboxStates[cb.id]=cb.checked; }); localStorage.setItem('week3_form_state',JSON.stringify(formData)); }
    function restoreFormState(){ const raw=localStorage.getItem('week3_form_state'); if(!raw) return; try{ const data=JSON.parse(raw); if(Date.now()-data.timestamp>3600000) return; if(data.evaluatorName) $('#evaluatorName').value=data.evaluatorName; if(data.scenarioTime) $('#scenarioTime').value=data.scenarioTime; if(data.notes) $('#additional_notes').value=data.notes; updateCounts(); }catch(e){} }

    function sendProgressUpdate(){ if(!socket||!socket.connected) return; const score=getCurrentScore(); const items=getCurrentItems(); socket.emit('evaluation-update',{ score, items, timestamp:new Date().toISOString(), courseWeekId:3, scenarioTitle:'Week 3 - Medication Administration' }); }

    function getCurrentScore(){ let passed=0,failed=0,total=0; $$('.checklist-item').forEach(ci=>{ total++; const pass=ci.querySelector('input.checkbox.pass'); const fail=ci.querySelector('input.checkbox.fail'); if(pass?.checked){passed++;} else if(fail?.checked){failed++;} }); const pct= total? Math.round((passed/total)*100):0; return {passed,failed,total,percent:pct}; }

    function getCurrentItems(){ const items=[]; const sectionSequenceCounters={}; $$('.section').forEach(section=>{ const sectionName=section.querySelector('.section-title')?.textContent.trim()||'Unknown Section'; if(!(sectionName in sectionSequenceCounters)) sectionSequenceCounters[sectionName]=0; $$('.checklist-item',section).forEach(ci=>{ const seq=sectionSequenceCounters[sectionName]++; const text=ci.querySelector('.item-text')?.textContent.trim(); const pass=ci.querySelector('input.checkbox.pass'); const fail=ci.querySelector('input.checkbox.fail'); let status='not_completed'; if(pass?.checked) status='pass'; else if(fail?.checked) status='fail'; const itemKey=`${sectionName.toLowerCase().replace(/\s+/g,'_')}_${seq}`; const critical=pass?.dataset.critical==='true'; items.push({section:sectionName,item:text,key:itemKey,checked:status==='pass',failed:status==='fail',status,timestamp:new Date().toISOString(),notes:status==='pass'?'Passed':'Not completed',sequence:seq,critical}); }); }); return items; }

    function collectIncomplete(){ const list=[]; $$('.checklist-item').forEach(ci=>{ const p=ci.querySelector('input.checkbox.pass'); const f=ci.querySelector('input.checkbox.fail'); if(!p||!f) return; if(!p.checked && !f.checked) list.push(ci); }); return list; }
    let guidedQueue=[], guidedIndex=0; function startGuided(){ guidedQueue=collectIncomplete(); guidedIndex=0; if(!guidedQueue.length) return false; focusGuided(); renderGuidedToast(); return true; }
    function focusGuided(){ $$('.checklist-item.incomplete-focus').forEach(e=>e.classList.remove('incomplete-focus')); const cur=guidedQueue[guidedIndex]; if(!cur) return; cur.classList.add('incomplete-focus'); cur.scrollIntoView({behavior:'smooth',block:'center'}); }
    function renderGuidedToast(){
      const root=$('#guidedToastRoot');
      if(!guidedQueue.length){ root.innerHTML=''; return; }
      const cur=guidedQueue[guidedIndex];
      const text=cur.querySelector('.item-text')?.textContent||'Checklist item';
      const pct=Math.round((guidedIndex)/guidedQueue.length*100);
      const remaining=guidedQueue.length-guidedIndex;
      root.innerHTML=`<div class="guided-toast" role="dialog" aria-label="Incomplete checklist guidance">
        <button class="guided-close" onclick="cancelGuidedMode()" aria-label="Close">×</button>
        <h4>Complete All Items Before Submitting (Week 3)</h4>
        <div class="guided-progress">Item ${guidedIndex+1} of ${guidedQueue.length} • ${pct}% reviewed</div>
        <div class="guided-item-text">${text}</div>
        <div class="guided-actions">
          <button class='guided-btn pass' onclick="guidedMark('pass')">✓ Pass</button>
          <button class='guided-btn fail' onclick="guidedMark('fail')">✗ Fail</button>
          <button class='guided-btn next' onclick='guidedSkip()' ${remaining<=1? 'disabled style="opacity:.4;cursor:not-allowed;"':''}>Skip</button>
          <button class='guided-btn submit' onclick='resumeSubmit()' ${remaining>1? 'disabled':''}>Submit Now</button>
        </div>
      </div>`;
    }
    function guidedMark(mode){ const cur=guidedQueue[guidedIndex]; if(!cur) return; const pass=cur.querySelector('input.checkbox.pass'); const fail=cur.querySelector('input.checkbox.fail'); if(mode==='pass'){ if(pass){ pass.checked=true; if(fail) fail.checked=false; cur.classList.add('checked'); cur.classList.remove('failed'); } } else { if(fail){ fail.checked=true; if(pass) pass.checked=false; cur.classList.add('failed'); cur.classList.remove('checked'); } } updateCounts(); guidedAdvance(); }
    function guidedSkip(){ guidedAdvance(); }
    function guidedAdvance(){
      guidedQueue=collectIncomplete();
      if(!guidedQueue.length){
        $('#guidedToastRoot').innerHTML=`<div class="guided-toast" style="background:#0f172a;">
          <h4>All items answered ✅</h4>
          <div style="font-size:.8rem;opacity:.8;">You can submit now.</div>
          <div class="guided-actions" style="margin-top:10px;">
            <button class="guided-btn submit" onclick="resumeSubmit()">Submit Evaluation</button>
            <button class="guided-btn next" onclick="cancelGuidedMode()">Close</button>
          </div>
        </div>`;
        return;
      }
      if(guidedIndex>=guidedQueue.length) guidedIndex=0; focusGuided(); renderGuidedToast();
    }
  function resumeSubmit(){ const incom=collectIncomplete(); if(incom.length){ guidedQueue=incom; guidedIndex=0; focusGuided(); renderGuidedToast(); return; } cancelGuidedMode(); submitEvaluation(); }
  function cancelGuidedMode(){ guidedQueue=[]; guidedIndex=0; $$('.checklist-item.incomplete-focus').forEach(e=>e.classList.remove('incomplete-focus')); const root=$('#guidedToastRoot'); if(root) root.innerHTML=''; }

    function toggleSection(btn){ const sec=btn.closest('.section'); const expanded=btn.getAttribute('aria-expanded')==='true'; btn.setAttribute('aria-expanded',String(!expanded)); sec.classList.toggle('collapsed',expanded); }

    function updateCounts(){ $$('.section').forEach(sec=>{ const items=$$('.checklist-item',sec); const passed=items.filter(i=>i.classList.contains('checked')).length; const failed=items.filter(i=>i.classList.contains('failed')).length; const meta=sec.querySelector('[data-count]'); if(meta) meta.textContent=`${passed}✓ / ${failed}✗ of ${items.length}`; }); const all=$$('.checklist-item'); const passed=all.filter(i=>i.classList.contains('checked')).length; const failed=all.filter(i=>i.classList.contains('failed')).length; const total=all.length; const criticalFailed=all.filter(i=> i.classList.contains('failed') && i.querySelector('input.checkbox.pass[data-critical="true"]')).length; const pct= total? Math.round((passed/total)*100):0; $('#completedScore').textContent=`${passed} / ${total}`; $('#failedScore').textContent=failed; $('#criticalFailedScore').textContent=criticalFailed; const scoreEl=$('#overallScore'); scoreEl.textContent=`${pct}%`; scoreEl.style.background= pct>=90? 'var(--ok)' : (pct>=75? 'var(--warn)':'var(--fail)'); const completed=passed+failed; $('#progressFill').style.width= total? (completed/total*100)+'%':'0%'; sendProgressUpdate(); }

    function handleToggle(e){ const input=e.target; if(!(input instanceof HTMLInputElement) || !input.classList.contains('checkbox')) return; const item=input.closest('.checklist-item'); const key=input.getAttribute('data-key'); const siblings=$$(`input[data-key='${key}']`,item); siblings.forEach(s=>{ if(s!==input) s.checked=false; }); if(input.checked){ if(input.classList.contains('pass')){ item.classList.add('checked'); item.classList.remove('failed'); } else { item.classList.add('failed'); item.classList.remove('checked'); } } else { item.classList.remove('checked','failed'); } updateCounts(); saveLocalState(); saveFormState(); }

    function saveLocalState(){ const state={ evaluatorName:$('#evaluatorName').value, evaluationDate:$('#evaluationDate').value, scenarioTime:$('#scenarioTime').value, notes:$('#additional_notes').value, items: $$('.checklist-item').map(ci=>{ const pass=ci.querySelector('input.checkbox.pass'); const key=pass?.getAttribute('data-key'); return { key, checked:ci.classList.contains('checked'), failed:ci.classList.contains('failed') }; }) }; localStorage.setItem('n10l_week3_state',JSON.stringify(state)); }
    function loadLocalState(){ const raw=localStorage.getItem('n10l_week3_state'); if(!raw) return; try{ const st=JSON.parse(raw); if(st.evaluatorName) $('#evaluatorName').value=st.evaluatorName; if(st.evaluationDate) $('#evaluationDate').value=st.evaluationDate; if(st.scenarioTime) $('#scenarioTime').value=st.scenarioTime; if(Array.isArray(st.items)){ st.items.forEach(entry=>{ const inputs=$$(`input[data-key='${entry.key}']`); if(!inputs.length) return; const container=inputs[0].closest('.checklist-item'); const pass=container.querySelector('input.checkbox.pass'); const fail=container.querySelector('input.checkbox.fail'); if(entry.failed){ if(fail) fail.checked=true; if(pass) pass.checked=false; container.classList.add('failed'); container.classList.remove('checked'); } else if(entry.checked){ if(pass) pass.checked=true; if(fail) fail.checked=false; container.classList.add('checked'); container.classList.remove('failed'); } else { container.classList.remove('checked','failed'); } }); } }catch(e){} }

    function generateReport(){ const student=$('#studentName').value.trim(); const evalr=$('#evaluatorName').value.trim(); const date=$('#evaluationDate').value; if(!student||!evalr||!date){ alert('Fill Student, Evaluator, Date'); return; } const items=$$('.checklist-item'); const passed=items.filter(i=>i.classList.contains('checked')); const failed=items.filter(i=>i.classList.contains('failed')); const total=items.length; const pct= total? Math.round((passed.length/total)*100):0; let report='NURS 10L - Week 3 Medication Administration Report\n====================================================\n\n'; report+=`Student: ${student}\nEvaluator: ${evalr}\nDate: ${date}\nScenario: Week 3 - Medication Administration\n\nSUMMARY\n-------\n`; report+=`Tasks Completed: ${passed.length} / ${total}\nTasks Failed: ${failed.length}\nOverall Score: ${pct}%\n\n`; if(passed.length){ report+='PASSED TASKS\n------------\n'; passed.forEach(i=> report+='✓ '+ i.querySelector('.item-text').textContent.trim()+'\n'); report+='\n'; } if(failed.length){ report+='TASKS NEEDING IMPROVEMENT\n-------------------------\n'; failed.forEach(i=> report+'✗ '+ i.querySelector('.item-text').textContent.trim()+'\n'); report+='\n'; }
      const criticalFails=failed.filter(i=> i.querySelector('input.checkbox.pass[data-critical="true"]'));
      if(criticalFails.length){ report+='CRITICAL ELEMENTS FAILED\n-----------------------\n'; criticalFails.forEach(i=> report+='⚠ '+ i.querySelector('.item-text').textContent.replace(/CRITICAL$/,'').trim()+'\n'); report+='\n'; }
      const medNotes=$('#med_notes').value.trim(); const safety=$('#safety_notes').value.trim(); const add=$('#additional_notes').value.trim(); if(medNotes){ report+='MEDICATION NOTES\n-----------------\n'+medNotes+'\n\n'; } if(safety){ report+='SAFETY / CRITICAL THINKING\n---------------------------\n'+safety+'\n\n'; } if(add){ report+='ADDITIONAL NOTES\n-----------------\n'+add+'\n\n'; } report+='Generated: '+ new Date().toLocaleString() +'\n'; const blob=new Blob([report],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`Week3_Medication_${student.replace(/\s+/g,'_')}_${date}.txt`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    async function submitEvaluation(forceOverwrite=false){
      if(!socket||!socket.connected){
        const retry=confirm('Not connected. Attempt reconnect?');
        if(retry){ await attemptReconnection(); await new Promise(r=>setTimeout(r,1500)); if(!socket||!socket.connected){ alert('Reconnect failed'); return; } } else return;
      }
      const score=getCurrentScore();
      const items=getCurrentItems();
      const notes={ med:$('#med_notes').value||'', safety:$('#safety_notes').value||'', additional:$('#additional_notes').value||'' };
      // Duplicate evaluation check (template parity)
      if(!forceOverwrite){
        try {
          const resp = await fetch(`${API_BASE}/evaluations/check-duplicate`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({studentName, courseWeekId:3})});
          if(resp.ok){ const data=await resp.json(); if(data.duplicate){ if(!confirm(`An evaluation already exists (Score ${data.existingEvaluation.score}%). Overwrite?`)) return; return submitEvaluation(true); } }
        } catch(e){ console.warn('Week3 duplicate check failed', e); }
      }
      socket.emit('evaluation-complete',{ courseWeekId:3, courseName:'Medication Administration', score, items, notes, evaluatorName:$('#evaluatorName').value||'', scenarioTime:$('#scenarioTime').value||'', startTime:evaluationStartTime, endTime:new Date().toISOString(), overwrite:forceOverwrite });
      alert(`Evaluation submitted!\nScore: ${score.percent}% (${score.passed}/${score.total})`);
      localStorage.removeItem('n10l_week3_state');
      localStorage.removeItem('week3_form_state');
    }

    function guardedSubmit(){ const incom=collectIncomplete(); if(incom.length){ startGuided(); return; } submitEvaluation(); }

    document.getElementById('loginForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const name=$('#loginStudentName').value.trim();
      const pwd=$('#loginPassword').value;
      if(!name||!pwd){ showError('Enter credentials'); return; }
      const prevName = localStorage.getItem('studentName'); // capture BEFORE login mutation
      try{
        const res=await fetch(`${API_BASE}/auth/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:name,password:pwd})});
        const data=await res.json();
        if(!res.ok) throw new Error(data.error||'Login failed');
        if(data.sessionId && data.studentName){
          // Clear previous student's progress BEFORE overwriting stored studentName
            clearProgressForNewStudent(data.studentName);
          studentName=data.studentName;
          sessionId=data.sessionId;
          localStorage.setItem('studentName',data.studentName);
          localStorage.setItem('studentSession',data.sessionId);
          hideLoginModal();
          connectSocket();
          $('#studentName').value=studentName;
        } else throw new Error('No session');
      }catch(err){ showError(err.message); }
    });

    function saveStateTrigger(){ saveLocalState(); saveFormState(); }

    document.addEventListener('DOMContentLoaded',()=>{ const today=new Date().toISOString().slice(0,10); if(!$('#evaluationDate').value) $('#evaluationDate').value=today; loadLocalState(); updateCounts(); document.body.addEventListener('change',handleToggle); $('#resetForm').addEventListener('click',()=>{ if(confirm('Reset entire form?')){ $('#evaluationForm').reset(); $$('.checklist-item').forEach(i=>i.classList.remove('checked','failed')); localStorage.removeItem('n10l_week3_state'); updateCounts(); }}); $('#downloadReport').addEventListener('click',generateReport); $('#submitEvaluation').addEventListener('click',e=>{ e.preventDefault(); guardedSubmit(); }); $('#expandAll').addEventListener('click',()=>$$('.section').forEach(s=>{ s.classList.remove('collapsed'); $('.section-header',s)?.setAttribute('aria-expanded','true'); })); $('#collapseAll').addEventListener('click',()=>$$('.section').forEach(s=>{ s.classList.add('collapsed'); $('.section-header',s)?.setAttribute('aria-expanded','false'); })); $$('input, textarea').forEach(el=> el.addEventListener('input',saveStateTrigger)); setInterval(saveFormState,30000); });

    // --- New Student Login Progress Clearing ---
    function clearProgressForNewStudent(newName){ const prev=localStorage.getItem('studentName'); if(prev && prev.trim().toLowerCase()!==newName.trim().toLowerCase()){ // different student -> clear stored state
        localStorage.removeItem('n10l_week3_state');
        localStorage.removeItem('week3_form_state');
        // Reset UI selections
        $$('.checklist-item').forEach(ci=>{ ci.classList.remove('checked','failed'); ci.querySelectorAll('input[type="checkbox"]').forEach(c=> c.checked=false); });
        $('#evaluatorName') && ($('#evaluatorName').value='');
        showSuccess('Previous student data cleared for new login');
        updateCounts();
        return true;
      }
      return false;
    }

  // Removed supplemental delayed clearing listener; clearing now occurs synchronously before localStorage overwrite.

  // --- Switch Student / Logout Feature (Week 3) ---
  function switchStudent(){
    if(!confirm('Switch student? This will clear current progress.')) return;
    try{ if(socket) socket.disconnect(); }catch(e){}
    localStorage.removeItem('studentSession');
    localStorage.removeItem('studentName');
    localStorage.removeItem('n10l_week3_state');
    localStorage.removeItem('week3_form_state');
    sessionId=null; studentName=null; evaluationStartTime=null;
    $$('.checklist-item').forEach(ci=>{ ci.classList.remove('checked','failed'); ci.querySelectorAll('input[type="checkbox"]').forEach(c=> c.checked=false); });
    const evalField=$('#evaluatorName'); if(evalField) evalField.value='';
    showLoginModal();
    showSuccess('Student session cleared. Ready for new login.');
  }
  document.addEventListener('DOMContentLoaded',()=>{ const btn=document.getElementById('switchStudent'); if(btn) btn.addEventListener('click',switchStudent); });
  </script>
</body>
</html>
