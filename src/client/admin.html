<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N10L Comprehensive Admin Dashboard</title>
    <script src="socket.io/socket.io.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-card {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        
        .login-card h1 {
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 2.2em;
            font-weight: 700;
        }
        
        .login-card p {
            color: #64748b;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        
        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f9fafb;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        
        /* Dashboard Layout */
        .dashboard-wrapper {
            display: none;
            min-height: 100vh;
            background: #f8fafc;
        }
        
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 30px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .sidebar-header h2 {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .sidebar-header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .sidebar-nav {
            padding: 20px 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: #64748b;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            cursor: pointer;
        }
        
        .nav-item:hover, .nav-item.active {
            background: #f1f5f9;
            color: #667eea;
            border-left-color: #667eea;
        }
        
        .nav-item i {
            width: 20px;
            margin-right: 15px;
            font-size: 1.1em;
        }
        
        .main-content {
            margin-left: 280px;
            padding: 30px;
            min-height: 100vh;
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 2em;
            font-weight: 700;
            color: #1e293b;
        }

        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8fafc;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .connection-dot.connected {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
            animation: pulse-green 2s infinite;
        }

        .connection-dot.disconnected {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
        }

        .connection-status {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: color 0.3s ease;
        }

        .connection-status.connected {
            color: #059669;
        }

        .connection-status.disconnected {
            color: #dc2626;
        }

        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes pulseInterim {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.01); }
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s ease;
        }
        
        .logout-btn:hover {
            background: #dc2626;
        }
        
        /* Content Sections */
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        /* Layout Button Styles */
        .layout-btn {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 36px;
            justify-content: center;
        }
        
        .layout-btn:hover {
            background: #f1f5f9;
            color: #475569;
            border-color: #cbd5e1;
        }
        
        .layout-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        }

        /* Different Grid Layout Classes */
        .student-grid-auto {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .student-grid-fixed-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-top: 25px;
        }

        .student-grid-fixed-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 25px;
        }

        .student-grid-fixed-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 18px;
            margin-top: 25px;
        }

        .student-grid-compact {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        .student-grid-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }

        /* Responsive adjustments for fixed layouts */
        @media (max-width: 1400px) {
            .student-grid-fixed-4 {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .student-grid-fixed-3, .student-grid-fixed-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .student-grid-fixed-2, .student-grid-fixed-3, .student-grid-fixed-4 {
                grid-template-columns: 1fr;
            }
        }

        /* Card modifications for different layouts */
        .student-grid-compact .live-card {
            padding: 18px 20px 16px;
            min-height: 280px;
        }

        .student-grid-compact .progress-circle {
            width: 80px;
            height: 80px;
        }

        .student-grid-compact .progress-circle .inner {
            font-size: 1.3rem;
        }

        .student-grid-compact .live-card .lc-name {
            font-size: 1.1rem;
        }

        .student-grid-compact .live-card .lc-speech {
            min-height: 120px;
        }

        .student-grid-list .live-card {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto auto 1fr auto;
            grid-template-areas:
                "progress"
                "header"
                "metrics"
                "speech"
                "footer";
            padding: 20px 24px;
            min-height: 320px;
        }

        .student-grid-list .progress-circle {
            width: 80px;
            height: 80px;
        }

        .student-grid-list .live-card .lc-footer {
            margin-top: 0;
            align-items: center;
        }
        
        .student-grid-list .live-card .lc-speech {
            min-height: 140px;
        }
        
        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
        }
        
        .stat-icon.blue { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .stat-icon.green { background: linear-gradient(135deg, #10b981, #059669); }
        .stat-icon.purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .stat-icon.orange { background: linear-gradient(135deg, #f59e0b, #d97706); }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 1.1em;
            font-weight: 500;
        }
        
        .section-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f8fafc;
            padding: 25px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #1e293b;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .btn-secondary {
            background: #6b7280;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        /* Tables */
        .table-container {
            padding: 0;
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: #f8fafc;
            padding: 20px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-table td {
            padding: 20px;
            border-bottom: 1px solid #f1f5f9;
            color: #4b5563;
        }
        
        .data-table tbody tr:hover {
            background: #f8fafc;
        }
        
        /* Badges */
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge.active {
            background: #dcfce7;
            color: #166534;
        }
        
        .badge.inactive {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge.completed {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge.in-progress {
            background: #f3e8ff;
            color: #7c3aed;
        }
        
        .badge.pass {
            background: #dcfce7;
            color: #166534;
        }
        
        .badge.fail {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .badge.incomplete {
            background: #fef3c7;
            color: #92400e;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 30px 30px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #1e293b;
        }
        
        .close {
            background: #f3f4f6;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 1.2em;
        }
        
        .close:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .semester-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .semester-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.2s ease;
        }
        
        .semester-card:hover {
            transform: translateY(-5px);
        }
        
        .semester-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
        }
        
        .semester-card-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .semester-card-subtitle {
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        .semester-card-body {
            padding: 25px;
        }
        
        .semester-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .semester-stat {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
        }
        
        .semester-stat-value {
            font-size: 1.5em;
            font-weight: 600;
            color: #667eea;
        }
        
        .semester-stat-label {
            font-size: 0.8em;
            color: #64748b;
            margin-top: 5px;
        }
        
        .week-progress {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .week-item {
            text-align: center;
            padding: 12px 8px;
            background: #f1f5f9;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .week-item.completed {
            background: #dcfce7;
            color: #166534;
        }
        
        .week-item.in-progress {
            background: #fef3c7;
            color: #92400e;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            z-index: 1001;
        }
        
        .connection-status.connected {
            background: #dcfce7;
            color: #166534;
        }
        
        .connection-status.disconnected {
            background: #fee2e2;
            color: #dc2626;
        }
        
        /* Student Progress Cards */
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

                /* Live Monitoring Enhanced Styles */
                .presentation-mode .student-grid {
                        grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
                        gap: 32px;
                }
                .live-card {
                        background: linear-gradient(135deg,#ffffff,#f1f5f9);
                        border: 2px solid #e2e8f0;
                        border-radius: 22px;
                        padding: 22px 24px 20px;
                        display: grid;
                        grid-template-columns: 1fr;
                        grid-template-rows: auto auto auto 1fr auto;
                        grid-template-areas:
                            "progress"
                            "header"
                            "metrics"
                            "speech"
                            "footer";
                        gap: 16px;
                        position: relative;
                        box-shadow: 0 10px 24px -6px rgba(0,0,0,0.08), 0 2px 6px rgba(0,0,0,0.05);
                        transition: transform .3s ease, box-shadow .3s ease, background .3s ease;
                        min-height: 360px;
                }
                .live-card:hover { 
                    transform: translateY(-6px) scale(1.02); 
                    box-shadow:0 20px 48px -8px rgba(0,0,0,0.15),0 8px 16px rgba(0,0,0,0.08); 
                    background: linear-gradient(135deg,#ffffff,#f8fafc);
                }
                .live-card.speech-active {
                    border-color: #3b82f6;
                    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
                    box-shadow: 0 10px 24px -6px rgba(59, 130, 246, 0.2), 0 4px 12px rgba(59, 130, 246, 0.1);
                }
                .live-card:hover { transform: translateY(-4px); box-shadow:0 16px 36px -6px rgba(0,0,0,0.12),0 4px 10px rgba(0,0,0,0.06); }
                .live-card .lc-header { grid-area: header; display:flex; align-items:center; justify-content:center; flex-direction:column; text-align:center; }
                .live-card .lc-name { font-size: 1.25rem; font-weight:700; letter-spacing:.5px; color:#1e293b; margin-bottom: 8px; }
                .live-card .lc-status { font-size:.70rem; padding:6px 12px; border-radius:999px; font-weight:600; text-transform:uppercase; letter-spacing:1px; box-shadow:0 0 0 3px rgba(255,255,255,.85); }
                .live-card .lc-progress { grid-area: progress; display:flex; align-items:center; justify-content:center; }
                .progress-circle { width:100px; height:100px; position:relative; border-radius:50%; background:conic-gradient(var(--pc-color,#667eea) calc(var(--pct,0)*1%), #e2e8f0 0); display:flex; align-items:center; justify-content:center; }
                .progress-circle::after { content:""; position:absolute; inset:8px; background:#fff; border-radius:50%; box-shadow: inset 0 0 0 1px #e5e7eb; }
                .progress-circle .inner { position:relative; font-size:1.6rem; font-weight:800; color:#1e293b; text-shadow:0 1px 2px rgba(0,0,0,0.08); }
                .live-card .lc-metrics { grid-area: metrics; display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; margin-top:4px; }
                .metric-box { background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:8px 6px 10px; text-align:center; box-shadow:0 2px 4px rgba(0,0,0,0.04); }
                .metric-label { font-size:.60rem; font-weight:600; color:#64748b; letter-spacing:.5px; text-transform:uppercase; }
                .metric-value { font-size:1.1rem; font-weight:700; color:#1e293b; line-height:1.1; margin-top:2px; }
                .metric-value.small { font-size:.95rem; }
                .live-card .lc-footer { grid-area: footer; display:flex; justify-content:center; align-items:center; gap:8px; margin-top:8px; }
                
                /* Close Card Button */
                .close-card-btn {
                    background: #ef4444;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    font-size: 0.8rem;
                    box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
                }
                
                .close-card-btn:hover {
                    background: #dc2626;
                    transform: scale(1.05);
                    box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
                }
                
                .close-card-btn:active {
                    transform: scale(0.95);
                }
                
                /* Live Speech Section - Now has dedicated grid area */
                .live-card .lc-speech { grid-area: speech; display: flex; flex-direction: column; min-height: 160px; }
                
                /* Live Speech in Student Cards */
                .live-card .lc-live-speech {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    transition: all 0.4s ease;
                    border-radius: 12px;
                    font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
                    overflow: hidden;
                    position: relative;
                }
                
                .live-card .lc-live-speech:hover {
                    transform: scale(1.01);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                }
                
                .live-card .lc-live-speech.active {
                    animation: speechPulse 2s ease-in-out infinite;
                }
                
                .live-card .lc-live-speech .speech-header {
                    padding: 10px 16px 6px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    border-bottom: 1px solid rgba(0,0,0,0.05);
                    flex-shrink: 0;
                }
                
                .live-card .lc-live-speech .speech-content {
                    flex: 1;
                    padding: 20px;
                    min-height: 120px;
                    overflow: hidden;
                    font-size: 0.9rem;
                    line-height: 1.5;
                    word-break: break-word;
                    position: relative;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                }
                
                .live-card .lc-live-speech .interim-text {
                    margin-top: 8px;
                    padding: 8px 12px;
                    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
                    border-radius: 6px;
                    border-left: 3px solid #6366f1;
                    font-size: 0.8rem;
                    animation: fadeIn 0.3s ease;
                }
                
                .live-card .lc-live-speech .truncation-indicator {
                    font-size: 0.65rem;
                    color: #9ca3af;
                    font-style: italic;
                    margin-top: 4px;
                    text-align: center;
                }
                
                @keyframes speechPulse {
                    0%, 100% { box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1); }
                    50% { box-shadow: 0 8px 24px rgba(59, 130, 246, 0.2), 0 0 0 3px rgba(59, 130, 246, 0.1); }
                }
                
                /* Button Styles */
                .live-card button.detail-btn { 
                    background:#667eea; 
                    color:#fff; 
                    border:none; 
                    padding:10px 16px; 
                    border-radius:10px; 
                    font-size:.75rem; 
                    font-weight:600; 
                    cursor:pointer; 
                    letter-spacing:.5px; 
                    box-shadow:0 4px 10px rgba(102,126,234,.35); 
                    transition:background .25s, transform .25s; 
                }
                .live-card button.detail-btn:hover { 
                    background:#574fd4; 
                    transform:translateY(-2px); 
                }
                
                /* Presentation mode scaling */
                .presentation-mode .live-card { 
                    padding:30px 34px 30px; 
                    grid-template-columns:1fr; 
                    border-radius:30px; 
                    min-height: 520px;
                    grid-template-areas:
                        "progress"
                        "header"
                        "metrics"  
                        "speech"
                        "footer";
                }
                .presentation-mode .progress-circle { width:120px; height:120px; }
                .presentation-mode .progress-circle::after { inset:10px; }
                .presentation-mode .progress-circle .inner { font-size:2.2rem; }
                .presentation-mode .live-card .lc-name { font-size:1.6rem; }
                .presentation-mode .metric-value { font-size:1.9rem; }
                .presentation-mode .metric-label { font-size:.78rem; }
                .presentation-mode .live-card button.detail-btn { font-size:.9rem; padding:14px 22px; }
                .presentation-mode .student-grid { margin-top:34px; }
                .presentation-mode .live-card .lc-speech { min-height: 200px; }
                .presentation-mode .live-card .lc-live-speech .speech-content { 
                    font-size: 1.1rem; 
                    line-height: 1.6; 
                    padding: 24px;
                    min-height: 160px;
                }
                .presentation-toggle-btn { background:linear-gradient(135deg,#6366f1,#8b5cf6); border:none; color:#fff; padding:10px 18px; border-radius:10px; font-size:.75rem; letter-spacing:.5px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; box-shadow:0 4px 14px rgba(99,102,241,.4); }
                .presentation-toggle-btn:hover { filter:brightness(1.08); }
                .presentation-mode .presentation-toggle-btn { background:linear-gradient(135deg,#dc2626,#ef4444); box-shadow:0 4px 14px rgba(220,38,38,.45); }
                .presentation-mode .presentation-toggle-btn:hover { filter:brightness(1.1); }
                
                .hide-no-session-btn { 
                    background: linear-gradient(135deg, #6b7280, #9ca3af); 
                    color: #fff; 
                    border: none; 
                    padding: 10px 18px; 
                    border-radius: 10px; 
                    font-size: .75rem; 
                    font-weight: 600; 
                    cursor: pointer; 
                    letter-spacing: .5px; 
                    display: flex; 
                    align-items: center; 
                    gap: 6px;
                    box-shadow: 0 4px 14px rgba(107, 114, 128, .4); 
                    transition: all .25s ease; 
                }
                .hide-no-session-btn:hover { filter: brightness(1.08); }
                .hide-no-session-btn.active { 
                    background: linear-gradient(135deg, #059669, #10b981); 
                    box-shadow: 0 4px 14px rgba(5, 150, 105, .45); 
                }
                .hide-no-session-btn.active:hover { filter: brightness(1.1); }
        
        .student-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .student-card:hover {
            transform: translateY(-5px);
        }
        
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .student-delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .student-delete-btn:hover {
            background: #dc2626;
        }
        
        .student-delete-btn:active {
            transform: scale(0.95);
        }
        
        .student-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #1e293b;
        }
        
        .student-cohort {
            font-size: 0.9em;
            color: #64748b;
        }
        
        .week-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }
        
        .week-score {
            text-align: center;
            padding: 12px 8px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .week-score.pass {
            background: #dcfce7;
            color: #166534;
        }
        
        .week-score.fail {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .week-score.incomplete {
            background: #f1f5f9;
            color: #64748b;
        }
        /* newly added: in-progress (live but not yet completed) */
        .week-score.progress {
            background: #fef3c7;
            color: #92400e;
            position: relative;
        }
        .week-score.progress::after { /* subtle activity dot */
            content: '';
            position: absolute;
            top: 6px; right: 6px;
            width: 8px; height: 8px;
            background: #f59e0b;
            border-radius: 50%;
            box-shadow: 0 0 0 4px rgba(245,158,11,.25);
            animation: pulseDot 1.8s ease-in-out infinite;
        }
        @keyframes pulseDot { 0%{ transform: scale(.85); opacity:.9;} 50%{ transform: scale(1.25); opacity:.4;} 100%{ transform: scale(.85); opacity:.9;} }
        
        /* Live Speech Animations */
        @keyframes pulse { 
            0% { transform: scale(1); opacity: 1; } 
            50% { transform: scale(1.2); opacity: 0.7; } 
            100% { transform: scale(1); opacity: 1; } 
        }
        @keyframes fadeIn { 
            0% { opacity: 0; transform: translateY(-10px); } 
            100% { opacity: 1; transform: translateY(0); } 
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
            
            .top-bar {
                padding: 15px 20px;
            }
            
            .page-title {
                font-size: 1.5em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Live Speech Monitoring */
        .recording-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #6b7280;
            display: inline-block;
            margin-left: 8px;
        }
        
        .recording-dot.active {
            background: #ef4444;
            animation: pulse 1s infinite;
        }
        
        /* Live Transcript Viewer Styles */
        .badge.recording {
            background: #ef4444;
            color: white;
            animation: pulse 1s infinite;
        }
        
        #liveTranscriptContainer {
            transition: border-color 0.3s ease;
        }
        
        #liveTranscriptContainer:hover {
            border-color: #9ca3af;
        }
        
        #liveInterimText {
            border-left: 3px solid #6366f1;
            background: #eff6ff;
            color: #6366f1;
            padding: 8px;
            border-radius: 4px;
            font-style: italic;
            margin-top: 8px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .live-speech-session {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }
        
        .live-speech-session.active {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .live-speech-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .live-speech-student {
            font-weight: 600;
            color: #1f2937;
        }
        
        .live-speech-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .live-speech-status.recording {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .live-speech-status.stopped {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .live-speech-transcript {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            min-height: 60px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .live-speech-interim {
            color: #6b7280;
            font-style: italic;
        }
        
        .live-speech-final {
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div id="connectionStatusBanner" class="connection-status disconnected">🔴 Disconnected</div>

    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <h1>🏥 N10L Admin</h1>
            <p>Comprehensive Academic Management System</p>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" required placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required placeholder="Enter your password">
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
            </form>
            <div id="loginError" class="error-message"></div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardWrapper" class="dashboard-wrapper">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>🏥 N10L Admin</h2>
                <p>Academic Management</p>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item active" data-section="overview">
                    <i class="fas fa-chart-line"></i>
                    <span>Overview</span>
                </div>
                <div class="nav-item" data-section="semesters">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Semester Management</span>
                </div>
                <div class="nav-item" data-section="cohorts">
                    <i class="fas fa-users"></i>
                    <span>Class Cohorts</span>
                </div>
                <div class="nav-item" data-section="students">
                    <i class="fas fa-user-graduate"></i>
                    <span>Student Progress</span>
                </div>
                <div class="nav-item" data-section="evaluations">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Evaluation Results</span>
                </div>
                <div class="nav-item" data-section="speech">
                    <i class="fas fa-microphone"></i>
                    <span>Speech Transcriptions</span>
                </div>
                <div class="nav-item" data-section="live">
                    <i class="fas fa-broadcast-tower"></i>
                    <span>Live Monitoring</span>
                </div>
                <div class="nav-item" data-section="reports">
                    <i class="fas fa-file-alt"></i>
                    <span>Reports & Analytics</span>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <h1 class="page-title" id="pageTitle">Dashboard Overview</h1>
                <div class="connection-indicator">
                    <div id="connectionDot" class="connection-dot disconnected"></div>
                    <span id="connectionStatusText" class="connection-status disconnected">Connecting...</span>
                </div>
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span id="userName">Admin User</span>
                    <button class="logout-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Overview Section -->
            <div id="overviewSection" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="totalSemesters">0</div>
                                <div class="stat-label">Active Semester</div>
                            </div>
                            <div class="stat-icon blue">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="activeCohorts">0</div>
                                <div class="stat-label">Active Cohorts</div>
                            </div>
                            <div class="stat-icon green">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="totalStudents">0</div>
                                <div class="stat-label">Enrolled Students</div>
                            </div>
                            <div class="stat-icon purple">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="completedEvaluations">0</div>
                                <div class="stat-label">Completed Evaluations</div>
                            </div>
                            <div class="stat-icon orange">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="semester-overview" id="semesterOverview">
                    <!-- Semester cards will be populated here -->
                </div>
            </div>

            <!-- Semester Management Section -->
            <div id="semestersSection" class="content-section">
                <div class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">Semester Management</h2>
                        <button class="btn" onclick="openNewSemesterModal()">
                            <i class="fas fa-plus"></i> Create New Semester
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="semestersTable">
                            <thead>
                                <tr>
                                    <th>Semester Name</th>
                                    <th>Code</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Cohorts</th>
                                    <th>Students</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Cohorts Section -->
            <div id="cohortsSection" class="content-section">
                <div class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">Class Cohorts</h2>
                        <button class="btn" onclick="openNewCohortModal()">
                            <i class="fas fa-plus"></i> Create New Cohort
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="cohortsTable">
                            <thead>
                                <tr>
                                    <th>Cohort Name</th>
                                    <th>Semester</th>
                                    <th>Instructor</th>
                                    <th>Students</th>
                                    <th>Capacity</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Students Section -->
            <div id="studentsSection" class="content-section">
                <div class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">Student Progress Tracking</h2>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <select id="filterSemester" style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
                                <option value="">All Semesters</option>
                            </select>
                            <select id="filterCohort" style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
                                <option value="">All Cohorts</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadStudentProgress()">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                            <button class="btn" style="background:#2563eb;" onclick="forceRefreshProgress()" title="Reload progress + evaluations">
                                <i class="fas fa-sync"></i> Sync
                            </button>
                            <input id="cleanupStudentName" placeholder="Test user name" style="padding:8px 10px; border:1px solid #e5e7eb; border-radius:6px; font-size:.75rem; width:140px;" title="Enter a non-enrolled test student's exact name">
                            <button class="btn btn-danger" style="padding:8px 12px; font-size:.7rem;" onclick="cleanupStudent()" title="Remove all evaluation/live data for this test name"><i class="fas fa-user-slash"></i></button>
                        </div>
                    </div>
                    <div id="studentProgressContainer" class="student-grid">
                        <!-- Student progress cards will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Evaluations Section -->
            <div id="evaluationsSection" class="content-section">
                <div class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">Evaluation Results</h2>
                        <button class="btn btn-secondary" onclick="exportEvaluations()">
                            <i class="fas fa-download"></i> Export Results
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="evaluationsTable">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Week</th>
                                    <th>Scenario</th>
                                    <th>Score</th>
                                    <th>Status</th>
                                    <th>Completed</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="failedItemsPanel" class="section-card" style="display:none; margin-top:20px;">
                    <div class="section-header">
                        <h2 class="section-title">Failed Items (Remediation Focus)</h2>
                        <div style="display:flex; gap:10px;">
                            <input id="failedFilterStudent" placeholder="Filter by student" style="padding:8px 12px; border:1px solid #e5e7eb; border-radius:6px;" />
                            <button class="btn btn-secondary" onclick="loadFailedItems()"><i class="fas fa-filter"></i> Refresh</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="failedItemsTable">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Week</th>
                                    <th>Section</th>
                                    <th>Item</th>
                                    <th>Completed</th>
                                    <th>Score %</th>
                                    <th>Session</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Speech Transcriptions Section -->
            <div id="speechSection" class="content-section">
                <div class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">Speech Transcriptions</h2>
                        <div style="display:flex; gap:12px; align-items:center;">
                            <button type="button" class="btn btn-secondary" onclick="refreshSpeechTranscriptions()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <span class="badge active" id="speechCount">0 transcriptions</span>
                        </div>
                    </div>
                    
                    <!-- Speech Filters -->
                    <div style="display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap;">
                        <input type="text" placeholder="Filter by student name..." 
                               style="padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; min-width:200px;"
                               id="speechStudentFilter" onchange="filterSpeechTranscriptions()">
                        <select style="padding:8px 12px; border:1px solid #d1d5db; border-radius:6px;"
                                id="speechCourseFilter" onchange="filterSpeechTranscriptions()">
                            <option value="">All Courses</option>
                            <option value="1">Personal Care</option>
                            <option value="2">Medication Administration</option>
                            <option value="3">Vital Signs</option>
                            <option value="4">Wound Care</option>
                            <option value="5">Emergency Response</option>
                        </select>
                        <select style="padding:8px 12px; border:1px solid #d1d5db; border-radius:6px;"
                                id="speechTypeFilter" onchange="filterSpeechTranscriptions()">
                            <option value="">All Types</option>
                            <option value="true">Final</option>
                            <option value="false">Interim</option>
                        </select>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table" id="speechTable">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Course</th>
                                    <th>Session ID</th>
                                    <th>Type</th>
                                    <th>Duration</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="speechTableBody">
                                <tr><td colspan="7" style="text-align:center; color:#6b7280;">Loading speech transcriptions...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Live Monitoring Section -->
            <div id="liveSection" class="content-section">
                <div class="section-card">
                    <div class="section-header">
                                                <div style="display:flex; flex-direction:column; gap:6px;">
                                                    <h2 class="section-title" style="margin:0;">Live Student Activity</h2>
                                                    <div id="liveScenarioTitles" style="font-size:.75rem; font-weight:600; letter-spacing:.5px; color:#475569; display:flex; flex-wrap:wrap; gap:6px;"></div>
                                                </div>
                        <div style="display:flex; gap:12px; align-items:center;">
                            <!-- Layout Options -->
                            <div style="display:flex; gap:6px; border:1px solid #e2e8f0; border-radius:8px; padding:4px; background:#f8fafc;">
                                <button type="button" class="layout-btn active" data-layout="auto" title="Auto-fit layout" onclick="setCardLayout('auto')">
                                    <i class="fas fa-th"></i>
                                </button>
                                <button type="button" class="layout-btn" data-layout="fixed-2" title="2 cards per row" onclick="setCardLayout('fixed-2')">
                                    <i class="fas fa-th-large"></i> 2
                                </button>
                                <button type="button" class="layout-btn" data-layout="fixed-3" title="3 cards per row" onclick="setCardLayout('fixed-3')">
                                    <i class="fas fa-th"></i> 3
                                </button>
                                <button type="button" class="layout-btn" data-layout="fixed-4" title="4 cards per row" onclick="setCardLayout('fixed-4')">
                                    <i class="fas fa-th"></i> 4
                                </button>
                                <button type="button" class="layout-btn" data-layout="compact" title="Compact view" onclick="setCardLayout('compact')">
                                    <i class="fas fa-compress-alt"></i>
                                </button>
                                <button type="button" class="layout-btn" data-layout="list" title="List view" onclick="setCardLayout('list')">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                            <button type="button" class="hide-no-session-btn" onclick="toggleHideNoSession()" id="hideNoSessionToggle">
                                <i class="fas fa-eye-slash"></i> Hide No Session
                            </button>
                            <button type="button" class="presentation-toggle-btn" onclick="togglePresentationMode()" id="presentationToggle">
                                <i class="fas fa-expand"></i> Presentation Mode
                            </button>
                            <span class="badge active" id="liveStudentCount">0 Active</span>
                        </div>
                    </div>
                    <div id="liveStudentGrid" class="student-grid-auto">
                        <!-- Live student cards will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="content-section">
                <div class="stats-grid">
                    <div class="stat-card" onclick="generateReport('semester-summary')" style="cursor: pointer;">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value">📊</div>
                                <div class="stat-label">Semester Summary</div>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" onclick="generateReport('student-performance')" style="cursor: pointer;">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value">📈</div>
                                <div class="stat-label">Student Performance</div>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" onclick="generateReport('weekly-analytics')" style="cursor: pointer;">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value">⏱️</div>
                                <div class="stat-label">Weekly Analytics</div>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" onclick="generateReport('completion-rates')" style="cursor: pointer;">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value">✅</div>
                                <div class="stat-label">Completion Rates</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="reportResults" class="section-card" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title" id="reportTitle">Report Results</h2>
                        <button class="btn btn-secondary" onclick="exportReportPDF()">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                    </div>
                    <div id="reportContent" class="table-container">
                        <!-- Report content will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Semester Modal -->
    <div id="semesterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Semester</h2>
                <button class="close" onclick="closeSemesterModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="semesterForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="semesterName">Semester Name</label>
                            <input type="text" id="semesterName" required placeholder="e.g., Spring 2026">
                        </div>
                        <div class="form-group">
                            <label for="semesterCode">Semester Code</label>
                            <input type="text" id="semesterCode" required placeholder="e.g., S2026">
                        </div>
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate" required>
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="date" id="endDate" required>
                        </div>
                    </div>
                    <div style="margin-top: 30px; text-align: right;">
                        <button type="button" class="btn btn-secondary" onclick="closeSemesterModal()" style="margin-right: 15px;">Cancel</button>
                        <button type="submit" class="btn">
                            <i class="fas fa-plus"></i> Create Semester
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- New Cohort Modal -->
    <div id="cohortModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Cohort</h2>
                <button class="close" onclick="closeCohortModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="newCohortForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="cohortSemester">Semester <span style="color: red;">*</span></label>
                            <div style="position: relative;">
                                <input type="text" id="cohortSemester" name="semester_name_input" list="semesterOptions" required 
                                       placeholder="Type semester (e.g., Fall 2030) or select existing"
                                       style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                                <datalist id="semesterOptions">
                                    <!-- Options will be populated by JavaScript -->
                                </datalist>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cohortName">Cohort Name <span style="color: red;">*</span></label>
                            <input type="text" id="cohortName" name="cohort_name_input" required placeholder="e.g., Spring 2026 Nursing Cohort A">
                        </div>
                        <div class="form-group">
                            <label for="cohortCode">Cohort Code <span style="color: red;">*</span></label>
                            <input type="text" id="cohortCode" name="cohort_code_input" required placeholder="e.g., S26-A">
                        </div>
                        <div class="form-group">
                            <label for="instructorName">Instructor Name</label>
                            <input type="text" id="instructorName" name="instructor_name_input" placeholder="e.g., Dr. Healthcare">
                        </div>
                        <div class="form-group">
                            <label for="maxStudents">Max Students</label>
                            <input type="number" id="maxStudents" name="max_students_input" value="30" min="1" max="100">
                        </div>
                    </div>
                    <div style="margin-top: 30px; text-align: right;">
                        <button type="button" class="btn btn-secondary" onclick="closeCohortModal()" style="margin-right: 15px;">Cancel</button>
                        <button type="submit" class="btn">
                            <i class="fas fa-plus"></i> Create Cohort
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const BASE_PATH = location.pathname.toLowerCase().startsWith('/n10lvoice/') ? '/N10LVoice' : '';
        const API_BASE = `${BASE_PATH}/api`;
        const SOCKET_PATH = `${BASE_PATH}/socket.io`;

        // Global state
        let socket = null;
        let authToken = localStorage.getItem('adminToken');
        let currentUser = null;
        let semesters = [];
        let cohorts = [];
        let students = new Map();
        let studentSpeechData = new Map(); // Track live speech for each student
        let evaluationCache = null; // cached completed evaluations for enrichment
        let hideNoSession = false; // Track filter state for hiding "No Session" entries

        // Connection robustness variables
        let connectionRetryCount = 0;
        let connectionHealthTimer = null;
        let lastPingTime = null;
        const MAX_RETRY_ATTEMPTS = 5;
        const CONNECTION_HEALTH_INTERVAL = 30000; // 30 seconds
        const PING_TIMEOUT = 10000; // 10 seconds

        console.log('🎓 N10L Comprehensive Admin Dashboard loaded');

        // DOM elements
        const loginContainer = document.getElementById('loginContainer');
        const dashboardWrapper = document.getElementById('dashboardWrapper');
        const connectionStatusBanner = document.getElementById('connectionStatusBanner');
        const connectionStatusText = document.getElementById('connectionStatusText');
        const connectionDot = document.getElementById('connectionDot');
        const pageTitle = document.getElementById('pageTitle');

        // Check if already logged in
        if (authToken) {
            console.log('🔑 Found existing auth token, connecting...');
            connectSocket();
        }

        // Login form handler (hardened to avoid TypeError when non-admin response)
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('🔑 Login attempt');

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                let data = {};
                try { data = await response.json(); } catch { data = {}; }

                if (!response.ok) {
                    showError(data.error || 'Login failed');
                    return;
                }

                if (data && data.user && data.user.role === 'admin' && data.token) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('adminToken', authToken);
                    connectSocket(true);
                    return;
                }
                if (data && data.role === 'student') {
                    showError('Student credentials detected. Use scenario pages, not admin portal.');
                    return;
                }
                showError('Admin access required');
            } catch (error) {
                console.error('❌ Login error:', error);
                showError('Connection error. Please try again.');
            }
        });

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                switchSection(section);
                
                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
            });
        });

        function switchSection(section) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            
            // Show selected section
            document.getElementById(section + 'Section').classList.add('active');
            
            // Update page title
            const titles = {
                overview: 'Dashboard Overview',
                semesters: 'Semester Management',
                cohorts: 'Class Cohorts',
                students: 'Student Progress',
                evaluations: 'Evaluation Results',
                speech: 'Speech Transcriptions',
                live: 'Live Monitoring',
                reports: 'Reports & Analytics'
            };
            
            pageTitle.textContent = titles[section] || 'Dashboard';
            
            // Show loading indicator
            showSectionLoadingIndicator(section);
            
            // Force refresh data for each section (clear caches if needed)
            switch(section) {
                case 'overview':
                    loadOverviewData(true); // true = force refresh
                    break;
                case 'semesters':
                    loadSemesters(true);
                    break;
                case 'cohorts':
                    loadCohorts(true);
                    break;
                case 'students':
                    // Clear evaluation cache to get fresh data
                    evaluationCache = null;
                    loadStudentProgress(true);
                    break;
                case 'evaluations':
                    // Clear evaluation cache for fresh results
                    evaluationCache = null;
                    loadEvaluationResults(true);
                    break;
                case 'speech':
                    loadSpeechTranscriptions(true);
                    break;
                case 'live':
                    loadLiveActivity(true);
                    break;
            }
        }

        // Socket connection
        function connectSocket(forceFresh = false) {
            if (!authToken) return;

            if (!forceFresh && !socket) {
                validateAdminToken();
            }

            // Disconnect existing socket if present
            if (socket && socket.connected) {
                socket.disconnect();
            }

            console.log('🔌 Establishing robust admin socket connection...');
            socket = io({ 
                path: SOCKET_PATH, 
                auth: { token: authToken },
                // Enhanced connection settings for robustness
                timeout: 20000,
                reconnection: true,
                reconnectionAttempts: MAX_RETRY_ATTEMPTS,
                reconnectionDelay: 2000,
                reconnectionDelayMax: 10000,
                maxReconnectionAttempts: MAX_RETRY_ATTEMPTS,
                randomizationFactor: 0.5,
                forceNew: forceFresh
            });

            socket.on('connect', () => {
                console.log('✅ Admin socket connected to server');
                console.log('🔗 Socket ID:', socket.id);
                console.log('🎫 Auth token present:', !!authToken);
                
                // Reset retry counter on successful connection
                connectionRetryCount = 0;
                
                updateConnectionStatus(true);
                showDashboard();
                loadInitialData();
                
                // Start connection health monitoring
                startConnectionHealthMonitoring();
                
                // Send initial ping to verify bidirectional communication
                sendConnectionPing();
            });

            socket.on('disconnect', (reason) => {
                console.log('❌ Admin socket disconnected from server:', reason);
                updateConnectionStatus(false);
                stopConnectionHealthMonitoring();
                
                // Handle different disconnect reasons
                if (reason === 'io server disconnect') {
                    // Server initiated disconnect - try to reconnect after delay
                    console.log('🔄 Server initiated disconnect, scheduling reconnection...');
                    setTimeout(() => {
                        if (!socket.connected && connectionRetryCount < MAX_RETRY_ATTEMPTS) {
                            connectionRetryCount++;
                            console.log(`🔄 Reconnection attempt ${connectionRetryCount}/${MAX_RETRY_ATTEMPTS}`);
                            connectSocket(true);
                        }
                    }, 3000);
                }
            });

            socket.on('reconnect', (attemptNumber) => {
                console.log(`✅ Admin socket reconnected after ${attemptNumber} attempts`);
                connectionRetryCount = 0;
                updateConnectionStatus(true);
                startConnectionHealthMonitoring();
                sendConnectionPing();
            });

            socket.on('reconnect_attempt', (attemptNumber) => {
                console.log(`🔄 Admin socket reconnection attempt ${attemptNumber}`);
                updateConnectionStatus(false, `Reconnecting... (${attemptNumber}/${MAX_RETRY_ATTEMPTS})`);
            });

            socket.on('reconnect_failed', () => {
                console.error('❌ Admin socket reconnection failed after maximum attempts');
                updateConnectionStatus(false, 'Connection failed - refresh page');
                showNotification('Connection lost. Please refresh the page.', 'error');
            });

            socket.on('connect_error', (error) => {
                console.error('❌ Connection error:', error);
                connectionRetryCount++;
                
                if (error && /auth|invalid/i.test(error.message || '')) {
                    showNotification('Session expired. Please log in again.', 'warning');
                    logout();
                } else if (connectionRetryCount >= MAX_RETRY_ATTEMPTS) {
                    showNotification('Unable to connect to server. Please check your internet connection.', 'error');
                    updateConnectionStatus(false, 'Connection failed');
                }
            });

            // Add ping/pong for connection health monitoring
            socket.on('admin-pong', (data = {}) => {
                const pingTime = Date.now() - lastPingTime;
                console.log(`🏓 Pong received, latency: ${pingTime}ms`);
                const displayLatency = typeof data.latency === 'number' ? data.latency : pingTime;
                updateConnectionStatus(true, `Connected (${displayLatency}ms)`);
                lastPingTime = null;
            });

            // Enhanced error handling for speech events
            socket.on('connect_timeout', () => {
                console.error('❌ Socket connection timeout');
                updateConnectionStatus(false, 'Connection timeout');
            });

            // Real-time updates
            socket.on('student-connected', (data) => {
                students.set(data.username, data);
                updateLiveActivity();
            });

            socket.on('student-disconnected', (data) => {
                students.set(data.username, data);
                updateLiveActivity();
            });

            socket.on('evaluation-completed', (data) => {
                updateOverviewStats();
                updateLiveActivity();
            });

            // Live per-student incremental progress updates
            socket.on('student-progress-update', (list) => {
                try {
                    if (Array.isArray(list)) {
                        list.forEach(s => {
                            if (!s || !s.username) return;
                            students.set(s.username, {
                                ...students.get(s.username),
                                ...s
                            });
                        });
                        updateLiveActivity();
                    }
                } catch (e) {
                    console.error('Error processing student-progress-update', e);
                }
            });

            // Real-time speech monitoring events - Enhanced for multiple students
            socket.on('student-speech-start', (data) => {
                console.log('🎤 Admin received speech-start:', data);
                // Update speech session tracking
                updateLiveSpeechSession(data.sessionId, {
                    ...data,
                    status: 'recording',
                    transcript: '',
                    interim: ''
                });
                
                // Track speech data per student
                updateStudentSpeechData(data.studentName, {
                    type: 'start',
                    sessionId: data.sessionId,
                    status: 'recording',
                    transcript: '',
                    interim: '',
                    lastUpdate: new Date()
                });
                
                // Initialize live speech stream for continuous scrolling
                setTimeout(() => {
                    initializeLiveSpeechStream(data.studentName);
                }, 100); // Small delay to ensure DOM is ready
                
                // Update student card with speech status
                updateLiveActivity();
            });

            socket.on('student-speech-update', (data) => {
                console.log('🔄 Admin received speech-update:', data);
                // Update speech session tracking
                updateLiveSpeechSession(data.sessionId, {
                    ...data,
                    status: 'recording'
                });
                
                // Track speech data per student with error handling
                try {
                    updateStudentSpeechData(data.studentName, {
                        type: 'update',
                        sessionId: data.sessionId,
                        status: 'recording',
                        transcript: data.finalTranscript || '',
                        interim: data.interimTranscript || data.latestInterim || '',
                        lastUpdate: new Date()
                    });
                    
                    // Update live speech stream with continuous scrolling
                    updateLiveSpeechStream(data.studentName, {
                        transcript: data.finalTranscript || '',
                        interim: data.interimTranscript || data.latestInterim || ''
                    });
                    
                    // Update student card with live speech (less frequently to avoid rebuilding)
                    // Only update every 3rd update to reduce DOM churn
                    if (!window.speechUpdateCounter) window.speechUpdateCounter = {};
                    window.speechUpdateCounter[data.studentName] = (window.speechUpdateCounter[data.studentName] || 0) + 1;
                    
                    if (window.speechUpdateCounter[data.studentName] % 3 === 0) {
                        updateLiveActivity();
                    }
                } catch (error) {
                    console.error('Error updating student speech:', error, data);
                }
            });

            socket.on('student-speech-stop', (data) => {
                console.log('🛑 Admin received speech-stop:', data);
                // Update speech session tracking
                updateLiveSpeechSession(data.sessionId, {
                    ...data,
                    status: 'stopped'
                });
                
                // Track speech data per student
                updateStudentSpeechData(data.studentName, {
                    type: 'stop',
                    sessionId: data.sessionId,
                    status: 'stopped',
                    transcript: data.finalTranscript || '',
                    interim: '',
                    lastUpdate: new Date()
                });
                
                // Clear live speech stream
                setTimeout(() => {
                    clearSpeechStream(data.studentName);
                }, 2000); // Small delay before clearing
                
                // Update student card
                updateLiveActivity();
                
                // Remove session after delay
                setTimeout(() => {
                    removeLiveSpeechSession(data.sessionId);
                    // Clear student speech data after longer delay
                    setTimeout(() => {
                        clearStudentSpeechData(data.studentName);
                        updateLiveActivity();
                    }, 30000); // Keep for 30 seconds after stop
                }, 5000);
            });

            socket.on('student-speech-save', (data) => {
                console.log('Speech saved:', data);
                showNotification(`Speech transcript saved by ${data.studentName}`, 'success');
            });

            // Admin test response handler
            socket.on('admin-test-response', (data) => {
                console.log('🧪 Admin test response received:', data);
                showNotification(`Socket test successful! Connected admins: ${data.connectedAdmins}, Active students: ${data.activeStudents}`, 'success');
            });
        }

        // Connection Health Monitoring Functions
        function startConnectionHealthMonitoring() {
            stopConnectionHealthMonitoring(); // Clear any existing timer
            
            connectionHealthTimer = setInterval(() => {
                if (socket && socket.connected) {
                    sendConnectionPing();
                } else {
                    console.warn('⚠️ Socket not connected during health check');
                    updateConnectionStatus(false, 'Disconnected');
                    
                    // Attempt reconnection if socket is not connected
                    if (connectionRetryCount < MAX_RETRY_ATTEMPTS) {
                        connectionRetryCount++;
                        console.log(`🔄 Health check reconnection attempt ${connectionRetryCount}`);
                        connectSocket(true);
                    }
                }
            }, CONNECTION_HEALTH_INTERVAL);
        }

        function stopConnectionHealthMonitoring() {
            if (connectionHealthTimer) {
                clearInterval(connectionHealthTimer);
                connectionHealthTimer = null;
            }
        }

        function sendConnectionPing() {
            if (socket && socket.connected) {
                lastPingTime = Date.now();
                socket.emit('admin-ping', { timestamp: lastPingTime, type: 'health-check' });
                
                // Set timeout to detect ping failures
                setTimeout(() => {
                    if (lastPingTime && (Date.now() - lastPingTime) > PING_TIMEOUT) {
                        console.warn('⚠️ Ping timeout - connection may be unstable');
                        updateConnectionStatus(false, 'Connection unstable');
                    }
                }, PING_TIMEOUT);
            }
        }

        // Enhanced connection status display
        function updateConnectionStatus(connected, message = '') {
            const statusText = message || (connected ? 'Connected' : 'Disconnected');
            const bannerText = `${connected ? '🟢' : '🔴'} ${statusText}`;

            if (connectionStatusBanner) {
                connectionStatusBanner.textContent = bannerText;
                connectionStatusBanner.classList.toggle('connected', connected);
                connectionStatusBanner.classList.toggle('disconnected', !connected);
            }

            if (connectionStatusText) {
                connectionStatusText.textContent = statusText;
                connectionStatusText.classList.toggle('connected', connected);
                connectionStatusText.classList.toggle('disconnected', !connected);
            }

            if (connectionDot) {
                connectionDot.classList.toggle('connected', connected);
                connectionDot.classList.toggle('disconnected', !connected);
            }
        }

        function showDashboard() {
            loginContainer.style.display = 'none';
            dashboardWrapper.style.display = 'block';
            
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.full_name || currentUser.username;
                document.getElementById('userAvatar').textContent = (currentUser.full_name || currentUser.username).charAt(0).toUpperCase();
            }
            
            // Load saved card layout preference
            setTimeout(() => {
                loadSavedLayout();
            }, 100);
        }

        // Load initial data
        async function loadInitialData() {
            console.log('📊 Loading initial dashboard data');
            await Promise.all([
                loadSemesters(),
                loadCohorts(),
                loadOverviewData()
            ]);
        }

        // Load overview data
        async function loadOverviewData(forceRefresh = false) {
            console.log(`📊 Loading overview data (${forceRefresh ? 'refreshed' : 'cached'})`);
            try {
                // Load stats with optional cache busting
                const timestampParam = forceRefresh ? `?_t=${Date.now()}` : '';
                const [semesterData, cohortData] = await Promise.all([
                    fetch(`${API_BASE}/academic/semesters${timestampParam}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }).then(r => r.json()),
                    fetch(`${API_BASE}/academic/cohorts${timestampParam}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }).then(r => r.json())
                ]);

                semesters = semesterData;
                cohorts = cohortData;

                // Update stats - focus on active semester only
                const activeSemester = semesterData.find(s => s.is_active);
                const activeSemesterCohorts = cohortData.filter(c => c.semester_id === activeSemester?.id && c.is_active);
                
                document.getElementById('totalSemesters').textContent = activeSemester ? '1' : '0';
                document.getElementById('activeCohorts').textContent = activeSemesterCohorts.length;
                document.getElementById('totalStudents').textContent = activeSemesterCohorts.reduce((sum, c) => sum + (c.student_count || 0), 0);

                // Update semester overview
                updateSemesterOverview();
                
                console.log('✅ Overview data loading complete');
            } catch (error) {
                console.error('❌ Error loading overview data:', error);
            }
        }

        function updateSemesterOverview() {
            const container = document.getElementById('semesterOverview');
            container.innerHTML = '';

            // Show only active semester
            const activeSemester = semesters.find(s => s.is_active);
            if (!activeSemester) {
                container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No active semester found.</p>';
                return;
            }

            const semesterCohorts = cohorts.filter(c => c.semester_id === activeSemester.id);
            const totalStudents = semesterCohorts.reduce((sum, c) => sum + (c.student_count || 0), 0);

            const card = document.createElement('div');
            card.className = 'semester-card';
            card.innerHTML = `
                <div class="semester-card-header">
                    <div class="semester-card-title">${activeSemester.semester_name}</div>
                    <div class="semester-card-subtitle">Current Active Semester</div>
                </div>
                <div class="semester-card-body">
                    <div class="semester-stats">
                        <div class="semester-stat">
                            <div class="semester-stat-value">${semesterCohorts.length}</div>
                            <div class="semester-stat-label">Active Cohorts</div>
                        </div>
                        <div class="semester-stat">
                            <div class="semester-stat-value">${totalStudents}</div>
                            <div class="semester-stat-label">Students Enrolled</div>
                        </div>
                        <div class="semester-stat">
                            <div class="semester-stat-value">5</div>
                            <div class="semester-stat-label">Evaluation Weeks</div>
                        </div>
                    </div>
                    <div class="week-progress">
                        <div class="week-item">Week 1</div>
                        <div class="week-item">Week 2</div>
                        <div class="week-item">Week 3</div>
                        <div class="week-item">Week 4</div>
                        <div class="week-item">Week 5</div>
                    </div>
                </div>
            `;
            container.appendChild(card);
        }

        // Load semesters
        async function loadSemesters(forceRefresh = false) {
            try {
                if(!authToken) return;
                
                // Add cache busting for force refresh
                const url = forceRefresh ? 
                    `${API_BASE}/academic/semesters?_t=${Date.now()}` : 
                    `${API_BASE}/academic/semesters`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    semesters = await response.json();
                    populateSemestersTable();
                    populateSelectors();
                    hideSectionLoadingIndicator('semesters');
                    console.log(`✅ Semesters loaded (${forceRefresh ? 'refreshed' : 'cached'})`);
                } else if (response.status === 401 || response.status === 403) {
                    showNotification('Session invalid. Please log in again.', 'warning');
                    logout();
                }
            } catch (error) {
                console.error('❌ Error loading semesters:', error);
                hideSectionLoadingIndicator('semesters');
            }
        }

        function populateSemestersTable() {
            const tbody = document.querySelector('#semestersTable tbody');
            tbody.innerHTML = '';
            
            semesters.forEach(semester => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${semester.semester_name}</strong></td>
                    <td><span class="badge ${semester.is_active ? 'active' : 'inactive'}">${semester.semester_code}</span></td>
                    <td>${new Date(semester.start_date).toLocaleDateString()} - ${new Date(semester.end_date).toLocaleDateString()}</td>
                    <td><span class="badge ${semester.is_active ? 'active' : 'inactive'}">${semester.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>${semester.cohort_count || 0}</td>
                    <td>${semester.student_count || 0}</td>
                    <td>
                                                <div style="display:flex; gap:6px;">
                                                      <button type="button" class="btn btn-secondary" onclick="toggleSemesterStatus(${semester.id}, ${semester.is_active})" style="padding: 6px 12px; font-size: 0.7em;">
                                                            ${semester.is_active ? 'Deactivate' : 'Activate'}
                                                    </button>
                                                      <button type="button" class="btn btn-danger" onclick="deleteSemester(${semester.id}, ${semester.cohort_count || 0})" style="padding: 6px 12px; font-size: 0.7em; background:#dc2626;">
                                                            Delete
                                                    </button>
                                                </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function toggleSemesterStatus(id, currentlyActive) {
            if (!authToken) return;
            try {
                console.log('🔄 Toggling semester status', { id, currentlyActive });
                const endpoint = `${API_BASE}/academic/semesters/${id}/${currentlyActive ? 'deactivate' : 'activate'}`;
                const resp = await fetch(endpoint, { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}` }});
                console.log('📡 Toggle response status', resp.status);
                if (!resp.ok) {
                    const txt = await resp.text();
                    showNotification('Failed to update semester: ' + txt, 'error');
                    return;
                }
                showNotification(`Semester ${currentlyActive ? 'deactivated' : 'activated'} successfully`, 'success');
                await loadSemesters();
            } catch (e) {
                console.error('Toggle semester error', e);
                showNotification('Error updating semester', 'error');
            }
        }

        async function deleteSemester(id, cohortCount) {
            if (cohortCount > 0) {
                showNotification('Remove or reassign cohorts before deleting semester', 'error');
                return;
            }
            const phrase = 'delete semester';
            const typed = prompt(`Type "${phrase}" to permanently delete this semester:`);
            if (!typed || typed.toLowerCase().trim() !== phrase) {
                showNotification('Deletion cancelled', 'warning');
                return;
            }
            try {
                const resp = await fetch(`${API_BASE}/academic/semesters/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${authToken}` }});
                if (!resp.ok) {
                    const txt = await resp.text();
                    showNotification('Failed to delete semester: ' + txt, 'error');
                    return;
                }
                showNotification('Semester deleted', 'success');
                await loadSemesters();
            } catch (e) {
                console.error('Delete semester error', e);
                showNotification('Error deleting semester', 'error');
            }
        }
    // (Removed stray prefill block; handled inside populateSelectors())
        // Load cohorts
        async function loadCohorts(forceRefresh = false) {
            try {
                if(!authToken) return;
                
                const url = forceRefresh ? 
                    `${API_BASE}/academic/cohorts?_t=${Date.now()}` : 
                    `${API_BASE}/academic/cohorts`;
                
                const response = await fetch(url, {  
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    cohorts = await response.json();
                    populateCohortsTable();
                    hideSectionLoadingIndicator('cohorts');
                    console.log(`✅ Cohorts loaded (${forceRefresh ? 'refreshed' : 'cached'})`);
                } else if (response.status === 401 || response.status === 403) {
                    showNotification('Session invalid. Please log in again.', 'warning');
                    logout();
                }
            } catch (error) {
                console.error('❌ Error loading cohorts:', error);
                hideSectionLoadingIndicator('cohorts');
            }
        }

        function populateCohortsTable() {
            const tbody = document.querySelector('#cohortsTable tbody');
            tbody.innerHTML = '';
            
            cohorts.forEach(cohort => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${cohort.cohort_name}</strong></td>
                    <td>${cohort.semester_name}</td>
                    <td>${cohort.instructor_name || 'Not assigned'}</td>
                    <td>${cohort.student_count || 0}</td>
                    <td>${cohort.max_students}</td>
                    <td><span class="badge ${cohort.is_active ? 'active' : 'inactive'}">${cohort.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn btn-secondary" onclick="manageCohort(${cohort.id})" style="padding: 6px 12px; font-size: 0.8em;">
                            <i class="fas fa-edit"></i> Manage
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function populateSelectors() {
            // Populate semester input with datalist options
            const cohortSemesterInput = document.getElementById('cohortSemester');
            const datalist = document.getElementById('semesterOptions');
            datalist.innerHTML = '';
            semesters.forEach(semester => {
                const option = document.createElement('option');
                option.value = semester.semester_name;
                option.setAttribute('data-id', semester.id);
                datalist.appendChild(option);
            });

            // Populate filter semester dropdown
            const filterSelect = document.getElementById('filterSemester');
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="">Select Semester</option>';
                semesters.forEach(semester => {
                    const option = document.createElement('option');
                    option.value = semester.id;
                    option.textContent = semester.semester_name;
                    filterSelect.appendChild(option);
                });
            }

            // Populate cohort selector
            const cohortSelect = document.getElementById('filterCohort');
            cohortSelect.innerHTML = '<option value="">All Cohorts</option>';
            cohorts.forEach(cohort => {
                const option = document.createElement('option');
                option.value = cohort.id;
                option.textContent = cohort.cohort_name;
                cohortSelect.appendChild(option);
            });
        }

        // Modal functions
        function openNewSemesterModal() {
            document.getElementById('semesterModal').style.display = 'block';
        }

        function closeSemesterModal() {
            document.getElementById('semesterModal').style.display = 'none';
            document.getElementById('semesterForm').reset();
        }

        function openNewCohortModal() {
            // Ensure selectors are populated before showing modal
            if (semesters.length === 0) {
                showNotification('Loading semesters...', 'info');
                loadSemesters().then(() => {
                    populateSelectors();
                    document.getElementById('cohortModal').style.display = 'block';
                });
            } else {
                populateSelectors();
                document.getElementById('cohortModal').style.display = 'block';
            }
        }

        function closeCohortModal() {
            document.getElementById('cohortModal').style.display = 'none';
            const f = document.getElementById('newCohortForm');
            if (f) f.reset();
        }

        // Form handlers
        document.getElementById('semesterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('📅 Creating new semester');
            
            const formData = {
                semester_name: document.getElementById('semesterName').value,
                semester_code: document.getElementById('semesterCode').value,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/academic/semesters`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showSuccess('Semester created successfully!');
                    closeSemesterModal();
                    loadSemesters();
                    loadOverviewData();
                } else {
                    const error = await response.json();
                    showError(error.error || 'Failed to create semester');
                }
            } catch (error) {
                console.error('❌ Error creating semester:', error);
                showError('Connection error');
            }
        });

    document.getElementById('newCohortForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('👥 Creating new cohort');
            
            // Debug semester selector
            const semesterInputEl = document.getElementById('cohortSemester');
            const datalistEl = document.getElementById('semesterOptions');
            console.log('🔍 Semester input debug:', {
                exists: !!semesterInputEl,
                value: semesterInputEl?.value,
                datalistExists: !!datalistEl,
                datalistOptions: datalistEl ? Array.from(datalistEl.options).map(o => o.value) : []
            });
            
            // Handle semester input - could be existing semester name or new one
            const semesterInput = document.getElementById('cohortSemester').value;
            let semester_id = null;
            
            // Check if it matches an existing semester
            const existingSemester = semesters.find(s => s.semester_name === semesterInput);
            if (existingSemester) {
                semester_id = existingSemester.id;
            } else {
                // For new semester, we'll need to create it first or handle it on server
                // For now, let's send the semester name and let the server handle it
                semester_id = semesterInput;
            }

            const formData = {
                semester_id: semester_id,
                cohort_name: document.getElementById('cohortName').value.trim(),
                cohort_code: document.getElementById('cohortCode').value.trim(),
                instructor_name: document.getElementById('instructorName').value.trim(),
                max_students: document.getElementById('maxStudents').value
            };
            
            console.log('📝 Form data being sent:', formData);
            console.log('🧮 Data validation:', {
                semester_id: { value: formData.semester_id, type: typeof formData.semester_id, empty: !formData.semester_id },
                cohort_name: { value: formData.cohort_name, type: typeof formData.cohort_name, empty: !formData.cohort_name },
                cohort_code: { value: formData.cohort_code, type: typeof formData.cohort_code, empty: !formData.cohort_code }
            });
            
            // Validate required fields
            if (!formData.semester_id || !formData.cohort_name || !formData.cohort_code) {
                showNotification('Please fill in all required fields (Semester, Name, Code)', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/academic/cohorts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const responseData = await response.json();
                console.log('📝 Server response:', responseData);
                
                if (response.ok) {
                    showNotification('Cohort created successfully!', 'success');
                    closeCohortModal();
                    loadCohorts();
                    loadOverviewData();
                } else {
                    showNotification(responseData.error || 'Failed to create cohort', 'error');
                }
            } catch (error) {
                console.error('❌ Error creating cohort:', error);
                showNotification('Connection error', 'error');
            }
        });

        // Student Progress Loading
        async function loadStudentProgress(forceRefresh = false) {
            try {
                if(!authToken) return;
                const semesterId = document.getElementById('filterSemester').value;
                const cohortId = document.getElementById('filterCohort').value;
                
                let url = `${API_BASE}/academic/progress?`;
                if (semesterId) url += `semester_id=${semesterId}&`;
                if (cohortId) url += `cohort_id=${cohortId}&`;
                if (forceRefresh) url += `_t=${Date.now()}&`;
                
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${authToken}` }});
                if (response.ok) {
                    let progressData = await response.json();
                    progressData = await enrichProgressData(progressData);
                    displayStudentProgress(progressData);
                    hideSectionLoadingIndicator('students');
                    console.log(`✅ Student progress loaded (${forceRefresh ? 'refreshed' : 'cached'})`);
                } else if (response.status === 401 || response.status === 403) {
                    showNotification('Session invalid. Please log in again.', 'warning');
                    logout();
                }
            } catch (error) {
                console.error('❌ Error loading student progress:', error);
                hideSectionLoadingIndicator('students');
            }
        }

        // Enrich progress data with evaluation results & live session progress
        async function enrichProgressData(progressData){
            if(!Array.isArray(progressData)) return [];
            try {
                // Lazy-load evaluation cache once
                if(!evaluationCache){
                    try {
                        const evalResp = await fetch(`${API_BASE}/academic/student-evaluations`, { headers:{'Authorization':`Bearer ${authToken}`}});
                        if(evalResp.ok){
                            evaluationCache = await evalResp.json();
                        } else {
                            evaluationCache = [];
                        }
                    } catch(err){
                        console.warn('Evaluation cache load failed', err); evaluationCache=[];
                    }
                }
                const evalByStudentWeek = new Map();
                (evaluationCache||[]).forEach(ev=>{
                    if(!ev || !ev.student_name) return;
                    const key = `${ev.student_name}::${ev.week_number||ev.course_week_id||'?'}`;
                    // Prefer highest score if duplicates
                    const existing = evalByStudentWeek.get(key);
                    if(!existing || (ev.score_percentage||0) > (existing.score_percentage||0)){
                        evalByStudentWeek.set(key, ev);
                    }
                });
                // Track existing student names from base progress endpoint
                const existingNames = new Set(progressData.map(s=>s.studentName));
                // Determine live in-progress sessions
                const liveMap = new Map();
                students.forEach(val=>{
                    if(val && val.username){
                        liveMap.set(val.username, val);
                    }
                });
                // Ensure each student has week scaffolding (1-5) even if backend omitted
                const DEFAULT_WEEKS = [1,2,3,4,5];
                progressData.forEach(student=>{
                    if(!Array.isArray(student.weeks) || !student.weeks.length){
                        student.weeks = DEFAULT_WEEKS.map(n=>({ weekNumber:n, weekName:`Week ${n}`, score:null, gradeStatus:null }));
                    } else {
                        // normalize week properties to expected shape
                        student.weeks = student.weeks.map(w=>({
                            weekNumber: w.weekNumber || w.week_number || w.number || w.id || w.courseWeekId || 0,
                            weekName: w.weekName || w.week_name || `Week ${w.weekNumber || w.week_number || '?'}`,
                            score: (w.score===0?0:(w.score||w.score_percentage||w.percent||null)),
                            gradeStatus: w.gradeStatus || w.grade_status || null
                        }));
                        // Fill gaps
                        DEFAULT_WEEKS.forEach(n=>{
                            if(!student.weeks.some(w=>w.weekNumber===n)) student.weeks.push({weekNumber:n, weekName:`Week ${n}`, score:null, gradeStatus:null});
                        });
                        student.weeks.sort((a,b)=>a.weekNumber-b.weekNumber);
                    }
                    // Apply completed evaluation scores if missing
                    student.weeks.forEach(w=>{
                        if(w.score===null){
                            const ek = `${student.studentName}::${w.weekNumber}`;
                            const found = evalByStudentWeek.get(ek);
                            if(found){
                                w.score = found.score_percentage;
                                w.gradeStatus = found.grade_status || (w.score>=75? 'PASS':'FAIL');
                            }
                        }
                    });
                    // Apply live progress if still null
                    const live = liveMap.get(student.studentName);
                    if(live && live.score && typeof live.score.percent === 'number'){
                        let ln = live.courseWeekId || live.week || live.weekNumber || null;
                        if(!ln && live.scenarioTitle){
                            const m = /week\s*(\d+)/i.exec(live.scenarioTitle);
                            if(m) ln = parseInt(m[1],10);
                        }
                        const targetWeek = ln ? student.weeks.find(w=> w.weekNumber === ln) : null;
                        const wref = targetWeek || student.weeks.find(w=> !w.score) || student.weeks[0];
                        if(wref && (wref.score===null || wref.inProgress)){
                            wref.inProgress = true;
                            wref.livePercent = live.score.percent;
                        }
                    }
                });
                // Add evaluation-only students that were not in base progress API
                (evaluationCache||[]).forEach(ev=>{
                    if(!ev || !ev.student_name) return;
                    if(existingNames.has(ev.student_name)) return;
                    const wnum = ev.week_number || ev.course_week_id || 0;
                    const weeks = [1,2,3,4,5].map(n=>({
                        weekNumber:n, weekName:`Week ${n}`, score:null, gradeStatus:null
                    }));
                    const target = weeks.find(w=>w.weekNumber===wnum);
                    if(target){
                        target.score = ev.score_percentage;
                        target.gradeStatus = ev.grade_status || (target.score>=75? 'PASS':'FAIL');
                    }
                    progressData.push({
                        studentName: ev.student_name,
                        cohortName: ev.cohort_name || '—',
                        semesterName: ev.semester_name || '—',
                        weeks
                    });
                    existingNames.add(ev.student_name);
                });
            } catch(e){ console.warn('Enrichment failed', e); }
            return progressData;
        }

        function displayStudentProgress(progressData) {
            const container = document.getElementById('studentProgressContainer');
            container.innerHTML = '';
                        // Inject legend once
                        if(!document.getElementById('progressLegend')){
                                const legend = document.createElement('div');
                                legend.id='progressLegend';
                                legend.style.cssText='display:flex;flex-wrap:wrap;gap:10px;margin:0 0 15px 0;font-size:.7rem;letter-spacing:.5px;color:#475569;';
                                legend.innerHTML = `
                                    <span style="background:#dcfce7;color:#166534;padding:4px 10px;border-radius:6px;">PASS</span>
                                    <span style="background:#fee2e2;color:#dc2626;padding:4px 10px;border-radius:6px;">FAIL</span>
                                    <span style="background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:6px;">IN PROGRESS (Live)</span>
                                    <span style="background:#f1f5f9;color:#64748b;padding:4px 10px;border-radius:6px;">N/A Not Started</span>`;
                                container.parentElement?.insertBefore(legend, container);
                        }
            
            progressData.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card';
                
                const weekScores = student.weeks.map(week => {
                    let scoreClass = 'incomplete';
                                        let scoreText = 'N/A';
                    let title = `Week ${week.weekNumber}: ${week.weekName}`;
                    if (week.score !== null && typeof week.score === 'number') {
                        scoreClass = week.gradeStatus === 'PASS' ? 'pass' : 'fail';
                        scoreText = `${week.score}%`;
                        title += ` • ${week.gradeStatus}`;
                    } else if (week.inProgress) {
                        scoreClass = 'progress';
                        const lp = Math.max(0, Math.min(100, week.livePercent ?? 0));
                        scoreText = lp + '%';
                        title += ' • In Progress (live)';
                    }
                    return `<div class="week-score ${scoreClass}" title="${title}">${scoreText}</div>`;
                }).join('');
                
                card.innerHTML = `
                    <div class="student-header">
                        <div>
                            <div class="student-name">${student.studentName}</div>
                            <div class="student-cohort">${student.cohortName} • ${student.semesterName}</div>
                        </div>
                        <button class="student-delete-btn" onclick="deleteStudentProgress('${student.studentName.replace(/'/g, "\\'")}')">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                    <div class="week-grid">
                        ${weekScores}
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            if (progressData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No student progress data found.</p>';
            }
        }

        // Manual sync to refresh evaluation cache and progress view
        function forceRefreshProgress(){
            evaluationCache = null; // clear cache so next load pulls fresh
            loadStudentProgress();
        }
        window.forceRefreshProgress = forceRefreshProgress;

        async function cleanupStudent(){
            const input = document.getElementById('cleanupStudentName');
            if(!input) return;
            const name = input.value.trim();
            if(!name){ showNotification('Enter a name to remove', 'warning'); return; }
            if(!confirm(`Remove ALL evaluation/live data for "${name}"? This cannot be undone.`)) return;
            try {
                const resp = await fetch(`${API_BASE}/academic/students/${encodeURIComponent(name)}/cleanup`, { method:'DELETE', headers:{'Authorization':`Bearer ${authToken}`}});
                if(!resp.ok){ const t = await resp.text(); throw new Error(t||resp.status); }
                const data = await resp.json();
                showNotification(`Removed ${data.removedEvaluations} evaluation sessions${data.enrolled? ' (student is enrolled - only sessions cleared)': ''}.`, 'success');
                forceRefreshProgress();
                loadEvaluationResults();
            } catch(e){
                console.error('Cleanup failed', e);
                showNotification('Cleanup failed: '+ e.message, 'error');
            }
        }
        window.cleanupStudent = cleanupStudent;

        // Delete individual student progress (for the button in student cards)
        async function deleteStudentProgress(studentName) {
            if (!studentName) return;
            
            if (!confirm(`Clear ALL evaluation data for "${studentName}"?\n\nThis will remove:\n• All evaluation sessions\n• Live session data\n• Progress tracking\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/academic/students/${encodeURIComponent(studentName)}/cleanup`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Show success notification
                showNotification(
                    `✅ Cleared ${data.removedEvaluations} evaluation sessions for "${studentName}"${data.enrolled ? ' (student remains enrolled)' : ''}`, 
                    'success'
                );
                
                // Refresh the progress view
                forceRefreshProgress();
                
                // Also refresh evaluation results if visible
                if (typeof loadEvaluationResults === 'function') {
                    loadEvaluationResults();
                }
                
            } catch (error) {
                console.error('Failed to clear student progress:', error);
                showNotification(`❌ Failed to clear progress for "${studentName}": ${error.message}`, 'error');
            }
        }
        window.deleteStudentProgress = deleteStudentProgress;

        // Utility functions
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            // Create and show success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
                z-index: 2001;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function logout() {
            localStorage.removeItem('adminToken');
            authToken = null;
            currentUser = null;
            if (socket) socket.disconnect();
            dashboardWrapper.style.display = 'none';
            loginContainer.style.display = 'flex';
            updateConnectionStatus(false);
        }

        // Show loading indicator for section
        function showSectionLoadingIndicator(section) {
            const sectionElement = document.getElementById(section + 'Section');
            if (!sectionElement) return;
            
            // Section title mapping
            const titles = {
                'overview': 'overview data',
                'semesters': 'semester data',
                'cohorts': 'cohort data',
                'progress': 'student progress',
                'evaluations': 'evaluation results',
                'live': 'live activity'
            };
            
            // Remove existing loading indicator
            const existingLoader = sectionElement.querySelector('.section-loading');
            if (existingLoader) existingLoader.remove();
            
            // Add loading indicator
            const loader = document.createElement('div');
            loader.className = 'section-loading';
            loader.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255,255,255,0.9);
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 15px;
                font-weight: 600;
                color: #667eea;
            `;
            loader.innerHTML = `
                <div style="width: 20px; height: 20px; border: 2px solid #e5e7eb; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span>Refreshing ${titles[section] || 'data'}...</span>
            `;
            
            // Add spinner animation if not exists
            if (!document.querySelector('#spinner-styles')) {
                const style = document.createElement('style');
                style.id = 'spinner-styles';
                style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
                document.head.appendChild(style);
            }
            
            sectionElement.style.position = 'relative';
            sectionElement.appendChild(loader);
            
            // Auto-remove after 5 seconds as fallback
            setTimeout(() => {
                if (loader.parentNode) loader.remove();
            }, 5000);
        }

        // Hide loading indicator for section
        function hideSectionLoadingIndicator(section) {
            const sectionElement = document.getElementById(section + 'Section');
            if (!sectionElement) return;
            
            const loader = sectionElement.querySelector('.section-loading');
            if (loader) loader.remove();
        }

        // Validate cached token once on load
        async function validateAdminToken(){
            if(!authToken) return;
            try {
                const resp = await fetch(`${API_BASE}/academic/semesters`, { headers:{'Authorization':`Bearer ${authToken}`}});
                if(resp.status === 401 || resp.status === 403){
                    console.warn('Cached token invalid');
                    showNotification('Previous session expired. Please log in.', 'warning');
                    logout();
                }
            } catch(e){ console.warn('Token validation request failed', e); }
        }

        // Event listeners
        document.getElementById('logoutBtn').addEventListener('click', logout);

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // Placeholder functions for future implementation
        async function loadEvaluationResults(forceRefresh = false) {
            console.log(`📋 Loading evaluation results (${forceRefresh ? 'refreshed' : 'cached'})`);
            try {
                if(!authToken){ showNotification('Not authenticated', 'warning'); return; }
                
                const url = forceRefresh ? 
                    `${API_BASE}/academic/student-evaluations?_t=${Date.now()}` : 
                    `${API_BASE}/academic/student-evaluations`;
                
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${authToken}` }});
                if (response.status === 401 || response.status === 403) { showNotification('Session invalid. Please log in again.', 'warning'); logout(); return; }
                if (!response.ok) throw new Error('Failed to load evaluations');
                const evaluations = await response.json();
                const tbody = document.querySelector('#evaluationsTable tbody');
                
                if (evaluations.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #64748b;">No completed evaluations found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = evaluations.map(evaluation => `
                    <tr>
                        <td><strong>${evaluation.student_name}</strong></td>
                        <td><span class="badge secondary">${evaluation.week_name || 'Week N/A'}</span></td>
                        <td>${evaluation.scenario_title || 'Personal Care Evaluation'}</td>
                        <td>
                            <span class="badge ${evaluation.score_percentage >= 90 ? 'pass' : evaluation.score_percentage >= 75 ? 'warn' : 'fail'}">
                                ${evaluation.score_percentage}%
                            </span>
                        </td>
                        <td>
                            <span class="badge ${evaluation.grade_status === 'PASS' ? 'pass' : evaluation.grade_status === 'CONDITIONAL' ? 'warn' : 'fail'}">
                                ${evaluation.grade_status}
                            </span>
                        </td>
                        <td>${new Date(evaluation.completed_at).toLocaleDateString()} ${new Date(evaluation.completed_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                        <td>
                                                        <div style="display:flex; gap:6px; flex-wrap:wrap;">
                                                            <button class="btn btn-sm btn-primary" onclick="viewEvaluationDetails(${evaluation.id})" style="padding:6px 10px; font-size:.7em;">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                            <button class="btn btn-sm btn-secondary" title="Download stored report" onclick="downloadStoredReport(${evaluation.id})" style="padding:6px 10px; font-size:.7em; background:#4b5563;">
                                                                <i class="fas fa-file-alt"></i>
                                                            </button>
                                                            <button class="btn btn-sm btn-secondary" title="Export CSV (all items)" onclick="exportDetailedEvaluation(${evaluation.week_number || 1})" style="padding:6px 10px; font-size:.7em;">
                                                                <i class="fas fa-download"></i>
                                                            </button>
                                                            <button class="btn btn-sm btn-danger" title="Show failed items" onclick="toggleFailedItemsPanel(); loadFailedItems(${evaluation.id})" style="padding:6px 10px; font-size:.7em; background:#dc2626;">
                                                                <i class="fas fa-exclamation-triangle"></i>
                                                            </button>
                                                        </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading evaluations:', error);
                const tbody = document.querySelector('#evaluationsTable tbody');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #ef4444;">Failed to load evaluation results</td></tr>';
            } finally {
                hideSectionLoadingIndicator('evaluations');
                console.log('✅ Evaluation results loading complete');
            }
        }

        function loadLiveActivity(forceRefresh = false) {
            console.log(`📡 Loading live activity snapshot (${forceRefresh ? 'refreshed' : 'cached'})`);
            // No explicit REST call needed; socket will push snapshot on connect
            updateLiveActivity();
            if (forceRefresh) {
                // Force socket to re-emit snapshot for fresh data
                if (socket && socket.connected) {
                    socket.emit('requestSnapshot');
                }
                console.log('✅ Live activity refresh complete');
            }
        }

        function updateLiveActivity() {
            const container = document.getElementById('liveStudentGrid');
            if (!container) return;
            let all = Array.from(students.values());

            const hasSessionIdentifier = (student) => {
                const id = student?.sessionId ?? student?.liveSessionId ?? student?.activeSessionId;
                if (typeof id === 'number') return id > 0;
                if (typeof id === 'string') return id.trim().length > 0;
                return false;
            };

            // Apply filter to hide "No Session" entries if enabled
            if (hideNoSession) {
                all = all.filter(s => hasSessionIdentifier(s));
            }

            if (all.length === 0) {
                const message = hideNoSession ? 
                    'No students with active sessions' : 
                    'No student sessions yet';
                container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:#64748b;">${message}</div>`;
                document.getElementById('liveStudentCount').textContent = '0 Active';
                return;
            }
            // Sort: evaluating > connected > completed > disconnected, then by name
            const statusOrder = { evaluating: 0, connected: 1, completed: 2, disconnected: 3 };
            all.sort((a,b)=> (statusOrder[a.status]??9)-(statusOrder[b.status]??9) || a.username.localeCompare(b.username));

            const now = Date.now();
            let activeCount = 0;
            const cards = all.map(s => {
                const score = s.score || { passed:0, failed:0, total:0, percent:0 };
                const last = s.lastUpdate ? new Date(s.lastUpdate).getTime() : null;
                const secondsAgo = last ? Math.round((now - last)/1000) : '–';
                const statusMap = {
                    evaluating: { bg:'#fff7ed', color:'#9a3412', label:'Evaluating', glow:'rgba(234,88,12,.35)', pc:'#f97316' },
                    connected: { bg:'#eef2ff', color:'#4338ca', label:'Connected', glow:'rgba(99,102,241,.35)', pc:'#6366f1' },
                    completed: { bg:'#ecfdf5', color:'#065f46', label:'Completed', glow:'rgba(16,185,129,.35)', pc:'#10b981' },
                    disconnected: { bg:'#fef2f2', color:'#b91c1c', label:'Disconnected', glow:'rgba(239,68,68,.35)', pc:'#ef4444' },
                    'no-session': { bg:'#f8fafc', color:'#64748b', label:'Awaiting Start', glow:'rgba(100,116,139,.25)', pc:'#94a3b8' },
                    awaiting: { bg:'#e0f2fe', color:'#0c4a6e', label:'Awaiting Start', glow:'rgba(14,116,144,.25)', pc:'#38bdf8' }
                };
                
                // Get live speech data for this student
                const speechData = getStudentSpeechData(s.username);
                const speechStatus = speechData ? speechData.status : 'none';
                const fullSpeechTranscript = speechData ? (speechData.transcript || '') : '';
                const speechInterim = speechData ? (speechData.interim || '') : '';
                const hasActiveSpeech = speechStatus === 'recording';
                
                const sessionPresent = hasSessionIdentifier(s);
                let actualStatus = (s.status && statusMap[s.status]) ? s.status : 'connected';
                if (!sessionPresent && (actualStatus === 'connected' || actualStatus === 'evaluating' || actualStatus === 'no-session')) {
                    actualStatus = hasActiveSpeech ? 'connected' : 'awaiting';
                } else if (!actualStatus) {
                    actualStatus = sessionPresent ? 'connected' : 'awaiting';
                }

                const isActivelyMonitoring = actualStatus === 'connected' || actualStatus === 'evaluating';
                if (isActivelyMonitoring || actualStatus === 'awaiting') {
                    activeCount++;
                }

                const st = statusMap[actualStatus] || { bg:'#f1f5f9', color:'#475569', label:actualStatus||'Unknown', glow:'rgba(100,116,139,.25)', pc:'#64748b' };
                const statusLabel = isActivelyMonitoring
                    ? (actualStatus === 'evaluating' ? 'Evaluating' : (hasActiveSpeech ? 'Speaking' : 'Connected'))
                    : st.label;
                const statusColor = isActivelyMonitoring
                    ? (hasActiveSpeech ? '#2563eb' : '#4338ca')
                    : st.color;
                const completedCount = (score.passed || 0) + (score.failed || 0);
                const completionPct = score.total ? Math.round((completedCount/score.total)*100) : 0;
                const remainingCount = score.total ? Math.max(score.total - completedCount, 0) : null;
                
                // Get only the most recent speech content for display (last 40 words)
                const recentSpeechContent = getRecentSpeechContent(fullSpeechTranscript, 40);
                
                const scenarioBadge = s.scenarioTitle ? 
                    `<div style="position:absolute; top:10px; left:10px; background:#1e293b; color:#fff; font-size:.55rem; padding:4px 8px; border-radius:999px; letter-spacing:.5px; font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,.2);">${s.scenarioTitle}</div>` : '';
                
                // Live transcript section - enhanced continuous scrolling version
                const speechContainerId = `speech-container-${s.username.replace(/\s+/g, '-')}`;
                const liveTranscriptSection = `
                    <div class="lc-speech">
                        <div class="lc-live-speech ${hasActiveSpeech ? 'active' : ''}" style="background: ${hasActiveSpeech ? 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)' : 'linear-gradient(135deg, #f9fafb 0%, #f1f5f9 100%)'}; border: 2px solid ${hasActiveSpeech ? '#3b82f6' : '#e5e7eb'};">
                            <div class="speech-header">
                                <div style="font-size: 0.9rem; font-weight: 700; color: ${hasActiveSpeech ? '#1e40af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.5px;">
                                    ${hasActiveSpeech ? '🎤 LIVE SPEECH' : recentSpeechContent ? '💬 RECENT SPEECH' : '🎙️ SPEECH MONITOR'}
                                </div>
                                ${hasActiveSpeech ? '<div class="recording-dot active" style="width: 12px; height: 12px; animation: pulse 1.5s infinite;"></div>' : ''}
                            </div>
                            <div id="${speechContainerId}" class="speech-content streaming" 
                                 style="background: ${hasActiveSpeech ? 'rgba(255,255,255,0.8)' : 'rgba(255,255,255,0.6)'}; border: 1px solid ${hasActiveSpeech ? '#bfdbfe' : '#e5e7eb'}; 
                                        height: 120px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; position: relative;">
                                <div class="speech-stream" style="padding: 8px; line-height: 1.4; font-size: 0.85rem; color: #374151; min-height: 100%;">
                                    ${recentSpeechContent || '<em style="color: #9ca3af; font-size: 0.8rem;">Waiting for speech input...</em>'}
                                </div>
                                <div class="interim-overlay" style="position: absolute; bottom: 8px; left: 8px; right: 8px; background: rgba(59, 130, 246, 0.1); border: 1px dashed #3b82f6; border-radius: 4px; padding: 4px 8px; font-style: italic; color: #1e40af; display: ${speechInterim ? 'block' : 'none'};">
                                    🎤 ${speechInterim}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const hasDetails = typeof s.sessionId === 'number' && s.sessionId > 0;
                const detailLabel = hasDetails
                    ? 'View Details'
                    : (isActivelyMonitoring
                        ? (hasActiveSpeech ? 'Streaming' : 'Monitoring')
                        : ((actualStatus === 'awaiting' || actualStatus === 'no-session') ? 'Awaiting Start' : 'No Session'));

                return `<div class="live-card ${hasActiveSpeech ? 'speech-active' : ''}" style="--pc-color:${st.pc}; box-shadow:0 6px 18px -4px ${st.glow},0 1px 3px rgba(0,0,0,.08);">
                    ${scenarioBadge}
                    <div class="lc-progress">
                        <div class="progress-circle" style="--pct:${completionPct}; background:conic-gradient(${st.pc} ${completionPct}%, #e2e8f0 ${completionPct}%);">
                            <div class="inner">${score.percent}<span style="font-size:1rem; font-weight:600;">%</span></div>
                        </div>
                    </div>
                    <div class="lc-header">
                        <div class="lc-name">${s.username}</div>
                        <span class="lc-status" style="background:${st.bg}; color:${statusColor};">${statusLabel}</span>
                    </div>
                    <div class="lc-metrics">
                        <div class="metric-box"><div class="metric-label">COMPLETION</div><div class="metric-value" style="color:#2563eb;">${completionPct}%</div></div>
                        <div class="metric-box"><div class="metric-label">ITEMS REVIEWED</div><div class="metric-value small">${score.total ? `${completedCount}/${score.total}` : completedCount}</div></div>
                        <div class="metric-box"><div class="metric-label">REMAINING</div><div class="metric-value small">${remainingCount !== null ? remainingCount : '—'}</div></div>
                        <div class="metric-box"><div class="metric-label">LAST UPDATE</div><div class="metric-value small">${secondsAgo}s</div></div>
                    </div>
                    ${liveTranscriptSection}
                    <div class="lc-footer">
                        <button class="detail-btn" ${hasDetails ? `onclick="viewEvaluationDetails(${s.sessionId})"` : 'disabled'}>${detailLabel}</button>
                        ${actualStatus === 'no-session' || actualStatus === 'disconnected' || actualStatus === 'completed' ? 
                            `<button class="close-card-btn" onclick="closeStudentCard('${s.username}')" title="Remove this card from dashboard">
                                <i class="fas fa-times"></i>
                            </button>` : ''}
                    </div>
                </div>`;
            }).join('');
            container.innerHTML = cards;
            const countText = hideNoSession ? `${activeCount} Active (Filtered)` : `${activeCount} Active`;
            document.getElementById('liveStudentCount').textContent = countText;
                        // Aggregate unique scenario titles
                        const scenarioSet = new Set(all.filter(s=>s.scenarioTitle).map(s=>s.scenarioTitle));
                        const scenarioContainer = document.getElementById('liveScenarioTitles');
                        if (scenarioContainer) {
                            if (scenarioSet.size === 0) scenarioContainer.innerHTML = '<span style="opacity:.6;">No active scenarios</span>';
                            else scenarioContainer.innerHTML = Array.from(scenarioSet).map(t=>`<span style="background:#e2e8f0; color:#334155; padding:4px 10px; border-radius:999px;">${t}</span>`).join('');
                        }
        }

        function togglePresentationMode() {
            const root = document.body;
            const btn = document.getElementById('presentationToggle');
            const enabled = root.classList.toggle('presentation-mode');
            if (btn) btn.innerHTML = enabled ? '<i class="fas fa-compress"></i> Exit Presentation' : '<i class="fas fa-expand"></i> Presentation Mode';
            updateLiveActivity();
        }
        window.togglePresentationMode = togglePresentationMode;

        // Layout switching for live student cards
        let currentLayout = 'auto';
        
        function setCardLayout(layout) {
            currentLayout = layout;
            const container = document.getElementById('liveStudentGrid');
            if (!container) return;
            
            // Remove all layout classes
            container.className = container.className.replace(/student-grid-\w+/g, '');
            
            // Add new layout class
            container.classList.add(`student-grid-${layout}`);
            
            // Update active button
            document.querySelectorAll('.layout-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`[data-layout="${layout}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            // Save preference to localStorage
            localStorage.setItem('adminCardLayout', layout);
            
            console.log(`🎯 Live cards layout changed to: ${layout}`);
        }
        
        // Load saved layout preference on page load
        function loadSavedLayout() {
            const savedLayout = localStorage.getItem('adminCardLayout') || 'auto';
            setCardLayout(savedLayout);
        }
        
        // Initialize layout when dashboard loads
        window.setCardLayout = setCardLayout;
        window.loadSavedLayout = loadSavedLayout;

        function toggleHideNoSession() {
            hideNoSession = !hideNoSession;
            const btn = document.getElementById('hideNoSessionToggle');
            if (btn) {
                btn.classList.toggle('active', hideNoSession);
                btn.innerHTML = hideNoSession ? 
                    '<i class="fas fa-eye"></i> Show No Session' : 
                    '<i class="fas fa-eye-slash"></i> Hide No Session';
            }
            updateLiveActivity();
        }
        window.toggleHideNoSession = toggleHideNoSession;

        function closeStudentCard(studentName) {
            // Confirm before closing
            if (confirm(`Remove ${studentName}'s card from the dashboard?\n\nThis will only hide the card. The student can reconnect to create a new card.`)) {
                // Remove from students map
                students.delete(studentName);
                
                // Clear any speech data
                clearStudentSpeechData(studentName);
                
                // Clear speech stream data
                if (window.speechStreamData && window.speechStreamData.has(studentName)) {
                    window.speechStreamData.delete(studentName);
                }
                
                // Refresh the display
                updateLiveActivity();
                
                console.log(`🗑️ Manually closed card for ${studentName}`);
                showNotification(`Removed ${studentName}'s card from dashboard`, 'info');
            }
        }
        window.closeStudentCard = closeStudentCard;

        function updateOverviewStats() {
            console.log('📊 Updating overview stats');
        }

        async function viewEvaluationDetails(sessionId) {
            console.log('👁️ Viewing evaluation details for session:', sessionId);
            try {
                const response = await fetch(`${API_BASE}/evaluations/${sessionId}/details`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load evaluation details');
                
                const data = await response.json();
                
                // Create modal
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.7); z-index: 1000;
                    display: flex; align-items: center; justify-content: center;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white; border-radius: 12px; max-width: 90vw; max-height: 90vh;
                    padding: 30px; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                `;
                
                // Generate sections breakdown
                let sectionItems = '';
                for (const [sectionName, items] of Object.entries(data.items_by_section)) {
                    const passedItems = items.filter(item => item.status === 'pass').length;
                    const failedItems = items.filter(item => item.status === 'fail').length;
                    const totalItems = items.length;
                    
                    sectionItems += `
                        <div style="margin-bottom: 20px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px;">
                            <h5 style="color: #374151; margin: 0 0 10px 0; font-size: 16px;">
                                ${sectionName} 
                                <span style="font-size: 14px; color: #6b7280;">(${passedItems}/${totalItems} passed)</span>
                            </h5>
                            <div style="display: grid; gap: 8px;">
                                ${items.map(item => `
                                    <div style="display: flex; align-items: center; padding: 8px; background: ${item.status === 'pass' ? '#f0fdf4' : item.status === 'fail' ? '#fef2f2' : '#f9fafb'}; border-radius: 4px;">
                                        <span style="width: 20px; margin-right: 10px; font-weight: bold; color: ${item.status === 'pass' ? '#16a34a' : item.status === 'fail' ? '#dc2626' : '#6b7280'};">
                                            ${item.status === 'pass' ? '✓' : item.status === 'fail' ? '✗' : '○'}
                                        </span>
                                        <span style="flex: 1; font-size: 14px;">${item.description}</span>
                                        ${item.notes ? `<span style="font-size: 12px; color: #6b7280; font-style: italic;">${item.notes}</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                modalContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                        <div>
                            <h3 style="color: #1f2937; margin: 0 0 10px 0;">Evaluation Details</h3>
                            <div style="color: #6b7280; font-size: 14px;">
                                <strong>Student:</strong> ${data.session.student_name} | 
                                <strong>Score:</strong> ${data.session.score_percentage}% | 
                                <strong>Completed:</strong> ${new Date(data.session.completed_at).toLocaleString()}
                            </div>
                        </div>
                        <button onclick="this.closest('.modal-overlay').remove()" 
                                style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">×</button>
                    </div>
                    
                    <div style="background: #f8fafc; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; text-align: center;">
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: #16a34a;">${data.session.passed_items}</div>
                                <div style="font-size: 12px; color: #6b7280;">PASSED</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: #dc2626;">${data.session.failed_items}</div>
                                <div style="font-size: 12px; color: #6b7280;">FAILED</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">${data.session.total_items}</div>
                                <div style="font-size: 12px; color: #6b7280;">TOTAL</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: #7c3aed;">${data.session.score_percentage}%</div>
                                <div style="font-size: 12px; color: #6b7280;">SCORE</div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="color: #1f2937; margin-bottom: 15px;">Individual Task Results</h4>
                        ${sectionItems}
                    </div>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button onclick="exportDetailedEvaluation(${data.session.course_week_id || 1})" 
                                style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                        <button onclick="this.closest('.modal-overlay').remove()" 
                                style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            Close
                        </button>
                    </div>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                
            } catch (error) {
                console.error('Error loading evaluation details:', error);
                alert('Failed to load evaluation details. Please try again.');
            }
        }

    /* Removed duplicate toggleSemesterStatus definition that was overriding the async version above */

        async function manageCohort(id) {
            console.log('👥 Managing cohort:', id);
            try {
                // Fetch cohort details and related data
                const [cohortResponse, semestersResponse, enrollmentsResponse] = await Promise.all([
                    fetch(`${API_BASE}/academic/cohorts/${id}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch(`${API_BASE}/academic/semesters`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch(`${API_BASE}/academic/cohorts/${id}/enrollments`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);

                if (!cohortResponse.ok) throw new Error('Failed to load cohort details');
                
                const cohort = await cohortResponse.json();
                const semesters = semestersResponse.ok ? await semestersResponse.json() : [];
                const enrollments = enrollmentsResponse.ok ? await enrollmentsResponse.json() : [];

                showCohortManagementModal(cohort, semesters, enrollments);
            } catch (error) {
                console.error('Error loading cohort details:', error);
                showNotification('Failed to load cohort details', 'error');
            }
        }

        function showCohortManagementModal(cohort, semesters, enrollments) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                animation: fadeIn 0.3s ease;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 16px;
                padding: 0;
                max-width: 900px;
                width: 90%;
                max-height: 90vh;
                overflow: hidden;
                box-shadow: 0 25px 50px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
            `;

            // Add CSS animations
            if (!document.querySelector('#cohort-modal-styles')) {
                const style = document.createElement('style');
                style.id = 'cohort-modal-styles';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from { transform: translateY(-30px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    .cohort-tab {
                        padding: 12px 20px;
                        border: none;
                        background: #f8fafc;
                        color: #64748b;
                        border-radius: 0;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        border-bottom: 3px solid transparent;
                    }
                    .cohort-tab.active {
                        background: white;
                        color: #1f2937;
                        border-bottom-color: #3b82f6;
                    }
                    .cohort-tab:hover {
                        background: #f1f5f9;
                    }
                    .form-group {
                        margin-bottom: 20px;
                    }
                    .form-label {
                        display: block;
                        margin-bottom: 5px;
                        font-weight: 500;
                        color: #374151;
                    }
                    .form-input {
                        width: 100%;
                        padding: 10px 12px;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        font-size: 14px;
                        transition: border-color 0.2s ease;
                    }
                    .form-input:focus {
                        outline: none;
                        border-color: #3b82f6;
                        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                    }
                    .student-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px;
                        background: #f9fafb;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                        margin-bottom: 8px;
                    }
                    .student-item:hover {
                        background: #f3f4f6;
                    }
                `;
                document.head.appendChild(style);
            }
            
            modalContent.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="margin: 0; font-size: 24px; font-weight: 600;">Manage Cohort</h2>
                            <p style="margin: 5px 0 0 0; opacity: 0.9;">${cohort.cohort_name}</p>
                        </div>
                        <button onclick="this.closest('.modal-overlay').remove()" 
                                style="background: rgba(255,255,255,0.2); border: none; color: white; 
                                       width: 40px; height: 40px; border-radius: 50%; cursor: pointer; 
                                       font-size: 20px; display: flex; align-items: center; justify-content: center;">
                            ×
                        </button>
                    </div>
                </div>

                <div style="background: #f8fafc; padding: 0; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex;">
                        <button class="cohort-tab active" onclick="switchCohortTab(this, 'details')">
                            📋 Details
                        </button>
                        <button class="cohort-tab" onclick="switchCohortTab(this, 'students')">
                            👥 Students (${enrollments.length})
                        </button>
                        <button class="cohort-tab" onclick="switchCohortTab(this, 'settings')">
                            ⚙️ Settings
                        </button>
                    </div>
                </div>

                <div style="padding: 25px; max-height: 500px; overflow-y: auto;">
                    <!-- Details Tab -->
                    <div id="cohort-details-tab" class="cohort-tab-content">
                        <form id="cohortForm" onsubmit="updateCohort(event, ${cohort.id})">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label class="form-label">Cohort Name</label>
                                    <input type="text" class="form-input" name="cohort_name" 
                                           value="${cohort.cohort_name}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Cohort Code</label>
                                    <input type="text" class="form-input" name="cohort_code" 
                                           value="${cohort.cohort_code}" required>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label class="form-label">Semester</label>
                                    <input type="text" class="form-input" name="semester_id" list="cohort-semester-options" 
                                           value="${cohort.semester_name}" placeholder="Type or select semester (e.g., Fall 2030)" required>
                                    <datalist id="cohort-semester-options">
                                        ${semesters.map(sem => `<option value="${sem.semester_name}"></option>`).join('')}
                                    </datalist>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Max Students</label>
                                    <input type="number" class="form-input" name="max_students" 
                                           value="${cohort.max_students}" min="1" max="100">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Instructor Name</label>
                                <input type="text" class="form-input" name="instructor_name" 
                                       value="${cohort.instructor_name || ''}" placeholder="Enter instructor name">
                            </div>
                            
                            <div class="form-group">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" name="is_active" ${cohort.is_active ? 'checked' : ''} 
                                           style="margin-right: 8px; transform: scale(1.2);">
                                    <span class="form-label" style="margin: 0;">Active Cohort</span>
                                </label>
                            </div>
                            <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:10px;">
                                <button type="submit" form="cohortForm" style="background:#2563eb; color:#fff; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; font-weight:500;">Update Cohort</button>
                            </div>
                        </form>
                    </div>

                    <!-- Students Tab -->
                    <div id="cohort-students-tab" class="cohort-tab-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #1f2937;">Enrolled Students</h3>
                            <button onclick="addStudentToCohort(${cohort.id})" 
                                    style="background: #10b981; color: white; border: none; padding: 8px 16px; 
                                           border-radius: 6px; cursor: pointer; font-size: 14px;">
                                + Add Student
                            </button>
                        </div>
                        
                        <div id="studentsList">
                            ${enrollments.length === 0 ? 
                                '<p style="text-align: center; color: #6b7280; padding: 40px;">No students enrolled yet</p>' :
                                enrollments.map(student => `
                                    <div class="student-item">
                                        <div>
                                            <strong>${student.student_name}</strong>
                                            <div style="font-size: 12px; color: #6b7280;">
                                                Enrolled: ${new Date(student.enrollment_date).toLocaleDateString()}
                                            </div>
                                        </div>
                                        <div>
                                            <button onclick="removeStudentFromCohort(${cohort.id}, '${student.student_name}')"
                                                    style="background: #ef4444; color: white; border: none; 
                                                           padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                                Remove
                                            </button>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div id="cohort-settings-tab" class="cohort-tab-content" style="display: none;">
                        <h3 style="margin: 0 0 20px 0; color: #1f2937;">Cohort Actions</h3>
                        
                        <div style="display: grid; gap: 15px;">
                            <div style="padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px;">
                                <h4 style="margin: 0 0 10px 0; color: #374151;">Export Data</h4>
                                <p style="font-size: 14px; color: #6b7280; margin: 0 0 10px 0;">
                                    Export cohort enrollment and evaluation data
                                </p>
                                <button onclick="exportCohortData(${cohort.id})"
                                        style="background: #3b82f6; color: white; border: none; 
                                               padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                    📊 Export CSV
                                </button>
                            </div>
                            
                            <div style="padding: 15px; border: 1px solid #fecaca; border-radius: 8px; background: #fef2f2;">
                                <h4 style="margin: 0 0 10px 0; color: #dc2626;">Danger Zone</h4>
                                <p style="font-size: 14px; color: #991b1b; margin: 0 0 10px 0;">
                                    Permanently delete this cohort and all associated data
                                </p>
                                <button onclick="deleteCohort(${cohort.id})"
                                        style="background: #dc2626; color: white; border: none; 
                                               padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                    🗑️ Delete Cohort
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="padding: 20px 25px; background: #f9fafb; border-top: 1px solid #e5e7eb; 
                            display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 12px; color: #6b7280;">
                        Created: ${new Date(cohort.created_at).toLocaleString()}
                    </div>
                    <div>
                        <button onclick="this.closest('.modal-overlay').remove()" 
                                style="background: #6b7280; color: white; border: none; 
                                       padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                            Cancel
                        </button>
                        <button onclick="document.getElementById('cohortForm').dispatchEvent(new Event('submit'))"
                                style="background: #10b981; color: white; border: none; 
                                       padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            💾 Save Changes
                        </button>
                    </div>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });

            // Make functions available globally for the modal
            window.switchCohortTab = switchCohortTab;
            window.updateCohort = updateCohort;
            window.addStudentToCohort = addStudentToCohort;
            window.removeStudentFromCohort = removeStudentFromCohort;
            window.exportCohortData = exportCohortData;
            window.deleteCohort = deleteCohort;
        }

        function switchCohortTab(button, tabName) {
            // Update tab buttons
            document.querySelectorAll('.cohort-tab').forEach(tab => tab.classList.remove('active'));
            button.classList.add('active');
            
            // Show/hide tab content
            document.querySelectorAll('.cohort-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`cohort-${tabName}-tab`).style.display = 'block';
        }

        async function updateCohort(event, cohortId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const raw = Object.fromEntries(formData.entries());
            const isActive = formData.has('is_active');

            // Semester may be a name; map to ID or create new semester via helper endpoint (if implemented) or inline logic
            const semesterName = raw.semester_id.trim();
            let semesterId = null;
            const existing = semesters.find(s => s.semester_name.toLowerCase() === semesterName.toLowerCase());
            if (existing) {
                semesterId = existing.id;
            } else {
                // Create semester optimistically (fallback dates)
                try {
                    const yearMatch = semesterName.match(/(20\d{2})/);
                    const year = yearMatch ? parseInt(yearMatch[1], 10) : (new Date().getFullYear());
                    const nextYear = year + 1;
                    const semesterCode = semesterName.replace(/\s+/g,'').toUpperCase();
                    const createResp = await fetch(`${API_BASE}/academic/semesters`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type':'application/json' },
                        body: JSON.stringify({
                            semester_name: semesterName,
                            semester_code: semesterCode.slice(0,12),
                            start_date: `${year}-08-15`,
                            end_date: `${nextYear}-05-15`
                        })
                    });
                    if (createResp.ok) {
                        const created = await createResp.json();
                        semesterId = created.id;
                        // refresh semesters cache
                        await loadSemesters();
                    } else {
                        console.warn('Semester create failed, attempting fallback fetch');
                        semesterId = existing ? existing.id : null;
                    }
                } catch (e) {
                    console.error('Semester creation error:', e);
                }
            }

            if (!semesterId) {
                showNotification('Unable to resolve semester. Please choose or type a valid semester.', 'error');
                return;
            }

            const data = {
                cohort_name: raw.cohort_name.trim(),
                cohort_code: raw.cohort_code.trim(),
                semester_id: semesterId,
                instructor_name: (raw.instructor_name || '').trim(),
                max_students: parseInt(raw.max_students || '30', 10),
                is_active: isActive
            };

            console.log('🔧 Updating cohort:', cohortId, data);

            try {
                const response = await fetch(`${API_BASE}/academic/cohorts/${cohortId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
                showNotification('Cohort updated successfully!', 'success');
                document.querySelector('.modal-overlay')?.remove();
                loadCohorts();
            } catch (err) {
                console.error('Update error:', err);
                showNotification('Failed to update cohort: ' + err.message, 'error');
            }
        }

        async function addStudentToCohort(cohortId) {
            const studentName = prompt('Enter student name:');
            if (!studentName) return;

            try {
                const response = await fetch(`${API_BASE}/academic/cohorts/${cohortId}/enroll`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ student_name: studentName })
                });

                if (!response.ok) throw new Error('Failed to add student');

                showNotification('Student added successfully!', 'success');
                // Refresh the modal
                document.querySelector('.modal-overlay').remove();
                manageCohort(cohortId);
            } catch (error) {
                console.error('Error adding student:', error);
                showNotification('Failed to add student', 'error');
            }
        }

        async function removeStudentFromCohort(cohortId, studentName) {
            if (!confirm(`Are you sure you want to remove ${studentName} from this cohort?`)) return;

            try {
                const response = await fetch(`${API_BASE}/academic/cohorts/${cohortId}/unenroll`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ student_name: studentName })
                });

                if (!response.ok) throw new Error('Failed to remove student');

                showNotification('Student removed successfully!', 'success');
                // Refresh the modal
                document.querySelector('.modal-overlay').remove();
                manageCohort(cohortId);
            } catch (error) {
                console.error('Error removing student:', error);
                showNotification('Failed to remove student', 'error');
            }
        }

        async function exportCohortData(cohortId) {
            try {
                const response = await fetch(`${API_BASE}/academic/cohorts/${cohortId}/export`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to export cohort data');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `cohort_${cohortId}_data.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showNotification('Cohort data exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting cohort data:', error);
                showNotification('Failed to export cohort data', 'error');
            }
        }

        async function deleteCohort(cohortId) {
            const warning = 'Deleting this cohort will permanently remove:\n\n' +
                '• Student enrollments\n• Evaluation sessions & items\n\nThis cannot be undone.';
            alert(warning);
            const phrase = 'delete cohort';
            const typed = prompt(`Type "${phrase}" to confirm deletion:`);
            if (!typed || typed.toLowerCase().trim() !== phrase) {
                showNotification('Deletion cancelled', 'warning');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/academic/cohorts/${cohortId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error(await response.text());
                showNotification('Cohort deleted', 'success');
                document.querySelector('.modal-overlay')?.remove();
                loadCohorts();
            } catch (err) {
                console.error('Delete cohort error:', err);
                showNotification('Failed to delete cohort', 'error');
            }
        }

        function generateReport(type) {
            console.log('📋 Generating report:', type);
        }

        async function viewEvaluationDetails(sessionId) {
            console.log('👁️ Viewing evaluation details:', sessionId);
            try {
                const response = await fetch(`${API_BASE}/evaluations/${sessionId}/details`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load evaluation details');
                
                const data = await response.json();
                showEvaluationDetailsModal(data);
            } catch (error) {
                console.error('Error loading evaluation details:', error);
                showNotification('Failed to load evaluation details', 'error');
            }
        }

        function showEvaluationDetailsModal(data) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 25px;
                max-width: 800px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            `;
            
            const sectionItems = Object.entries(data.items_by_section)
                .map(([section, items]) => `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #1f2937; margin-bottom: 10px; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">
                            ${section}
                        </h4>
                        ${items.map(item => `
                            <div style="display: flex; align-items: center; padding: 8px; margin-bottom: 5px; background: ${item.status === 'pass' ? '#f0fdf4' : '#fef2f2'}; border-radius: 6px;">
                                <span style="color: ${item.status === 'pass' ? '#16a34a' : '#dc2626'}; margin-right: 10px; font-size: 16px;">
                                    ${item.status === 'pass' ? '✅' : '⭕'}
                                </span>
                                <span style="flex: 1;">${item.description}</span>
                                ${item.notes ? `<span style="font-size: 12px; color: #6b7280; margin-left: 10px;">${item.notes}</span>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `).join('');
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #1f2937; margin: 0;">Evaluation Details</h3>
                    <button onclick="this.closest('.modal-overlay').remove()" 
                            style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">×</button>
                </div>
                
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div><strong>Student:</strong> ${data.session.student_name}</div>
                        <div><strong>Evaluator:</strong> ${data.session.evaluator_name || 'N/A'}</div>
                        <div><strong>Week:</strong> ${data.session.week_name}</div>
                        <div><strong>Scenario:</strong> ${data.session.scenario_title}</div>
                        <div><strong>Score:</strong> 
                            <span style="color: ${data.session.score_percentage >= 90 ? '#16a34a' : data.session.score_percentage >= 75 ? '#d97706' : '#dc2626'};">
                                ${data.session.score_percentage}%
                            </span>
                        </div>
                        <div><strong>Completed:</strong> ${new Date(data.session.completed_at).toLocaleString()}</div>
                    </div>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    <h4 style="color: #1f2937; margin-bottom: 15px;">Individual Task Results</h4>
                    ${sectionItems}
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button onclick="exportDetailedEvaluation(${data.session.course_week_id})" 
                            style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                    <button onclick="this.closest('.modal-overlay').remove()" 
                            style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                        Close
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        async function exportDetailedEvaluation(courseId) {
            console.log('📄 Exporting detailed evaluation for course:', courseId);
            try {
                const response = await fetch(`${API_BASE}/evaluations/export-detailed/${courseId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to export evaluation');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `week_${courseId}_detailed_evaluations.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showNotification('Detailed evaluation data exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting evaluation:', error);
                showNotification('Failed to export evaluation data', 'error');
            }
        }

        function exportEvaluations() {
            console.log('📄 Exporting evaluations');
            exportDetailedEvaluation(1); // Default to course 1, could be made dynamic
        }

        function exportReportPDF() {
            console.log('📄 Exporting report as PDF');
        }

        // Notification system
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideInRight 0.3s ease;
                cursor: pointer;
            `;

            // Set colors based on type
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            notification.style.background = colors[type] || colors.info;

            // Add icon based on type
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };

            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 16px;">${icons[type] || icons.info}</span>
                    <span>${message}</span>
                </div>
            `;

            // Add CSS animation if not exists
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes slideOutRight {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) notification.remove();
                    }, 300);
                }
            }, 5000);

            // Click to dismiss
            notification.addEventListener('click', () => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) notification.remove();
                }, 300);
            });
        }

        // ================== Speech Transcriptions Functions ==================
        let speechTranscriptions = [];
        let filteredSpeechTranscriptions = [];

        async function loadSpeechTranscriptions(forceRefresh = false) {
            if (!authToken) return;

            if (!forceRefresh && speechTranscriptions.length > 0) {
                renderSpeechTable();
                return;
            }

            try {
                const queryParams = new URLSearchParams({
                    limit: 100,
                    offset: 0
                });

                const response = await fetch(`${API_BASE}/admin/speech/all?${queryParams}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                speechTranscriptions = data.transcriptions || [];
                filteredSpeechTranscriptions = [...speechTranscriptions];
                
                renderSpeechTable();
                updateSpeechCount();

            } catch (error) {
                console.error('Failed to load speech transcriptions:', error);
                showNotification('Failed to load speech transcriptions', 'error');
                document.getElementById('speechTableBody').innerHTML = 
                    '<tr><td colspan="7" style="text-align:center; color:#ef4444;">Failed to load speech transcriptions</td></tr>';
            }
        }

        function renderSpeechTable() {
            const tbody = document.getElementById('speechTableBody');
            if (!tbody) return;

            if (filteredSpeechTranscriptions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#6b7280;">No speech transcriptions found</td></tr>';
                return;
            }

            tbody.innerHTML = filteredSpeechTranscriptions.map(transcript => {
                const createdDate = new Date(transcript.created_at).toLocaleString();
                const duration = transcript.duration_seconds ? `${transcript.duration_seconds}s` : '-';
                const typeLabel = transcript.is_final ? 'Final' : 'Interim';
                const typeClass = transcript.is_final ? 'success' : 'warning';
                
                return `
                    <tr>
                        <td><strong>${escapeHtml(transcript.student_name)}</strong></td>
                        <td>${transcript.week_name || `Course ${transcript.course_id}`}</td>
                        <td><code style="font-size:0.8em;">${transcript.session_id || '-'}</code></td>
                        <td><span class="badge ${typeClass}">${typeLabel}</span></td>
                        <td>${duration}</td>
                        <td>${createdDate}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary" onclick="viewSpeechTranscript(${transcript.id})" title="View Transcript">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="deleteSpeechTranscript(${transcript.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateSpeechCount() {
            const countElement = document.getElementById('speechCount');
            if (countElement) {
                const count = filteredSpeechTranscriptions.length;
                countElement.textContent = `${count} transcription${count !== 1 ? 's' : ''}`;
            }
        }

        function filterSpeechTranscriptions() {
            const studentFilter = document.getElementById('speechStudentFilter')?.value.toLowerCase() || '';
            const courseFilter = document.getElementById('speechCourseFilter')?.value || '';
            const typeFilter = document.getElementById('speechTypeFilter')?.value || '';

            filteredSpeechTranscriptions = speechTranscriptions.filter(transcript => {
                const studentMatch = !studentFilter || transcript.student_name.toLowerCase().includes(studentFilter);
                const courseMatch = !courseFilter || transcript.course_id?.toString() === courseFilter;
                const typeMatch = !typeFilter || transcript.is_final.toString() === typeFilter;
                
                return studentMatch && courseMatch && typeMatch;
            });

            renderSpeechTable();
            updateSpeechCount();
        }

        function refreshSpeechTranscriptions() {
            loadSpeechTranscriptions(true);
        }

        async function viewSpeechTranscript(transcriptId) {
            const transcript = speechTranscriptions.find(t => t.id === transcriptId);
            if (!transcript) return;

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                background: rgba(0,0,0,0.5); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 800px; width: 100%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: between; align-items: center;">
                        <div>
                            <h3 style="margin: 0; color: #1f2937;">Speech Transcript</h3>
                            <p style="margin: 5px 0 0; color: #6b7280; font-size: 0.9em;">
                                ${escapeHtml(transcript.student_name)} • ${transcript.week_name || `Course ${transcript.course_id}`} • 
                                ${transcript.is_final ? 'Final' : 'Interim'} • ${new Date(transcript.created_at).toLocaleString()}
                            </p>
                        </div>
                        <button onclick="this.closest('.modal').remove()" style="background: #f3f4f6; border: none; border-radius: 6px; padding: 8px; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="padding: 20px; overflow-y: auto; flex: 1;">
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; font-family: monospace; white-space: pre-wrap; line-height: 1.6;">
${escapeHtml(transcript.transcript)}
                        </div>
                        ${transcript.interim_transcript ? `
                            <div style="margin-top: 16px;">
                                <h4 style="margin: 0 0 8px; color: #6b7280; font-size: 0.9em;">Interim Text:</h4>
                                <div style="background: #fef3c7; padding: 12px; border-radius: 6px; font-family: monospace; font-style: italic; color: #92400e;">
                                    ${escapeHtml(transcript.interim_transcript)}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        async function deleteSpeechTranscript(transcriptId) {
            if (!confirm('Are you sure you want to delete this speech transcript?')) return;
            
            if (!authToken) return;

            try {
                const response = await fetch(`${API_BASE}/admin/speech/${transcriptId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                showNotification('Speech transcript deleted successfully', 'success');
                loadSpeechTranscriptions(true);

            } catch (error) {
                console.error('Failed to delete speech transcript:', error);
                showNotification('Failed to delete speech transcript', 'error');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        console.log('🎓 Comprehensive Admin Dashboard ready');

        // ================== New Enhancements ==================
        async function downloadStoredReport(sessionId) {
            if (!authToken) return;
            try {
                const resp = await fetch(`${API_BASE}/evaluations/${sessionId}/report.txt`, { headers: { 'Authorization': `Bearer ${authToken}` }});
                if (!resp.ok) {
                    showNotification('Report not available', 'warning');
                    return;
                }
                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `evaluation_${sessionId}_report.txt`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('Report downloaded', 'success');
            } catch (e) {
                console.error(e);
                showNotification('Failed to download report', 'error');
            }
        }
        window.downloadStoredReport = downloadStoredReport;

        function toggleFailedItemsPanel() {
            const panel = document.getElementById('failedItemsPanel');
            if (panel.style.display === 'none') panel.style.display = 'block'; else panel.style.display = 'none';
        }
        window.toggleFailedItemsPanel = toggleFailedItemsPanel;

        async function loadFailedItems(sessionIdForFocus = null) {
            if (!authToken) return;
            const filterStudent = document.getElementById('failedFilterStudent').value.trim();
            let url = `${API_BASE}/evaluations/failed-items`;
            const params = [];
            if (filterStudent) params.push(`student=${encodeURIComponent(filterStudent)}`);
            if (sessionIdForFocus) params.push(`sessionId=${sessionIdForFocus}`);
            if (params.length) url += `?${params.join('&')}`;
            try {
                const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${authToken}` }});
                if (!resp.ok) {
                    showNotification('Failed to load failed items', 'error');
                    return;
                }
                const data = await resp.json();
                const tbody = document.querySelector('#failedItemsTable tbody');
                if (!data.length) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:25px; color:#64748b;">No failed items found</td></tr>';
                    return;
                }
                tbody.innerHTML = data.map(row => `
                    <tr>
                        <td>${row.student_name}</td>
                        <td>${row.week_name || 'Week'}</td>
                        <td>${row.section_name}</td>
                        <td>${row.item_description}</td>
                        <td>${new Date(row.completed_at).toLocaleDateString()}</td>
                        <td>${row.score_percentage}%</td>
                        <td><button class="btn btn-secondary" style="padding:4px 8px; font-size:.65em;" onclick="viewEvaluationDetails(${row.session_id})">View</button></td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }
        window.loadFailedItems = loadFailedItems;

        // Live Speech Monitoring Functions
        const liveSpeechSessions = new Map();

        function updateLiveSpeechSession(sessionId, data) {
            liveSpeechSessions.set(sessionId, data);
            renderLiveSpeechSessions();
        }

        function removeLiveSpeechSession(sessionId) {
            liveSpeechSessions.delete(sessionId);
            renderLiveSpeechSessions();
        }

        function renderLiveSpeechSessions() {
            const container = document.getElementById('liveSpeechContainer');
            const indicator = document.getElementById('liveSpeechIndicator');
            const countBadge = document.getElementById('liveSpeechCount');
            
            if (!container || !indicator || !countBadge) return;

            const activeSessions = Array.from(liveSpeechSessions.values());
            countBadge.textContent = `${activeSessions.length} active session${activeSessions.length !== 1 ? 's' : ''}`;
            
            // Update indicator
            const hasActiveRecording = activeSessions.some(s => s.status === 'recording');
            if (hasActiveRecording) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }

            if (activeSessions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 40px;">
                        No active speech sessions
                    </div>`;
                return;
            }

            container.innerHTML = activeSessions.map(session => {
                const finalText = session.finalTranscript || '';
                const interimText = session.interimTranscript || '';
                const isRecording = session.status === 'recording';
                
                return `
                    <div class="live-speech-session ${isRecording ? 'active' : ''}">
                        <div class="live-speech-header">
                            <div class="live-speech-student">
                                👤 ${session.studentName || 'Unknown Student'}
                                <span style="font-size: 0.85rem; color: #6b7280; font-weight: normal;">
                                    Course ${session.courseId || 'N/A'}
                                </span>
                            </div>
                            <div class="live-speech-status ${isRecording ? 'recording' : 'stopped'}">
                                ${isRecording ? '🔴 Recording' : '⏹️ Stopped'}
                            </div>
                        </div>
                        <div class="live-speech-transcript">
                            <div class="live-speech-final" style="max-height: 200px; overflow-y: auto; white-space: pre-wrap; line-height: 1.5;">
                                ${finalText || '<em style="color: #9ca3af;">No transcript yet...</em>'}
                            </div>
                            ${interimText ? `
                                <div class="live-speech-interim" style="font-style: italic; color: #6366f1; margin-top: 8px; padding: 8px; background: #f0f9ff; border-radius: 4px; border-left: 3px solid #6366f1;">
                                    🎤 ${interimText}
                                </div>
                            ` : ''}
                            ${isRecording && !interimText ? '<div style="color: #059669; font-style: italic;">🎤 Listening for speech...</div>' : ''}
                        </div>
                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <span>Session: ${session.sessionId?.substring(0, 12) || 'N/A'}...</span>
                            <span>Started: ${session.startTime ? new Date(session.startTime).toLocaleTimeString() : 'N/A'}</span>
                            <span>Words: ${finalText ? finalText.split(' ').length : 0}</span>
                        </div>
                    </div>`;
            }).join('');
        }

        // Live Transcript Viewer Functions
        function updateLiveTranscriptViewer(data) {
            const statusEl = document.getElementById('liveTranscriptStatus');
            const textEl = document.getElementById('liveTranscriptText');
            const interimEl = document.getElementById('liveInterimText');
            const timeEl = document.getElementById('liveTranscriptTime');
            const studentEl = document.getElementById('liveTranscriptStudent');
            const sessionEl = document.getElementById('liveTranscriptSession');
            
            if (!statusEl || !textEl || !interimEl || !timeEl || !studentEl || !sessionEl) return;
            
            const now = new Date();
            timeEl.textContent = now.toLocaleTimeString();
            studentEl.textContent = data.studentName || 'Unknown';
            sessionEl.textContent = data.sessionId ? data.sessionId.substring(0, 12) + '...' : 'None';
            
            switch (data.type) {
                case 'start':
                    statusEl.textContent = '🔴 Recording started';
                    statusEl.className = 'badge recording';
                    textEl.innerHTML = '<div style="color: #059669; font-style: italic;">🎤 Student started speaking...</div>';
                    interimEl.style.display = 'none';
                    break;
                    
                case 'update':
                    statusEl.textContent = '🎤 Live recording';
                    statusEl.className = 'badge active';
                    
                    // Update final transcript
                    if (data.transcript && data.transcript.trim()) {
                        textEl.innerHTML = data.transcript.replace(/\n/g, '<br>');
                        textEl.style.color = '#374151';
                        textEl.style.fontStyle = 'normal';
                    } else {
                        textEl.innerHTML = '<div style="color: #6b7280; font-style: italic;">🎤 Listening...</div>';
                    }
                    
                    // Update interim transcript
                    if (data.interim && data.interim.trim()) {
                        interimEl.innerHTML = `🎤 ${data.interim}`;
                        interimEl.style.display = 'block';
                    } else {
                        interimEl.style.display = 'none';
                    }
                    break;
                    
                case 'stop':
                    statusEl.textContent = '⏹️ Recording stopped';
                    statusEl.className = 'badge';
                    
                    if (data.transcript && data.transcript.trim()) {
                        textEl.innerHTML = data.transcript.replace(/\n/g, '<br>');
                        textEl.style.color = '#374151';
                        textEl.style.fontStyle = 'normal';
                    }
                    interimEl.style.display = 'none';
                    break;
            }
            
            // Auto-scroll to bottom if needed
            const container = document.getElementById('liveTranscriptContainer');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        function clearLiveTranscript() {
            const textEl = document.getElementById('liveTranscriptText');
            const interimEl = document.getElementById('liveInterimText');
            const statusEl = document.getElementById('liveTranscriptStatus');
            const timeEl = document.getElementById('liveTranscriptTime');
            const studentEl = document.getElementById('liveTranscriptStudent');
            const sessionEl = document.getElementById('liveTranscriptSession');
            
            if (textEl) {
                textEl.innerHTML = '<div style="color: #6b7280; font-style: italic;">🎤 Live speech will appear here in real-time as students speak...</div>';
            }
            if (interimEl) {
                interimEl.style.display = 'none';
            }
            if (statusEl) {
                statusEl.textContent = 'Waiting for speech...';
                statusEl.className = 'badge';
            }
            if (timeEl) {
                timeEl.textContent = 'Never';
            }
            if (studentEl) {
                studentEl.textContent = 'None';
            }
            if (sessionEl) {
                sessionEl.textContent = 'None';
            }
        }

        // Demo function to simulate live speech feature
        function simulateLiveSpeech() {
            console.log('🎤 Simulating live speech for demo...');
            
            // Create demo students with speech data
            const demoStudents = [
                {
                    username: 'Alice Johnson',
                    status: 'evaluating',
                    score: { passed: 12, failed: 2, total: 20, percent: 85 },
                    sessionId: 1001,
                    lastUpdate: new Date(),
                    scenarioTitle: 'Personal Care Assessment'
                },
                {
                    username: 'Bob Smith', 
                    status: 'evaluating',
                    score: { passed: 8, failed: 1, total: 15, percent: 78 },
                    sessionId: 1002,
                    lastUpdate: new Date(),
                    scenarioTitle: 'Vital Signs Check'
                },
                {
                    username: 'Carol Davis',
                    status: 'connected',
                    score: { passed: 15, failed: 0, total: 18, percent: 92 },
                    sessionId: 1003,
                    lastUpdate: new Date(),
                    scenarioTitle: 'Physical Examination'
                }
            ];
            
            // Add demo students to the students map
            demoStudents.forEach(student => {
                students.set(student.username, student);
            });
            
            // Add live speech data for each student
            updateStudentSpeechData('Alice Johnson', {
                type: 'update',
                sessionId: 'alice-session-001',
                status: 'recording',
                transcript: 'Patient appears alert and oriented. Beginning comprehensive assessment of cardiovascular system.',
                interim: 'Heart rate is regular...',
                lastUpdate: new Date()
            });
            
            updateStudentSpeechData('Bob Smith', {
                type: 'update', 
                sessionId: 'bob-session-002',
                status: 'recording',
                transcript: 'Vital signs obtained: BP 120/80, HR 72, RR 16, Temp 98.6°F. All within normal limits.',
                interim: 'Now checking oxygen saturation...',
                lastUpdate: new Date()
            });
            
            updateStudentSpeechData('Carol Davis', {
                type: 'stop',
                sessionId: 'carol-session-003', 
                status: 'stopped',
                transcript: 'Physical examination complete. Patient demonstrates good mobility and range of motion in all extremities.',
                interim: '',
                lastUpdate: new Date()
            });
            
            // Update the live activity display
            updateLiveActivity();
            
            showNotification('Demo: Live speech simulation activated! Check the student cards for live transcripts.', 'success');
            
            // Auto-update Alice's speech every 3 seconds to show live updates
            let updateCount = 0;
            const liveUpdates = [
                'Respiratory rate is 16 breaths per minute, regular and unlabored.',
                'Skin is warm, dry, and pink. No signs of distress observed.',
                'Patient is cooperative and responding appropriately to questions.',
                'Blood pressure reading shows 118/78 mmHg, within normal range.',
                'Assessment findings are consistent with stable patient condition.'
            ];
            
            const updateInterval = setInterval(() => {
                if (updateCount < liveUpdates.length) {
                    const currentTranscript = `Patient appears alert and oriented. Beginning comprehensive assessment of cardiovascular system. ${liveUpdates.slice(0, updateCount + 1).join(' ')}`;
                    
                    updateStudentSpeechData('Alice Johnson', {
                        type: 'update',
                        sessionId: 'alice-session-001',
                        status: 'recording',
                        transcript: currentTranscript,
                        interim: updateCount < liveUpdates.length - 1 ? 'Continuing assessment...' : '',
                        lastUpdate: new Date()
                    });
                    
                    updateLiveActivity();
                    updateCount++;
                } else {
                    clearInterval(updateInterval);
                    // Mark Alice as stopped
                    updateStudentSpeechData('Alice Johnson', {
                        type: 'stop',
                        sessionId: 'alice-session-001',
                        status: 'stopped',
                        transcript: `Patient appears alert and oriented. Beginning comprehensive assessment of cardiovascular system. ${liveUpdates.join(' ')}`,
                        interim: '',
                        lastUpdate: new Date()
                    });
                    updateLiveActivity();
                }
            }, 3000);
        }

        // Helper function to get recent speech content for display
        function getRecentSpeechContent(fullTranscript, maxWords = 40) {
            if (!fullTranscript || fullTranscript.length === 0) {
                return '';
            }
            
            // Split by time markers first to get the most recent segment
            const timeSegments = fullTranscript.split(/\n\[\d+:\d+\]\s*/);
            const mostRecentSegment = timeSegments[timeSegments.length - 1];
            
            // If the most recent segment is still too long, truncate by words
            const words = mostRecentSegment.trim().split(/\s+/);
            if (words.length <= maxWords) {
                return mostRecentSegment.trim();
            }
            
            // Take the last N words and add ellipsis
            const recentWords = words.slice(-maxWords);
            return '...' + recentWords.join(' ');
        }

        // Student Speech Data Management Functions
        function updateStudentSpeechData(studentName, speechData) {
            if (!studentName || !speechData) {
                console.warn('Invalid student speech data:', studentName, speechData);
                return;
            }
            
            try {
                const existing = studentSpeechData.get(studentName) || {};
                const updated = {
                    ...existing,
                    ...speechData,
                    studentName: studentName
                };
                
                studentSpeechData.set(studentName, updated);
                console.log(`Updated speech data for ${studentName}:`, updated);
            } catch (error) {
                console.error('Error updating student speech data:', error);
            }
        }
        
        function getStudentSpeechData(studentName) {
            return studentSpeechData.get(studentName) || null;
        }
        
        function clearStudentSpeechData(studentName) {
            if (studentName) {
                studentSpeechData.delete(studentName);
                console.log(`Cleared speech data for ${studentName}`);
            }
        }
        
        function clearAllStudentSpeechData() {
            studentSpeechData.clear();
            console.log('Cleared all student speech data');
        }

        // Live Speech Streaming Functions - Enhanced Continuous Scrolling
        let speechStreamData = new Map(); // Track streaming state per student

        function initializeLiveSpeechStream(studentName) {
            const containerId = `speech-container-${studentName.replace(/\s+/g, '-')}`;
            const container = document.getElementById(containerId);
            
            if (!container) return;

            // Initialize streaming state for this student
            speechStreamData.set(studentName, {
                lastTranscriptLength: 0,
                lastInterim: '',
                streamingActive: false,
                wordBuffer: [],
                lastUpdateTime: Date.now()
            });

            console.log(`🎬 Initialized live speech stream for ${studentName}`);
        }

        function updateLiveSpeechStream(studentName, speechData) {
            const containerId = `speech-container-${studentName.replace(/\s+/g, '-')}`;
            const container = document.getElementById(containerId);
            const streamData = speechStreamData.get(studentName);
            
            if (!container || !streamData) return;

            const speechStreamDiv = container.querySelector('.speech-stream');
            const interimOverlay = container.querySelector('.interim-overlay');
            
            if (!speechStreamDiv || !interimOverlay) return;

            const finalTranscript = speechData.transcript || '';
            const interimTranscript = speechData.interim || '';
            const currentTime = Date.now();

            // Handle final transcript updates (new confirmed words)
            if (finalTranscript && finalTranscript.length > streamData.lastTranscriptLength) {
                const newText = finalTranscript.substring(streamData.lastTranscriptLength);
                appendSpeechText(speechStreamDiv, newText, studentName);
                streamData.lastTranscriptLength = finalTranscript.length;
                streamData.lastUpdateTime = currentTime;
                
                console.log(`📝 Added new speech text for ${studentName}: "${newText.trim()}"`);
            }

            // Handle interim transcript (live/temporary text)
            if (interimTranscript !== streamData.lastInterim) {
                updateInterimText(interimOverlay, interimTranscript);
                streamData.lastInterim = interimTranscript;
                streamData.lastUpdateTime = currentTime;
            }

            // Auto-scroll to bottom for continuous viewing
            smoothScrollToBottom(container);
        }

        function appendSpeechText(speechStreamDiv, newText, studentName) {
            if (!newText.trim()) return;

            // Create a new text segment with timestamp
            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'});
            const textSegment = document.createElement('span');
            textSegment.className = 'speech-segment';
            textSegment.style.cssText = `
                display: inline;
                animation: fadeInText 0.5s ease-in;
                color: #1f2937;
                margin-right: 3px;
            `;
            
            // Add fade-in animation if not exists
            if (!document.querySelector('#speech-animations')) {
                const style = document.createElement('style');
                style.id = 'speech-animations';
                style.textContent = `
                    @keyframes fadeInText {
                        from { opacity: 0; transform: translateY(2px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                    .speech-segment:hover {
                        background: rgba(59, 130, 246, 0.1);
                        border-radius: 2px;
                        padding: 1px 2px;
                    }
                `;
                document.head.appendChild(style);
            }

            textSegment.textContent = newText + ' ';
            textSegment.title = `Added at ${timestamp}`;
            
            // Clear placeholder text if present
            if (speechStreamDiv.querySelector('em')) {
                speechStreamDiv.innerHTML = '';
            }
            
            speechStreamDiv.appendChild(textSegment);

            // Limit total length to prevent performance issues
            limitSpeechStreamLength(speechStreamDiv);
        }

        function updateInterimText(interimOverlay, interimText) {
            if (interimText && interimText.trim()) {
                interimOverlay.style.display = 'block';
                interimOverlay.innerHTML = `🎤 <span style="color: #1e40af; font-weight: 500;">${interimText}</span>`;
                
                // Add subtle animation
                interimOverlay.style.animation = 'none';
                requestAnimationFrame(() => {
                    interimOverlay.style.animation = 'pulseInterim 1.5s ease-in-out infinite';
                });
            } else {
                interimOverlay.style.display = 'none';
            }
        }

        function smoothScrollToBottom(container) {
            // Smooth scroll to bottom
            container.scrollTo({
                top: container.scrollHeight,
                behavior: 'smooth'
            });
        }

        function limitSpeechStreamLength(speechStreamDiv) {
            const segments = speechStreamDiv.querySelectorAll('.speech-segment');
            const maxSegments = 200; // Keep last 200 text segments
            
            if (segments.length > maxSegments) {
                // Remove oldest segments but keep some for context
                const segmentsToRemove = segments.length - maxSegments;
                for (let i = 0; i < segmentsToRemove; i++) {
                    segments[i].remove();
                }
                
                // Add ellipsis indicator
                if (!speechStreamDiv.querySelector('.truncation-start')) {
                    const ellipsis = document.createElement('div');
                    ellipsis.className = 'truncation-start';
                    ellipsis.style.cssText = `
                        color: #6b7280;
                        font-style: italic;
                        font-size: 0.75rem;
                        margin-bottom: 4px;
                        padding: 2px 4px;
                        background: rgba(107, 114, 128, 0.1);
                        border-radius: 4px;
                    `;
                    ellipsis.textContent = '... earlier speech content truncated ...';
                    speechStreamDiv.insertBefore(ellipsis, speechStreamDiv.firstChild);
                }
            }
        }

        function clearSpeechStream(studentName) {
            const containerId = `speech-container-${studentName.replace(/\s+/g, '-')}`;
            const container = document.getElementById(containerId);
            
            if (container) {
                const speechStreamDiv = container.querySelector('.speech-stream');
                const interimOverlay = container.querySelector('.interim-overlay');
                
                if (speechStreamDiv) {
                    speechStreamDiv.innerHTML = '<em style="color: #9ca3af; font-size: 0.8rem;">Speech session ended</em>';
                }
                
                if (interimOverlay) {
                    interimOverlay.style.display = 'none';
                }
            }
            
            speechStreamData.delete(studentName);
            console.log(`🧹 Cleared speech stream for ${studentName}`);
        }

        // Speech Event Backup and Reliability Functions
        function backupSpeechEventToStorage(eventType, data) {
            try {
                const backupKey = `speechBackup_${data.sessionId}_${eventType}`;
                const backupData = {
                    eventType,
                    data,
                    timestamp: new Date().toISOString(),
                    backupId: `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                };
                
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                console.log(`💾 Backed up ${eventType} for session ${data.sessionId}`);
                
                // Also backup to session storage as secondary backup
                sessionStorage.setItem(backupKey, JSON.stringify(backupData));
                
            } catch (error) {
                console.warn('⚠️ Failed to backup speech event:', error);
            }
        }

        function verifySpeechEventData(data, expectedType) {
            if (!data) {
                console.warn('⚠️ Speech event data is null/undefined');
                return false;
            }

            // Required fields for all speech events
            const requiredFields = ['sessionId', 'studentName', 'courseId'];
            for (const field of requiredFields) {
                if (!data[field]) {
                    console.warn(`⚠️ Speech event missing required field: ${field}`);
                    return false;
                }
            }

            // Type-specific validation
            switch (expectedType) {
                case 'start':
                    // Start events should have timestamp
                    if (!data.startTime && !data.timestamp) {
                        console.warn('⚠️ Speech start event missing timestamp');
                        return false;
                    }
                    break;
                    
                case 'update':
                    // Update events should have transcript or interim content
                    if (!data.finalTranscript && !data.interimTranscript && !data.latestInterim) {
                        console.warn('⚠️ Speech update event has no transcript content');
                        return false;
                    }
                    break;
                    
                case 'stop':
                    // Stop events should have final transcript
                    if (!data.finalTranscript) {
                        console.warn('⚠️ Speech stop event missing final transcript');
                        return false;
                    }
                    break;
            }

            return true;
        }

        function cleanupSpeechBackups(sessionId) {
            try {
                const keysToRemove = [];
                
                // Find all backup keys for this session
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(`speechBackup_${sessionId}_`)) {
                        keysToRemove.push(key);
                    }
                }
                
                // Remove from both localStorage and sessionStorage
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                
                console.log(`🧹 Cleaned up ${keysToRemove.length} speech backups for session ${sessionId}`);
                
            } catch (error) {
                console.warn('⚠️ Failed to cleanup speech backups:', error);
            }
        }

        function recoverSpeechDataFromBackups(sessionId) {
            try {
                const recoveredEvents = [];
                
                // Search localStorage for backup data
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(`speechBackup_${sessionId}_`)) {
                        try {
                            const backupData = JSON.parse(localStorage.getItem(key));
                            if (backupData && backupData.data) {
                                recoveredEvents.push(backupData);
                            }
                        } catch (parseError) {
                            console.warn(`⚠️ Failed to parse backup data for key ${key}:`, parseError);
                        }
                    }
                }
                
                // Sort by timestamp
                recoveredEvents.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                console.log(`🔄 Recovered ${recoveredEvents.length} speech events for session ${sessionId}`);
                return recoveredEvents;
                
            } catch (error) {
                console.error('❌ Failed to recover speech data from backups:', error);
                return [];
            }
        }

        function validateSpeechDataIntegrity() {
            const now = Date.now();
            let validSessions = 0;
            let corruptedSessions = 0;
            
            studentSpeechData.forEach((speechData, studentName) => {
                try {
                    // Check for required fields
                    if (!speechData.sessionId || !speechData.studentName || !speechData.lastUpdate) {
                        console.warn(`⚠️ Corrupted speech data for ${studentName}:`, speechData);
                        corruptedSessions++;
                        return;
                    }
                    
                    // Check if data is stale (older than 10 minutes)
                    const dataAge = now - new Date(speechData.lastUpdate).getTime();
                    if (dataAge > 600000) { // 10 minutes
                        console.warn(`⚠️ Stale speech data for ${studentName} (${Math.round(dataAge/60000)} minutes old)`);
                    }
                    
                    validSessions++;
                    
                } catch (error) {
                    console.warn(`⚠️ Error validating speech data for ${studentName}:`, error);
                    corruptedSessions++;
                }
            });
            
            console.log(`🔍 Speech data integrity check: ${validSessions} valid, ${corruptedSessions} corrupted sessions`);
            return { valid: validSessions, corrupted: corruptedSessions };
        }

        // Debug functions to test socket connectivity
        function testAdminSocketConnection() {
            console.log('🧪 Testing admin socket connection...');
            console.log('Socket connected:', socket?.connected);
            console.log('Socket ID:', socket?.id);
            console.log('Auth token:', !!authToken);
            
            if (socket && socket.connected) {
                // Test emit to server
                socket.emit('admin-test', { 
                    message: 'Testing admin socket connection', 
                    timestamp: new Date(),
                    socketId: socket.id 
                });
                console.log('✅ Test message sent to server');
                showNotification('Socket connection test sent - check server logs', 'info');
            } else {
                console.log('❌ Socket not connected');
                showNotification('Socket not connected!', 'error');
            }
        }
        window.testAdminSocketConnection = testAdminSocketConnection;

        function testSpeechReception() {
            console.log('🧪 Listening for incoming speech events...');
            const startTime = Date.now();
            let eventCount = 0;
            
            const speechEvents = ['student-speech-start', 'student-speech-update', 'student-speech-stop'];
            
            speechEvents.forEach(eventName => {
                socket.once(eventName, (data) => {
                    eventCount++;
                    console.log(`🎯 Received ${eventName}:`, data);
                    console.log(`Event #${eventCount} received after ${Date.now() - startTime}ms`);
                });
            });
            
            showNotification(`Listening for speech events... Open PersonalCare and use speech`, 'info');
            
            // Stop listening after 30 seconds
            setTimeout(() => {
                console.log(`🏁 Speech test completed. Received ${eventCount} events in 30 seconds.`);
            }, 30000);
        }
        window.testSpeechReception = testSpeechReception;

        function showNotification(message, type = 'info') {
            // Create a simple notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 16px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
                max-width: 300px;
            `;
            
            switch (type) {
                case 'success':
                    notification.style.background = '#10b981';
                    break;
                case 'error':
                    notification.style.background = '#ef4444';
                    break;
                default:
                    notification.style.background = '#3b82f6';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => notification.style.opacity = '1', 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }
    </script>
</body>
</html>
